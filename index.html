<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
  body { background: #f6f7fb; padding: 20px; }
  .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  table { font-size: 15px; }
  #resultTable thead { background-color: #e3f2fd; }
  #resultTable th { color: #000; text-align:center; font-weight:700; padding:10px 8px; border-bottom:2px solid #bbdefb; cursor:pointer; transition: background 0.2s ease; }
  #resultTable th:hover { background-color: #bbdefb; }
  #resultTable td { text-align:center; vertical-align: middle; }
  .table-danger { background-color: #ffeaea !important; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV dari WEB CO → Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-control">
          <option value="">-- Pilih Shift --</option>
          <option value="M">M (lihat: ambil kolom H-1 — perilaku lama)</option>
          <option value="M-1">M-1 (ambil shift M pada Hari H / kolom hari ini)</option>
          <option value="P">P</option>
          <option value="S">S</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-muted">
        Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, 
        Tanggal Diambil, Diambil Oleh, Dibuat Oleh).
      </small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

let sheetData = [], csvData = [], lastResults = [];

// default sort flags
let sortAscNama=true, sortAscLastCO=false, sortAscIndexCO=false, sortAscTotalCO=true;
let sortAscSLA=false, sortAscInProgress=false, sortAscRelasiResolved=false;

document.getElementById("tanggalCek").textContent =
  new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });

function pad(n){ return String(n).padStart(2,'0'); }
function toIsoDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

// helper text normalization & similarity (tetap seperti semula)
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){
  if(!v) return 0;
  const s=v.toString().trim();
  const m1=s.match(/(\d+)\s*d\s*(\d{1,2}):(\d{2}):(\d{2})$/i);
  if(m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
  const m2=s.match(/(\d{1,2}):(\d{2}):(\d{2})$/);
  if(m2) return (+m2[1])*3600 + (+m2[2])*60 + (+m2[3]);
  return 0;
}
function normalizeStatus(s){ if(!s && s!==0) return ""; return String(s).replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }
function isAcceptedStatus(norm){ return norm.includes("resolved")||norm.includes("closed")||norm.includes("in progress")||norm.includes("inprogress")||norm.includes("pending"); }
function levenshtein(a,b){ a=a||""; b=b||""; const al=a.length, bl=b.length; if(!al) return bl; if(!bl) return al; const dp=Array.from({length:al+1},()=>new Array(bl+1).fill(0)); for(let i=0;i<=al;i++) dp[i][0]=i; for(let j=0;j<=bl;j++) dp[0][j]=j; for(let i=1;i<=al;i++) for(let j=1;j<=bl;j++) dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1)); return dp[al][bl]; }
function similarity(a,b){ a=normalizeName(a); b=normalizeName(b); if(!a||!b) return 0; const d=levenshtein(a,b); return 1 - d/Math.max(a.length,b.length); }
function ambilJamDariTanggal(s){ if(!s) return "-"; const m=s.match(/(\d{1,2}):(\d{2})(?::\d{2})?/); return m ? `${m[1].padStart(2,'0')}:${m[2]}` : "-"; }

// === Ambil data dari GSheet (dengan mapping tanggal untuk M / M-1) ===
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const sel = document.getElementById("shiftInput");
  const shiftInputRaw = (sel.value || "").trim().toUpperCase();
  if (!shiftInputRaw) return alert("Pilih shift terlebih dahulu.");
  document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet...";

  try {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const todayIso = toIsoDate(today);
    const yesterdayIso = toIsoDate(yesterday);

    // Build list of fetch jobs (shift + tanggal) according to mapping rules:
    // - If user chooses "M": call GAS with shift=M and tanggal=kemarin (perilaku lama)
    // - If user chooses "M-1": call GAS with shift=M and tanggal=hari ini (ambil kolom hari ini)
    // - If user chooses "P": call GAS for P and P1 dengan tanggal hari ini
    // - Otherwise (S): call GAS with that shift and tanggal hari ini
    const fetchRequests = [];

    if (shiftInputRaw === "P") {
      fetchRequests.push({ shift: "P", tanggal: todayIso });
      fetchRequests.push({ shift: "P1", tanggal: todayIso });
    } else if (shiftInputRaw === "M") {
      // Perilaku lama: M => tarik shift M dari kolom 'kemarin'
      fetchRequests.push({ shift: "M", tanggal: yesterdayIso });
    } else if (shiftInputRaw === "M-1") {
      // Permintaan khususmu: M-1 => tarik shift M dari kolom 'hari ini'
      fetchRequests.push({ shift: "M", tanggal: todayIso });
    } else {
      // S atau kode lain
      fetchRequests.push({ shift: shiftInputRaw, tanggal: todayIso });
    }

    sheetData = [];
    for (const job of fetchRequests) {
      const url = `${GAS_URL}?shift=${encodeURIComponent(job.shift)}&tanggal=${encodeURIComponent(job.tanggal)}`;
      const res = await fetch(url);
      const data = await res.json();
      // jika GAS mengembalikan error objek
      if (data && data.error) {
        // tampilkan di status tapi teruskan (jika ingin hentikan, bisa alert dan return)
        console.warn("GAS error", data.error);
        document.getElementById("statusText").textContent = `⚠ GAS: ${data.error}`;
        continue;
      }
      const karyawanList = (data.karyawan || []).map(k => ({
        nama: (k.nama || "").trim(),
        nik: (k.nik || "").trim(),
        // gunakan label shift dari response jika tersedia (mis: "M H-1"), fallback ke job.shift
        shift: data.shift || job.shift
      }));
      sheetData = sheetData.concat(karyawanList);
    }

    document.getElementById("statusText").textContent =
      sheetData.length ? `✅ Data ditemukan: ${sheetData.length} orang (Shift ${shiftInputRaw})`
                       : "⚠️ Tidak ada data karyawan ditemukan.";
    document.getElementById("generateBtn").disabled = !sheetData.length;

  } catch (err) {
    console.error(err);
    document.getElementById("statusText").textContent = "Gagal memanggil API: " + err.message;
  }
});

// ==== Upload CSV ====
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  Papa.parse(file,{
    header:true,
    delimiter:";",
    skipEmptyLines:true,
    complete:(res)=>{
      const headerMap={};
      (res.meta.fields||[]).forEach(f=>headerMap[normKey(f)]=f);
      const getCol=(row,arr)=>{ for(const c of arr){ const k=headerMap[c]; if(k&&row[k]) return row[k].toString(); } return ""; };
      csvData=res.data.map(r=>{
        const nikRaw=(getCol(r,['nikpengambil','nik'])).replace(/\D/g,'').trim();
        const diambilOleh=getCol(r,['diambiloleh','diambil oleh']);
        const durasiRaw=getCol(r,['durasikomplain','durasi']);
        const waktuSlaRaw=getCol(r,['waktusla','waktu sla']);
        const statusRaw=getCol(r,['statuskomplain','status']);
        const statusSlaRaw=getCol(r,['statussla','status sla']);
        const tglDiambilRaw=getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
        const slaNum=parseFloat((waktuSlaRaw||"").replace(",","."))||0;
        return{
          nik:nikRaw,
          diambilOleh,
          durasiRaw,
          durasiDetik:durasiKeDetik(durasiRaw),
          waktuSlaDetik:slaNum*3600,
          status:statusRaw,
          statusNorm:normalizeStatus(statusRaw),
          statusSLA:statusSlaRaw,
          tanggalDiambil:tglDiambilRaw
        };
      });
      document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

// ==== Perhitungan & rendering (sama seperti sebelumnya) ====
function computeC(r){ return r.waktuSlaDetik>0 ? r.durasiDetik/r.waktuSlaDetik : 0; }

function rataRata_byName(nama,thr=0.85){
  const matches=[];
  for(const r of csvData){
    if(!isAcceptedStatus(r.statusNorm))continue;
    if(similarity(nama,r.diambilOleh)>=thr)matches.push(r);
  }
  if(!matches.length)
    return { avg:null, count:0, lastTime:"-", slaCount:0, inProgressCount:0, relasiResolved:0 };

  const sum = matches.reduce((a,b)=>a+computeC(b),0);
  const latest = matches.map(r=>r.tanggalDiambil).filter(Boolean).sort().pop();
  const slaCount = matches.filter(r=>r.statusSLA && r.statusSLA.toLowerCase().includes("lewat")).length;
  const inProgressCount = matches.filter(r=>r.statusNorm.includes("inprogress") || r.statusNorm.includes("in progress")).length;
  const relasiResolved = matches.filter(r=>r.statusNorm.includes("pending")).length;

  return { avg:sum/matches.length, count:matches.length, lastTime:ambilJamDariTanggal(latest),
           slaCount, inProgressCount, relasiResolved };
}

function renderTable(results){
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  results.forEach((item,index)=>{
    const {k,res}=item;
    const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";
    const highlightClass = res.slaCount > 0 ? "table-danger" : "";
    const tr=document.createElement("tr");
    tr.className = highlightClass;
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${k.nama}</td>
      <td>${k.shift}</td>
      <td>${res.lastTime}</td>
      <td>${avg}</td>
      <td>${res.count||0}</td>
      <td>${res.slaCount||0}</td>
      <td>${res.inProgressCount||0}</td>
      <td>${res.relasiResolved||0}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!sheetData.length) return alert("Ambil nama dari GSheet dulu.");
  if(!csvData.length) return alert("Upload file CSV dulu.");
  const results=sheetData.map(k=>({k,res:rataRata_byName(k.nama)}));
  lastResults=results;
  renderTable(results);
  document.getElementById("statusText").textContent="✅ Perhitungan selesai.";
});

// ==== Sort handlers ====
function sortColumn(key){
  if(!lastResults.length) return alert("Belum ada data tabel.");
  let asc, valFunc;
  switch(key){
    case "Nama": asc = sortAscNama; valFunc = r => (r.k.nama || "").toLowerCase(); sortAscNama = !sortAscNama; break;
    case "LastCO": asc = sortAscLastCO; valFunc = r => r.res.lastTime==="-" ? 0 : parseInt(r.res.lastTime.replace(":","")); sortAscLastCO = !sortAscLastCO; break;
    case "IndexCO": asc = sortAscIndexCO; valFunc = r => r.res.avg!==null ? r.res.avg : 0; sortAscIndexCO = !sortAscIndexCO; break;
    case "TotalCO": asc = sortAscTotalCO; valFunc = r => r.res.count||0; sortAscTotalCO = !sortAscTotalCO; break;
    case "SLA": asc = sortAscSLA; valFunc = r => r.res.slaCount||0; sortAscSLA = !sortAscSLA; break;
    case "InProgress": asc = sortAscInProgress; valFunc = r => r.res.inProgressCount||0; sortAscInProgress = !sortAscInProgress; break;
    case "RelasiResolved": asc = sortAscRelasiResolved; valFunc = r => r.res.relasiResolved||0; sortAscRelasiResolved = !sortAscRelasiResolved; break;
    default: return;
  }

  if(key === "Nama"){
    lastResults.sort((a,b)=> asc ? valFunc(a).localeCompare(valFunc(b)) : valFunc(b).localeCompare(valFunc(a)));
  } else {
    lastResults.sort((a,b)=> asc ? (valFunc(a)-valFunc(b)) : (valFunc(b)-valFunc(a)));
  }

  renderTable(lastResults);
  document.getElementById(`sort${key}`).textContent = `${key} ${asc?"↑":"↓"}`;
}

["Nama","LastCO","IndexCO","TotalCO","SLA","InProgress","RelasiResolved"].forEach(k=>{
  const el=document.getElementById(`sort${k}`);
  if(el) el.addEventListener("click",()=>sortColumn(k));
});

// ==== Download JPG ====
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
