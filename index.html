<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { padding:20px; background:#f8f9fa; }
    table { background:white; }
    th { cursor:pointer; user-select:none; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h3 class="mb-3 text-center">Laporan Index Shift (Index terakhir CO)</h3>
    <div class="mb-3 d-flex flex-wrap gap-2">
      <button id="ambilDataBtn" class="btn btn-success">Ambil nama dari Gsheet</button>
      <input type="file" id="csvFile" accept=".csv" class="form-control w-auto"/>
      <button id="generateBtn" class="btn btn-primary">Generate Tabel</button>
      <button id="downloadBtn" class="btn btn-secondary">Download JPG</button>
    </div>
    <div class="table-responsive">
      <table id="hasilTable" class="table table-bordered table-sm align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan ⬍</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO ⬍</th>
            <th id="sortIndexCO">IndexCO ⬍</th>
            <th id="sortTotalCO">TotalCO ⬍</th>
            <th id="sortSLA">SLA ⬍</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
let dataNama = [];
let csvData = [];
let lastResults = [];

// variabel sort global
let sortAscNama = true;
let sortAscIndex = false;
let sortAscTotal = true;
let sortAscLastCO = false;
let sortAscSLA = false;

// ------------------------
// Ambil data dari Google Sheet
// ------------------------
document.getElementById("ambilDataBtn").addEventListener("click", async ()=>{
  const url = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec?action=getNama";
  try {
    const res = await fetch(url);
    const json = await res.json();
    if(json && json.data) dataNama = json.data;
  } catch(e) {
    console.error("Gagal ambil data GSheet:", e);
  }
});

// ------------------------
// Upload CSV
// ------------------------
document.getElementById("csvFile").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const rows = evt.target.result.split(/\r?\n/).map(r=>r.split(","));
    csvData = rows.filter(r => r[0] && r[1]);
  };
  reader.readAsText(file);
});

// ------------------------
// Generate tabel
// ------------------------
document.getElementById("generateBtn").addEventListener("click", ()=>{
  if(!dataNama.length && !csvData.length) return;
  lastResults = [];

  dataNama.forEach((nama,i)=>{
    const match = csvData.find(r => (r[0]||"").trim().toLowerCase() === nama.nama.toLowerCase());
    const res = {
      nama: nama.nama,
      shift: nama.shift || "-",
      res: match ? {
        lastCO: match[1],
        indexCO: parseFloat(match[2]) || 0,
        totalCO: parseFloat(match[3]) || 0,
        slaCount: parseInt(match[4]) || 0
      } : {lastCO:"-", indexCO:0, totalCO:0, slaCount:0}
    };
    lastResults.push(res);
  });

  // default sort by IndexCO descending
  lastResults.sort((a,b)=>b.res.indexCO - a.res.indexCO);
  renderTable(lastResults);
});

// ------------------------
// Render tabel
// ------------------------
function renderTable(data){
  const tbody = document.querySelector("#hasilTable tbody");
  tbody.innerHTML = "";
  data.forEach((d,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${d.nama}</td>
      <td>${d.shift}</td>
      <td>${d.res.lastCO}</td>
      <td>${d.res.indexCO}</td>
      <td>${d.res.totalCO}</td>
      <td>${d.res.slaCount}</td>`;
    tbody.appendChild(tr);
  });
}

// ------------------------
// Download tabel ke JPG
// ------------------------
document.getElementById("downloadBtn").addEventListener("click", async ()=>{
  const el = document.querySelector("#hasilTable");
  const canvas = await html2canvas(el, {scale:2});
  const link = document.createElement("a");
  link.download = "laporan-index-shift.jpg";
  link.href = canvas.toDataURL("image/jpeg");
  link.click();
});

// ------------------------
// Tombol Sort
// ------------------------
document.getElementById("sortNama").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortAscNama = !sortAscNama;
  lastResults.sort((a,b)=> sortAscNama ? a.nama.localeCompare(b.nama) : b.nama.localeCompare(a.nama));
  renderTable(lastResults);
  document.getElementById("sortNama").textContent = `Nama Karyawan ${sortAscNama ? "↑" : "↓"}`;
});

document.getElementById("sortLastCO").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortAscLastCO = !sortAscLastCO;
  lastResults.sort((a,b)=>{
    const valA = a.res.lastCO || "";
    const valB = b.res.lastCO || "";
    return sortAscLastCO ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });
  renderTable(lastResults);
  document.getElementById("sortLastCO").textContent = `LastCO ${sortAscLastCO ? "↑" : "↓"}`;
});

document.getElementById("sortIndexCO").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortAscIndex = !sortAscIndex;
  lastResults.sort((a,b)=> sortAscIndex ? a.res.indexCO - b.res.indexCO : b.res.indexCO - a.res.indexCO);
  renderTable(lastResults);
  document.getElementById("sortIndexCO").textContent = `IndexCO ${sortAscIndex ? "↑" : "↓"}`;
});

document.getElementById("sortTotalCO").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortAscTotal = !sortAscTotal;
  lastResults.sort((a,b)=> sortAscTotal ? a.res.totalCO - b.res.totalCO : b.res.totalCO - a.res.totalCO);
  renderTable(lastResults);
  document.getElementById("sortTotalCO").textContent = `TotalCO ${sortAscTotal ? "↑" : "↓"}`;
});

document.getElementById("sortSLA").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortAscSLA = !sortAscSLA;
  lastResults.sort((a,b)=> sortAscSLA ? a.res.slaCount - b.res.slaCount : b.res.slaCount - a.res.slaCount);
  renderTable(lastResults);
  document.getElementById("sortSLA").textContent = `SLA ${sortAscSLA ? "↑" : "↓"}`;
});
</script>
</body>
</html>
