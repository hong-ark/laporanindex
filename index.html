<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hitung Index Komplain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1000px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { font-size: 15px; }
    th { background: #f2f2f2; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Perhitungan Index Komplain</b></h4>
    <p>Upload file CSV dari laporan komplain (pemisah semicolon <code>;</code>), lalu klik <b>Hitung Index</b>.</p>

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="processBtn" class="btn btn-success mb-3">Hitung Index</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th>NIK Pengambil</th>
            <th>Jumlah Komplain</th>
            <th>Rata-rata Index (C)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let csvData = [];

    document.getElementById("csvFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        delimiter: ";",  // <-- PENTING: pakai semicolon
        skipEmptyLines: true,
        complete: (results) => {
          csvData = results.data;
          alert("Kolom terdeteksi:\n" + Object.keys(csvData[0]).join("\n"));
          document.getElementById("statusText").textContent = `File terbaca: ${csvData.length} baris`;
        },
      });
    });

    document.getElementById("processBtn").addEventListener("click", () => {
      if (!csvData.length) return alert("Upload file CSV terlebih dahulu!");

      // Filter status RESOLVED & IN PROGRESS
      const filtered = csvData.filter(r => {
        const status = (r["Status Komplain"] || "").toLowerCase();
        return status.includes("resolved") || status.includes("in progress");
      });

      const hasil = filtered.map(r => {
        const waktuSLA = parseFloat(r["Waktu SLA"] || 0);
        const durasi = r["Durasi Komplain"] || "00:00:00";
        const [h, m, s] = durasi.split(":").map(Number);
        const A = waktuSLA * 3600;
        const B = (h * 3600) + (m * 60) + s;
        const C = A > 0 ? B / A : 0;
        return { nik: r["NIK Pengambil"], nilai: C };
      });

      const perNIK = {};
      hasil.forEach(({ nik, nilai }) => {
        if (!nik) return;
        if (!perNIK[nik]) perNIK[nik] = [];
        perNIK[nik].push(nilai);
      });

      const avgResult = Object.entries(perNIK).map(([nik, arr]) => ({
        nik,
        count: arr.length,
        avg: (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(4)
      }));

      // Tampilkan hasil
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      avgResult.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.nik}</td>
          <td>${r.count}</td>
          <td>${r.avg}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("statusText").textContent =
        `Selesai dihitung: ${avgResult.length} NIK ditemukan (${filtered.length} baris valid).`;
    });
  </script>
</body>
</html>
