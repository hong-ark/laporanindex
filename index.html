<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Index Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8fafc; padding: 40px; }
    .container { max-width: 900px; background: white; padding: 25px 40px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h4 { font-weight: 600; }
    .text-small { font-size: 0.9rem; color: #555; }
    .error-msg { color: #c00; font-weight: 500; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h4 class="mb-3">Laporan Index Shift</h4>
    <p class="text-small">Pilih shift, ambil nama-nama dari Google Sheet, upload CSV, lalu generate JPG.</p>

    <div class="mb-3">
      <label class="form-label">Shift yang mau dibuat laporan?</label>
      <div class="d-flex gap-2">
        <input type="text" id="shiftInput" class="form-control" style="max-width:120px" placeholder="M / S / P" />
        <button id="ambilBtn" class="btn btn-primary">Ambil Nama dari Google Sheet</button>
        <span class="mt-2 ms-2" id="tanggalSpan"></span>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload file CSV (header: No | Personil | TotalCO | LastCO | Index)</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-small">CSV harus memiliki header ‚ÄúPersonil‚Äù atau ‚ÄúPerson‚Äù sebagai kolom nama.</small>
    </div>

    <div class="d-flex gap-2">
      <button id="generateBtn" class="btn btn-success">Generate Tabel</button>
      <span id="statusText" class="text-danger ms-2"></span>
    </div>

    <div id="preview" class="mt-4"></div>
  </div>

  <script>
    // üîó URL GAS kamu
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

    let namaShift = [];
    let tanggalCek = "";

    document.getElementById("ambilBtn").addEventListener("click", async () => {
      const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
      const status = document.getElementById("statusText");
      const tanggalSpan = document.getElementById("tanggalSpan");
      status.textContent = "";
      tanggalSpan.textContent = "";

      if (!shift) {
        status.textContent = "Isi dulu kode shift (M/S/P)";
        return;
      }

      try {
        const res = await fetch(`${GAS_URL}?shift=${shift}`);
        if (!res.ok) throw new Error("Gagal memanggil API");

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        namaShift = data.karyawan;
        tanggalCek = new Date(data.tanggal).toLocaleDateString("id-ID");
        tanggalSpan.textContent = `Tanggal yang dicek: ${tanggalCek}`;
        status.textContent = `Data ditemukan: ${data.total} orang.`;
        status.classList.remove("text-danger");
        status.classList.add("text-success");
      } catch (err) {
        status.textContent = `Gagal memanggil API: ${err.message}`;
        status.classList.add("text-danger");
      }
    });

    // Proses file CSV (sementara hanya preview)
    document.getElementById("generateBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("csvFile");
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      if (!fileInput.files.length) {
        alert("Pilih file CSV terlebih dahulu!");
        return;
      }

      const file = fileInput.files[0];
      const text = await file.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      const dataRows = rows.slice(1);

      let html = `<table class="table table-bordered table-sm mt-3">
        <thead class="table-light"><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
        <tbody>
        ${dataRows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("")}
        </tbody>
      </table>`;

      preview.innerHTML = html;
    });
  </script>
</body>
</html>
