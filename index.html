<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Index CO per Personil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f5f6fa; }
    .container { margin-top: 40px; }
    table { font-size: 0.9rem; }
    th { background-color: #003366; color: white; text-align: center; }
    td { vertical-align: middle; text-align: center; }
    .card { box-shadow: 0 3px 8px rgba(0,0,0,0.1); border-radius: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h4 class="mb-3 text-center">Laporan Index CO per Personil</h4>
      <div class="mb-3">
        <label class="form-label fw-bold">Upload file CSV (delimiter ;)</label>
        <input type="file" id="csvFile" class="form-control" accept=".csv" />
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">URL Google Apps Script (Shift Aktif)</label>
        <input type="text" id="gasUrl" class="form-control" placeholder="Tempel URL Web Apps kamu di sini" />
      </div>
      <button id="prosesBtn" class="btn btn-primary w-100">Proses</button>
      <hr>
      <div id="shiftInfo" class="alert alert-info d-none"></div>
      <div id="result"></div>
    </div>
  </div>

  <script>
    let csvData = [];

    // Fungsi parse CSV dengan delimiter ";"
    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      const headers = rows.shift().split(";");
      return rows.map(row => {
        const values = row.split(";");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || "");
        return obj;
      });
    }

    // Ambil data shift aktif dari GAS
    async function getShiftData(gasUrl) {
      try {
        const res = await fetch(gasUrl);
        return await res.json();
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    // Hitung IndexCO dan TotalCO berbasis NIK (bukan nama)
    function hitungIndexCO(nik) {
      if (!nik) return { avg: null, count: 0, lastTime: "-" };

      const filtered = csvData.filter(r =>
        r["NIK"] === nik &&
        ["RESOLVED", "IN PROGRESS", "CLOSED"].includes((r["Status Komplain"] || "").toUpperCase())
      );

      if (!filtered.length) return { avg: null, count: 0, lastTime: "-" };

      // Hitung total C (TotalCO)
      const totalCO = filtered.length;

      // Hitung IndexCO
      const totalNilai = filtered.reduce((acc, r) => acc + (parseFloat(r["C"]) || 0), 0);
      const avg = totalNilai / totalCO;

      // Ambil jam terakhir dari kolom "Tanggal Selesai"
      const lastRow = filtered.reduce((a, b) => {
        const da = new Date(a["Tanggal Selesai"]);
        const db = new Date(b["Tanggal Selesai"]);
        return da > db ? a : b;
      });
      const tanggal = new Date(lastRow["Tanggal Selesai"]);
      const jam = isNaN(tanggal) ? "-" : tanggal.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      return { avg, count: totalCO, lastTime: jam };
    }

    // Proses utama
    document.getElementById("prosesBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("csvFile");
      const gasUrl = document.getElementById("gasUrl").value.trim();
      const resultDiv = document.getElementById("result");
      const shiftInfo = document.getElementById("shiftInfo");

      if (!fileInput.files.length) return alert("Pilih file CSV terlebih dahulu!");
      if (!gasUrl) return alert("Masukkan URL Google Apps Script!");

      const text = await fileInput.files[0].text();
      csvData = parseCSV(text);

      const shiftData = await getShiftData(gasUrl);
      if (!shiftData || !shiftData.length) {
        shiftInfo.classList.remove("d-none");
        shiftInfo.textContent = "Shift aktif tidak ditemukan atau URL salah.";
        return;
      }

      const namaShift = shiftData[0].shift || "-";
      shiftInfo.classList.remove("d-none");
      shiftInfo.textContent = `Shift Aktif: ${namaShift}`;

      let html = `
        <table class="table table-bordered table-striped mt-3">
          <thead>
            <tr>
              <th>Nama</th>
              <th>IndexCO</th>
              <th>TotalCO</th>
              <th>Terakhir CO Diambil</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const k of shiftData) {
        const { avg, count, lastTime } = hitungIndexCO(k.nik);
        html += `
          <tr>
            <td>${k.nama || "-"}</td>
            <td>${avg ? avg.toFixed(4) : "-"}</td>
            <td>${count ? count + " Co diambil" : "0 Co diambil"}</td>
            <td>${lastTime}</td>
          </tr>
        `;
      }

      html += "</tbody></table>";
      resultDiv.innerHTML = html;
    });
  </script>
</body>
</html>
