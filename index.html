<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Laporan Index Shift (Index terakhir CO)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        body { background: #f6f7fb; padding: 20px; }
        .container {
            max-width: 1100px; background: white; border-radius: 10px;
            padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        table { font-size: 15px; }
        #resultTable thead { background-color: #e3f2fd; }
        #resultTable th {
            color:#000;text-align:center;font-weight:700;
            padding:10px 8px;border-bottom:2px solid #bbdefb;
            cursor:pointer;transition:background 0.2s ease;
        }
        #resultTable th:hover { background-color:#bbdefb; }
        #resultTable td { text-align:center;vertical-align:middle; }
        .bg-danger-subtle,.table-danger { background-color:#ffeaea!important; }
        /* Style untuk modal (History) */
        .modal-body-scrollable { max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h4><b>Laporan Index Shift</b></h4>
        <p>Input shift → Ambil nama dari GSheet → Upload CSV dari WEB CO → Generate Tabel.</p>

        <div class="mb-3 row">
            <div class="col-md-2">
                <label class="form-label">Shift</label>
                <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label><br />
                <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
            </div>
            <div class="col-md-6 text-end">
                <label class="form-label">Tanggal yang dicek:</label>
                <p id="tanggalCek"></p>
            </div>
        </div>

        <hr/>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="w-75">
                <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
                <input type="file" id="csvFile" class="form-control" accept=".csv"/>
                <small class="text-muted">
                    Pastikan CSV punya header yang lengkap.
                </small>
            </div>
            <div class="ms-4">
                <label class="form-label">&nbsp;</label><br />
                <button id="historyBtn" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#historyModal">
                    View History
                </button>
            </div>
        </div>


        <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
        <span id="statusText" class="ms-2 text-muted"></span>

        <div id="resultArea" class="mt-4">
            <table id="resultTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>No</th>
                        <th id="sortNama">Nama Karyawan</th>
                        <th>Shift</th>
                        <th id="sortLastCO">LastCO</th>
                        <th id="sortIndexCO">IndexCO</th>
                        <th id="sortTotalCO">TotalCO</th>
                        <th id="sortSLA">SLA</th>
                        <th id="sortInProgress">InProgress</th>
                        <th id="sortRelasiResolved">RelasiResolved</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="text-end mt-3">
            <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
        </div>
    </div>
    
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="historyModalLabel">History Generate (10 Terakhir)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="modal-body-scrollable">
                <p id="historyStatus">Memuat...</p>
                <table class="table table-sm table-striped" id="historyTable">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Shift</th>
                            <th>File CSV</th>
                            <th>Link Gambar</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>

<script>
// ====================================================================
// KONFIGURASI URL API ANDA
// SHEET_URL: API Jadwal (Menggunakan fetch().json() - Harap pastikan ini ContentService)
// LOG_URL: API Log & Gambar (Menggunakan JSONP untuk History, dan mode no-cors untuk POST log)
// ====================================================================
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWdDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec"; 
const LOG_URL   = "https://script.google.com/macros/s/AKfycbwFsyoZt20LU_OSEQ-D4FQ6XwLXqARtOz24ZItWKGE1XQvbX9BGJ0iZyFD1xr8wbGVJ_w/exec";
// ====================================================================

let sheetData=[],csvData=[],lastResults=[];

document.getElementById("tanggalCek").textContent = 
    new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});

// Status sort default
let sortAscNama = true;
let sortAscLastCO = false;
let sortAscIndexCO = false;
let sortAscTotalCO = true;
let sortAscSLA = false;
let sortAscInProgress = false;
let sortAscRelasiResolved = false;

// --------------------------------------------------------------------------
// === FUNGSI View History (JSONP/Script Loader - Menggunakan LOG_URL) ===
// --------------------------------------------------------------------------

// 1. Definisikan fungsi CALLBACK yang akan dipanggil oleh GAS LOG
window.historyCallback = function(data) {
    const historyBody = document.querySelector("#historyTable tbody");
    const historyStatus = document.getElementById("historyStatus");
    historyBody.innerHTML = '';
    
    // Hapus script tag setelah selesai
    const oldScript = document.getElementById('historyScript');
    if (oldScript) oldScript.remove();

    if (data.success && data.logs && data.logs.length > 0) {
        historyStatus.textContent = `Ditemukan ${data.logs.length} log terakhir.`;
        
        data.logs.forEach(log => {
            const row = historyBody.insertRow();
            const d = new Date(log.timestamp); 
            
            row.insertCell().textContent = d.toLocaleString('id-ID', {
                hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short'
            });
            row.insertCell().textContent = log.shift;
            row.insertCell().textContent = log.csvName;
            
            const linkCell = row.insertCell();
            const a = document.createElement('a');
            a.href = log.fileLink || '#';
            a.target = '_blank';
            a.textContent = 'Lihat Gambar';
            linkCell.appendChild(a);
        });
    } else {
        historyStatus.textContent = data.message || "Tidak ada log yang ditemukan.";
    }
}

// 2. Fungsi yang MEMICU pemanggilan script dinamis
function viewHistory() {
    const historyStatus = document.getElementById("historyStatus");
    historyStatus.textContent = 'Memuat log dari Google Sheet menggunakan skema Script Loader...';

    const existingScript = document.getElementById('historyScript');
    if (existingScript) existingScript.remove();

    try {
        const urlWithCallback = LOG_URL + "?callback=historyCallback"; 
        const script = document.createElement('script');
        script.src = urlWithCallback;
        script.id = 'historyScript';
        document.body.appendChild(script);

        setTimeout(() => {
            if (document.getElementById('historyScript')) {
                historyStatus.textContent = '❌ Gagal memuat history: Timeout atau masalah CORS/JSONP. Pastikan GAS Log sudah di-deploy ulang.';
                document.getElementById('historyScript').remove();
            }
        }, 8000); 

    } catch (err) {
        historyStatus.textContent = `❌ Gagal memuat history: ${err.message}.`;
        console.error("Error History:", err);
    }
}
document.getElementById("historyBtn").addEventListener("click", viewHistory);


// --------------------------------------------------------------------------
// === Ambil data GSheet Jadwal (Menggunakan fetch().json() - Terbukti bekerja) ===
// --------------------------------------------------------------------------
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shiftInput) return alert("Masukkan shift (M, P, atau S)");
  document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet Jadwal...";

  try {
    let shifts = [shiftInput];
    if (shiftInput === "P") shifts = ["P", "P1"];

    sheetData = [];
    for (const s of shifts) {
      const res = await fetch(`${SHEET_URL}?shift=${s}`);
      // Menggunakan .json() karena API Jadwal Anda terbukti bekerja dengan cara ini
      const data = await res.json(); 
      
      const karyawanList = (data.karyawan || []).map(k => ({
        nama: (k.nama || "").trim(),
        nik: (k.nik || "").trim(),
        shift: s
      }));
      sheetData = sheetData.concat(karyawanList);
    }

    document.getElementById("statusText").textContent =
      sheetData.length ? `✅ Data ditemukan: ${sheetData.length} orang (Shift ${shifts.join(" / ")})`
                       : "⚠️ Tidak ada data karyawan ditemukan.";
    document.getElementById("generateBtn").disabled = !sheetData.length;

  } catch (err) {
    document.getElementById("statusText").textContent = `❌ Gagal memanggil API Jadwal: ${err.message}. (Cek koneksi internet atau CORS pada GAS Jadwal).`;
    console.error("Error API Jadwal:", err);
    document.getElementById("generateBtn").disabled = true;
  }
});
// --------------------------------------------------------------------------


// === Simpan Log ke GAS (Mode No-CORS - Menggunakan LOG_URL) ===
async function simpanLogCO(shift, csvName, jpegBlob) {
    try {
        document.getElementById("statusText").textContent = "Mengambil tangkapan layar...";

        const base64Data = await new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onloadend = () => resolve(r.result);
            r.onerror = reject;
            r.readAsDataURL(jpegBlob);
        });

        document.getElementById("statusText").textContent = "Mengirim log dan gambar ke Google Drive (Mode No-CORS)...";
        const payload = { shift, csvName, jpegBase64: base64Data };
        
        await fetch(LOG_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            mode: "no-cors" 
        });

        document.getElementById("statusText").innerHTML = `✅ Log berhasil dikirim ke Google Drive/Sheet. <a href="#" data-bs-toggle="modal" data-bs-target="#historyModal">Cek di History.</a>`;

    } catch (err) {
        document.getElementById("statusText").textContent = "❌ Gagal kirim log ke GAS: " + err.message;
        console.error("Kesalahan pengiriman log:", err);
    }
}


// === Semua Fungsi Bantuan Lainnya (Disederhanakan sedikit) ===
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){
  if (!v) return 0;
  const s = v.toString().trim();
  const m1 = s.match(/(\d+)\s*d\s*(\d{1,2}):(\d{2}):(\d{2})$/i);
  if (m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
  const m2 = s.match(/(\d{1,2}):(\d{2}):(\d{2})$/);
  return m2 ? (+m2[1])*3600 + (+m2[2])*60 + (+m2[3]) : 0;
}
function normalizeStatus(s){
  if (!s && s !== 0) return "";
  return String(s).replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
}
function isAcceptedStatus(norm){ 
  return norm.includes("resolved") || norm.includes("closed") ||
         norm.includes("in progress") || norm.includes("inprogress") ||
         norm.includes("pending"); 
}
function levenshtein(a,b){
  a=a||""; b=b||"";
  const al=a.length, bl=b.length;
  if(!al)return bl; if(!bl)return al;
  const dp=Array.from({length:al+1},()=>new Array(bl+1).fill(0));
  for(let i=0;i<=al;i++)dp[i][0]=i;
  for(let j=0;j<=bl;j++)dp[0][j]=j;
  for(let i=1;i<=al;i++)
    for(let j=1;j<=bl;j++)
      dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1));
  return dp[al][bl];
}
function similarity(a,b){
  a=normalizeName(a); b=normalizeName(b);
  if(!a||!b)return 0;
  const d=levenshtein(a,b);
  return 1 - d/Math.max(a.length,b.length);
}
function ambilJamDariTanggal(s){
  if(!s)return "-";
  const m=s.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
  return m ? `${m[1].padStart(2,'0')}:${m[2]}` : "-";
}


// === Upload CSV (Disesuaikan dengan header CSV lengkap) ===
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  Papa.parse(file,{
    header:true,
    delimiter:";",
    skipEmptyLines:true,
    complete:(res)=>{
      const headerMap={};
      (res.meta.fields||[]).forEach(f=>headerMap[normKey(f)]=f);
      const getCol=(row,arr)=>{ for(const c of arr){ const k=headerMap[c]; if(k&&row[k]) return row[k].toString(); } return ""; };
      csvData=res.data.map(r=>{
        // Pemetaan header yang lebih kuat
        const nikRaw=(getCol(r,['nikpengambil','nik'])).replace(/\D/g,'').trim();
        const diambilOleh=getCol(r,['diambiloleh','diambil oleh']);
        const durasiRaw=getCol(r,['durasikomplain','durasi']);
        const waktuSlaRaw=getCol(r,['waktusla','waktu sla']);
        const statusRaw=getCol(r,['statuskomplain','status']);
        const statusSlaRaw=getCol(r,['statussla','status sla']);
        const tglDiambilRaw=getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
        const slaNum=parseFloat((waktuSlaRaw||"0").replace(",","."))||0;
        return{
          nik:nikRaw,
          diambilOleh,
          durasiRaw,
          durasiDetik:durasiKeDetik(durasiRaw),
          waktuSlaDetik:slaNum*3600,
          status:statusRaw,
          statusNorm:normalizeStatus(statusRaw),
          statusSLA:statusSlaRaw,
          tanggalDiambil:tglDiambilRaw
        };
      });
      document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});


// === Hitung rata-rata per nama (TIDAK BERUBAH) ===
function computeC(r){ return r.waktuSlaDetik>0 ? r.durasiDetik/r.waktuSlaDetik : 0; }

function rataRata_byName(nama,thr=0.85){
  const matches=[];
  for(const r of csvData){
    if(!isAcceptedStatus(r.statusNorm))continue;
    // Menggunakan r.diambilOleh karena sudah diolah di bagian Upload CSV
    if(similarity(nama,r.diambilOleh)>=thr)matches.push(r); 
  }
  if(!matches.length)
    return { avg:null, count:0, lastTime:"-", slaCount:0, inProgressCount:0, relasiResolved:0 };

  const sum = matches.reduce((a,b)=>a+computeC(b),0);
  const latest = matches.map(r=>r.tanggalDiambil).filter(Boolean).sort().pop();
  const slaCount = matches.filter(r=>r.statusSLA && r.statusSLA.toLowerCase().includes("lewat")).length;
  const inProgressCount = matches.filter(r=>r.statusNorm.includes("inprogress") || r.statusNorm.includes("in progress")).length;
  const relasiResolved = matches.filter(r=>r.statusNorm.includes("pending")).length;

  return { avg:sum/matches.length, count:matches.length, lastTime:ambilJamDariTanggal(latest),
           slaCount, inProgressCount, relasiResolved };
}

// === Render tabel (TIDAK BERUBAH) ===
function renderTable(results){
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  results.forEach((item,index)=>{
    const {k,res}=item;
    const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";

    const highlightClass = res.slaCount > 0 ? "table-danger" : "";
    const tr=document.createElement("tr");
    tr.className = highlightClass;
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${k.nama}</td>
      <td>${k.shift}</td>
      <td>${res.lastTime}</td>
      <td>${avg}</td>
      <td>${res.count||0}</td>
      <td>${res.slaCount||0}</td>
      <td>${res.inProgressCount||0}</td>
      <td>${res.relasiResolved||0}</td>`;
    tbody.appendChild(tr);
  });
}


// === Hitung + tampil + kirim log (TIDAK BERUBAH) ===
document.getElementById("generateBtn").addEventListener("click",async()=>{
    if(!sheetData.length)return alert("Ambil nama dari GSheet dulu.");
    if(!csvData.length)return alert("Upload file CSV dulu.");
    const results=sheetData.map(k=>({k,res:rataRata_byName(k.nama)}));
    lastResults=results;renderTable(results);
    document.getElementById("statusText").textContent="✅ Perhitungan selesai. Mengambil tangkapan layar untuk log...";

    const shift=document.getElementById("shiftInput").value.trim();
    const csvName=document.getElementById("csvFile").files[0]?.name||"tanpa_nama.csv";
    const area=document.querySelector("#resultArea");
    
    const canvas=await html2canvas(area,{scale:2});
    canvas.toBlob(blob=>{if(blob)simpanLogCO(shift,csvName,blob);},"image/jpeg",0.9);
});


// ==== Sort (TIDAK BERUBAH) ====
function sortColumn(key){
  if(!lastResults.length) return alert("Belum ada data tabel.");
  let asc, valFunc;
  switch(key){
    case "Nama": asc = sortAscNama; valFunc = r => (r.k.nama || "").toLowerCase(); sortAscNama = !sortAscNama; break;
    case "LastCO": asc = sortAscLastCO; valFunc = r => r.res.lastTime==="-" ? 0 : parseInt(r.res.lastTime.replace(":","")); sortAscLastCO = !sortAscLastCO; break;
    case "IndexCO": asc = sortAscIndexCO; valFunc = r => r.res.avg!==null ? r.res.avg : 0; sortAscIndexCO = !sortAscIndexCO; break;
    case "TotalCO": asc = sortAscTotalCO; valFunc = r => r.res.count||0; sortAscTotalCO = !sortAscTotalCO; break;
    case "SLA": asc = sortAscSLA; valFunc = r => r.res.slaCount||0; sortAscSLA = !sortAscSLA; break;
    case "InProgress": asc = sortAscInProgress; valFunc = r => r.res.inProgressCount||0; sortAscInProgress = !sortAscInProgress; break;
    case "RelasiResolved": asc = sortAscRelasiResolved; valFunc = r => r.res.relasiResolved||0; sortAscRelasiResolved = !sortAscRelasiResolved; break;
    default: return;
  }

  if(key === "Nama"){
    lastResults.sort((a,b)=> asc 
      ? valFunc(a).localeCompare(valFunc(b))
      : valFunc(b).localeCompare(valFunc(a))
    );
  } else {
    lastResults.sort((a,b)=> asc ? (valFunc(a)-valFunc(b)) : (valFunc(b)-valFunc(a)));
  }

  renderTable(lastResults);
  // Tambahkan panah indikator sort
  ["Nama","LastCO","IndexCO","TotalCO","SLA","InProgress","RelasiResolved"].forEach(k=>{
    const el=document.getElementById(`sort${k}`);
    if(el) el.textContent = k + (k === key ? (asc?" ↑":" ↓") : "");
  });
}

// Inisialisasi Sorting
["Nama","LastCO","IndexCO","TotalCO","SLA","InProgress","RelasiResolved"].forEach(k=>{
  const el=document.getElementById(`sort${k}`);
  if(el) el.addEventListener("click",()=>sortColumn(k));
});


// ==== Download JPG manual (TIDAK BERUBAH) ====
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
