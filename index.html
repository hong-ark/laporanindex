<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container {
      max-width: 1100px; background: white; border-radius: 10px;
      padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    table { font-size: 15px; }
    #resultTable thead { background-color: #e3f2fd; }
    #resultTable th {
      color:#000;text-align:center;font-weight:700;
      padding:10px 8px;border-bottom:2px solid #bbdefb;
      cursor:pointer;transition:background 0.2s ease;
    }
    #resultTable th:hover { background-color:#bbdefb; }
    #resultTable td { text-align:center;vertical-align:middle; }
    .bg-danger-subtle,.table-danger { background-color:#ffeaea!important; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV dari WEB CO → Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr/>

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv"/>
      <small class="text-muted">
        Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, 
        Tanggal Diambil, Diambil Oleh, Dibuat Oleh).
      </small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
const LOG_URL   = "https://script.google.com/macros/s/AKfycbztSrAD09xjqVc5qVWx95Rr6AojT3CNjCdY20t0MMjkP5vY-CZKacV8UpwL0c7cvGWGCg/exec";

let sheetData=[],csvData=[],lastResults=[];

document.getElementById("tanggalCek").textContent = 
  new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});

// === Simpan Log ke GAS ===
async function simpanLogCO(shift, csvName, jpegBlob) {
  try {
    const base64Data = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onloadend = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(jpegBlob);
    });

    const payload = { shift, csvName, jpegBase64: base64Data };
    const res = await fetch(LOG_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
      document.getElementById("statusText").textContent = "✅ Log tersimpan di Google Sheet & Drive.";
      console.log("File tersimpan:", data.url);
    } else {
      document.getElementById("statusText").textContent = "⚠️ Gagal simpan log: " + data.error;
    }
  } catch (err) {
    document.getElementById("statusText").textContent = "❌ Gagal kirim log ke GAS: " + err.message;
  }
}

// === Fungsi bantu ===
function normKey(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){ if(!v)return 0; const m=v.match(/(\d+)\s*d\s*(\d{1,2}):(\d{2}):(\d{2})/i); if(m)return m[1]*86400+m[2]*3600+m[3]*60+m[4]; const m2=v.match(/(\d{1,2}):(\d{2}):(\d{2})/); return m2?m2[1]*3600+m2[2]*60+m2[3]:0; }
function normalizeStatus(s){ return (s||"").replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }
function isAcceptedStatus(n){ return n.includes("resolved")||n.includes("closed")||n.includes("inprogress")||n.includes("in progress")||n.includes("pending"); }
function similarity(a,b){ a=normalizeName(a);b=normalizeName(b);if(!a||!b)return 0;const d=levenshtein(a,b);return 1-d/Math.max(a.length,b.length);}
function levenshtein(a,b){const al=a.length,bl=b.length;if(!al)return bl;if(!bl)return al;const dp=Array.from({length:al+1},()=>Array(bl+1).fill(0));for(let i=0;i<=al;i++)dp[i][0]=i;for(let j=0;j<=bl;j++)dp[0][j]=j;for(let i=1;i<=al;i++)for(let j=1;j<=bl;j++)dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1));return dp[al][bl];}
function ambilJamDariTanggal(s){const m=s&&s.match(/(\d{1,2}):(\d{2})/);return m?`${m[1].padStart(2,'0')}:${m[2]}`:"-";}

// === Ambil data GSheet ===
document.getElementById("ambilNamaBtn").addEventListener("click", async()=>{
  const shift=document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!shift)return alert("Masukkan shift (M, P, atau S)");
  document.getElementById("statusText").textContent="Mengambil data dari Google Sheet...";
  try{
    let shifts=[shift];
    if(shift==="P")shifts=["P","P1"];
    sheetData=[];
    for(const s of shifts){
      const res=await fetch(`${SHEET_URL}?shift=${s}`);
      const data=await res.json();
      const list=(data.karyawan||[]).map(k=>({nama:(k.nama||"").trim(),nik:(k.nik||"").trim(),shift:s}));
      sheetData=sheetData.concat(list);
    }
    document.getElementById("statusText").textContent = 
      sheetData.length?`✅ Data ditemukan: ${sheetData.length} orang (Shift ${shifts.join(" / ")})`:"⚠️ Tidak ada data.";
    document.getElementById("generateBtn").disabled=!sheetData.length;
  }catch(e){document.getElementById("statusText").textContent="Gagal memanggil API: "+e.message;}
});

// === Upload CSV ===
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const f=e.target.files[0];if(!f)return;
  Papa.parse(f,{header:true,delimiter:";",skipEmptyLines:true,complete:(res)=>{
    csvData=res.data;document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;}});
});

// === Hitung + tampil + kirim log ===
document.getElementById("generateBtn").addEventListener("click",async()=>{
  if(!sheetData.length)return alert("Ambil nama dari GSheet dulu.");
  if(!csvData.length)return alert("Upload file CSV dulu.");
  const results=sheetData.map(k=>({k,res:rataRata_byName(k.nama)}));
  lastResults=results;renderTable(results);
  document.getElementById("statusText").textContent="✅ Perhitungan selesai.";

  const shift=document.getElementById("shiftInput").value.trim();
  const csvName=document.getElementById("csvFile").files[0]?.name||"tanpa_nama.csv";
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  canvas.toBlob(blob=>{if(blob)simpanLogCO(shift,csvName,blob);},"image/jpeg",0.9);
});

// === Hitung rata-rata per nama ===
function computeC(r){return r.waktuSlaDetik>0?r.durasiDetik/r.waktuSlaDetik:0;}
function rataRata_byName(nama,thr=0.85){
  const match=csvData.filter(r=>isAcceptedStatus(normalizeStatus(r["Status Komplain"]||r.status))
    && similarity(nama,r["Diambil Oleh"]||r.diambilOleh)>=thr);
  if(!match.length)return{avg:null,count:0,lastTime:"-",slaCount:0,inProgressCount:0,relasiResolved:0};
  const sum=match.reduce((a,b)=>a+computeC({
    durasiDetik:durasiKeDetik(b["Durasi Komplain"]||b.durasiRaw),
    waktuSlaDetik:(parseFloat((b["Waktu SLA"]||"0").replace(",","."))||0)*3600}),0);
  const latest=match.map(r=>r["Tanggal Diambil"]||r.tanggalDiambil).sort().pop();
  const slaCount=match.filter(r=>(r["Status SLA"]||"").toLowerCase().includes("lewat")).length;
  const inProgressCount=match.filter(r=>normalizeStatus(r["Status Komplain"]||"").includes("progress")).length;
  const relasiResolved=match.filter(r=>normalizeStatus(r["Status Komplain"]||"").includes("pending")).length;
  return{avg:sum/match.length,count:match.length,lastTime:ambilJamDariTanggal(latest),slaCount,inProgressCount,relasiResolved};
}

// === Render tabel ===
function renderTable(results){
  const tb=document.querySelector("#resultTable tbody");tb.innerHTML="";
  results.forEach((item,i)=>{
    const {k,res}=item;
    const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";
    const row=document.createElement("tr");
    if(res.slaCount>0)row.classList.add("table-danger");
    row.innerHTML=`<td>${i+1}</td><td>${k.nama}</td><td>${k.shift}</td>
      <td>${res.lastTime}</td><td>${avg}</td><td>${res.count}</td>
      <td>${res.slaCount}</td><td>${res.inProgressCount}</td><td>${res.relasiResolved}</td>`;
    tb.appendChild(row);
  });
}

// === Download JPG manual ===
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
