<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { font-size: 15px; }
    #resultTable th { background: #f2f2f2; text-align: center; cursor: pointer; }
    #resultTable th:hover { background:#e8e8e8; }
    pre.debug { background:#fff9c4; padding:10px; border-radius:6px; font-size:13px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift ‚Üí Ambil nama dari GSheet ‚Üí Upload CSV dari WEB CO ‚Üí Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-muted">Pastikan CSV memiliki header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, Tanggal Diambil, Diambil Oleh, Dibuat Oleh).</small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3">Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Karyawan</th>
            <th>Shift</th>
            <th>LastCO</th>
            <th id="sortIndexCO">IndexCO ‚¨ç</th>
            <th id="sortTotalCO">TotalCO ‚¨ç</th>
            <th>SLA</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
let sheetData = [];
let csvData = [];
let lastResults = [];
let sortTotalAsc = true;
let sortIndexAsc = false;

document.getElementById("tanggalCek").textContent = new Date().toLocaleDateString("id-ID", {
  day:"numeric", month:"long", year:"numeric"
});

// === Ambil Nama dari GSheet ===
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shift = document.getElementById("shiftInput").value.trim();
  if (!shift) return;
  document.getElementById("statusText").textContent = "üîÑ Mengambil data GSheet...";
  try {
    const res = await fetch(`${GAS_URL}?shift=${shift}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    sheetData = data;
    document.getElementById("statusText").textContent = `‚úÖ Data ${sheetData.length} karyawan shift ${shift} berhasil diambil.`;
  } catch (err) {
    document.getElementById("statusText").textContent = `‚ùå Gagal mengambil data GSheet: ${err.message}`;
  }
});

// === Upload CSV ===
document.getElementById("csvFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("statusText").textContent = "üîÑ Memproses file CSV...";
  Papa.parse(file, {
    header: true,
    complete: (results) => {
      csvData = results.data;
      document.getElementById("statusText").textContent = `‚úÖ File CSV berhasil dimuat (${csvData.length} baris).`;
    }
  });
});

// === Fungsi bantu ===
function rataRata_byNIK(nik) {
  const rows = csvData.filter(r => (r["NIK Pengambil"] || "").trim() == nik);
  if (!rows.length) return { avg:null, count:0, slaCount:0, lastTime:"-" };
  const total = rows.length;
  const slaCount = rows.filter(r => (r["Status SLA"] || "").toLowerCase() === "lewat").length;
  const avg = total ? rows.reduce((a,r)=>a+(parseFloat(r["Durasi Komplain"])||0),0)/total : null;
  const lastTime = rows[rows.length-1]["Tanggal Diambil"] || "-";
  return { avg, count: total, slaCount, lastTime };
}

function rataRata_byName(nama) {
  const rows = csvData.filter(r => (r["Diambil Oleh"] || "").trim().toLowerCase().includes(nama.trim().toLowerCase()));
  if (!rows.length) return { avg:null, count:0, slaCount:0, lastTime:"-" };
  const total = rows.length;
  const slaCount = rows.filter(r => (r["Status SLA"] || "").toLowerCase() === "lewat").length;
  const avg = total ? rows.reduce((a,r)=>a+(parseFloat(r["Durasi Komplain"])||0),0)/total : null;
  const lastTime = rows[rows.length-1]["Tanggal Diambil"] || "-";
  return { avg, count: total, slaCount, lastTime };
}

// === Render Table ===
function renderTable(results) {
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  results.forEach((item,index)=>{
    const {k,res}=item;
    const avg=res.avg!==null ? (Math.round(res.avg*100)/100).toFixed(2) : "-";
    const ket=res.count>0 ? `${res.count}` : "-";
    const slaCount=res.slaCount||0;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${k.nama}</td>
      <td>${k.shift}</td>
      <td>${res.lastTime}</td>
      <td>${avg}</td>
      <td>${ket}</td>
      <td>${slaCount}</td>
    `;
    tbody.appendChild(tr);
  });
}

// === Generate Tabel ===
document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!sheetData.length)return;
  if(!csvData.length)return;

  const results = sheetData.map(k=>{
    let res=rataRata_byNIK(k.nik);
    if(!res.count) res=rataRata_byName(k.nama);
    return {k,res};
  });

  // Default urut: IndexCO menurun
  results.sort((a,b)=>{
    const indexA=a.res.avg!==null?a.res.avg:-Infinity;
    const indexB=b.res.avg!==null?b.res.avg:-Infinity;
    return indexB-indexA;
  });

  lastResults = results;
  renderTable(results);
  document.getElementById("statusText").textContent="‚úÖ Perhitungan selesai.";
});

// === Sort by TotalCO ===
document.getElementById("sortTotalCO").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortTotalAsc = !sortTotalAsc;
  lastResults.sort((a,b)=>{
    const totalA = a.res.count || 0;
    const totalB = b.res.count || 0;
    return sortTotalAsc ? totalA - totalB : totalB - totalA;
  });
  renderTable(lastResults);
  document.getElementById("sortTotalCO").textContent = `TotalCO ${sortTotalAsc ? "‚Üë" : "‚Üì"}`;
});

// === Sort by IndexCO ===
document.getElementById("sortIndexCO").addEventListener("click",()=>{
  if(!lastResults.length) return;
  sortIndexAsc = !sortIndexAsc;
  lastResults.sort((a,b)=>{
    const valA = a.res.avg || 0;
    const valB = b.res.avg || 0;
    return sortIndexAsc ? valA - valB : valB - valA;
  });
  renderTable(lastResults);
  document.getElementById("sortIndexCO").textContent = `IndexCO ${sortIndexAsc ? "‚Üë" : "‚Üì"}`;
});

// === Download JPG ===
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
