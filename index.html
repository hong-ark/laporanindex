<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background: #f6f7fb;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* === HEADER TABEL === */
    #resultTable.table thead tr th {
      background-color: #1976d2 !important;
      color: white !important;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      padding: 10px;
      user-select: none;
      vertical-align: middle;
      border-color: #1565c0 !important;
    }

    #resultTable.table thead tr th:hover {
      background-color: #1565c0 !important;
    }

    #resultTable td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .table-danger {
      background-color: #ffeaea !important;
    }

    /* Tambahan judul dinamis */
    #judulLaporan {
      font-size: 1.1rem;
      font-weight: 600;
      text-align: left;
      margin-bottom: 10px;
      color: #333;
    }

    /* Footer copyright */
    .footer {
      text-align: center;
      font-size: 0.85rem;
      color: #888;
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV → Generate Tabel</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-select">
          <option value="">Pilih Shift</option>
          <option value="M">M (Malam)</option>
          <option value="MH1">M H-1 (Malam H-1)</option>
          <option value="S">S (Siang)</option>
          <option value="P">P (Pagi)</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet</button>
      </div>

      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <!-- Judul dinamis di atas tabel -->
    <div id="judulLaporan"></div>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <div class="footer">© 2025 EDP Fai</div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";

let sheetData = [];
let csvData = [];
let lastResults = [];

// === Status Sort ===
let sortAscNama = true;
let sortAscLastCO = false;
let sortAscIndexCO = false;
let sortAscTotalCO = true;
let sortAscSLA = false;
let sortAscInProgress = false;
let sortAscRelasiResolved = false;

// === AUTO TANGGAL ===
document.getElementById("tanggalCek").textContent =
  new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });

// === FUNGSI BANTU ===
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){
  if (!v) return 0;
  const s = v.toString().trim();
  const m1 = s.match(/(\d+) d (\d{1,2}):(\d{2}):(\d{2})/i);
  if (m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
  const m2 = s.match(/(\d{1,2}):(\d{2}):(\d{2})/);
  if (m2) return (+m2[1])*3600 + (+m2[2])*60 + (+m2[3]);
  return 0;
}
function normalizeStatus(s){
  if (!s) return "";
  return String(s).replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
}
function isAcceptedStatus(norm){
  return norm.includes("resolved") || norm.includes("closed") ||
         norm.includes("inprogress") || norm.includes("in progress") ||
         norm.includes("pending");
}
function levenshtein(a,b){
  a=a||""; b=b||"";
  const al=a.length, bl=b.length;
  if(!al) return bl;
  if(!bl) return al;
  const dp = Array.from({length:al+1}, ()=>Array(bl+1).fill(0));
  for(let i=0;i<=al;i++) dp[i][0]=i;
  for(let j=0;j<=bl;j++) dp[0][j]=j;
  for(let i=1;i<=al;i++)
    for(let j=1;j<=bl;j++)
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1] + (a[i-1]===b[j-1]?0:1));
  return dp[al][bl];
}
function similarity(a,b){
  a=normalizeName(a); b=normalizeName(b);
  if(!a||!b) return 0;
  const d= levenshtein(a,b);
  return 1 - d/Math.max(a.length,b.length);
}
function ambilJamDariTanggal(s){
  if(!s) return "-";
  const m=s.match(/(\d{1,2}):(\d{2})/);
  return m ? `${m[1].padStart(2,'0')}:${m[2]}` : "-";
}

// === AMBIL DATA GSheet (termasuk MH1) ===
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shiftInput) return alert("Pilih shift dulu!");

  document.getElementById("statusText").textContent = "Mengambil data dari GSheet...";

  try {
    const now = new Date();
    let tanggalLabel;
    if (shiftInput === "MH1") {
      const y = new Date(now);
      y.setDate(now.getDate() - 1);
      tanggalLabel = y.toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });
    } else {
      tanggalLabel = now.toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });
    }
    document.getElementById("tanggalCek").textContent = tanggalLabel;

    let shifts = [shiftInput];
    if (shiftInput === "P") shifts = ["P", "P1"];

    sheetData = [];
    for (const s of shifts) {
      const url = `${GAS_URL}?shift=${encodeURIComponent(s)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Gagal ambil data GSheet");

      const list = (data.karyawan || []).map(k => ({
        nama: (k.nama || "").trim(),
        nik: (k.nik || "").trim(),
        shift: (k.shift || "").trim()
      }));
      sheetData = sheetData.concat(list);
    }

    sheetData = sheetData.filter((obj, idx, arr) => idx === arr.findIndex(t => t.nama === obj.nama));

    document.getElementById("generateBtn").disabled = false;
    document.getElementById("statusText").textContent = `✅ ${sheetData.length} nama berhasil diambil (Shift ${shiftInput}).`;

  } catch (err) {
    console.error(err);
    alert("Gagal mengambil data: " + err.message);
    document.getElementById("statusText").textContent = "❌ Gagal mengambil data dari GSheet.";
  }
});

// === LOAD CSV ===
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  Papa.parse(file,{
    header:true,
    delimiter:";",
    skipEmptyLines:true,
    complete:(res)=>{
      const headerMap={};
      (res.meta.fields||[]).forEach(f=>headerMap[normKey(f)]=f);
      const getCol=(row,arr)=>{
        for(const c of arr){
          for(const key in headerMap){
            if(key.includes(c)){
              const realKey = headerMap[key];
              if(row[realKey]) return row[realKey].toString();
            }
          }
        }
        return "";
      };

      csvData = res.data.map(r=>{
        const nikRaw = (getCol(r,['nikpengambil','nik'])).replace(/\D/g,'').trim();
        const diambilOleh = getCol(r,['diambiloleh','diambil oleh']);
        const durasiRaw = getCol(r,['durasikomplain','durasi']);
        const waktuSlaRaw = getCol(r,['waktusla','waktu sla']);
        const statusRaw = getCol(r,['statuskomplain','status']);
        const statusSlaRaw = getCol(r,['statussla','status sla']);
        const tglDiambilRaw = getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
        const slaNum = parseFloat((waktuSlaRaw||"").replace(",","."))||0;

        return {
          nik: nikRaw,
          diambilOleh,
          durasiRaw,
          durasiDetik: durasiKeDetik(durasiRaw),
          waktuSlaDetik: slaNum*3600,
          status: statusRaw,
          statusNorm: normalizeStatus(statusRaw),
          statusSLA: statusSlaRaw,
          tanggalDiambil: tglDiambilRaw
        };
      });
      document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

// === GENERATE TABLE ===
document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!sheetData.length || !csvData.length){
    alert("Pastikan data GSheet dan CSV sudah dimuat.");
    return;
  }

  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";

  sheetData.forEach((row,i)=>{
    const nama=row.nama;
    const nik=row.nik;
    const shift=row.shift;
    const kandidat=csvData.filter(c=>similarity(c.diambilOleh,nama)>0.7 || (c.nik && c.nik===nik));

    let lastCO="-", indexCO=0, totalCO=0, sla=0, inProgress=0, relasiResolved=0;
    if(kandidat.length){
      kandidat.sort((a,b)=>b.durasiDetik-a.durasiDetik);
      const last=kandidat[0];
      lastCO=ambilJamDariTanggal(last.tanggalDiambil);
      totalCO=kandidat.length;
      kandidat.forEach(k=>{
        if(isAcceptedStatus(k.statusNorm)){
          if(k.statusNorm.includes("inprogress")) inProgress++;
          if(k.statusNorm.includes("resolved")||k.statusNorm.includes("closed")) relasiResolved++;
        }
        if(k.statusSLA?.toLowerCase().includes("terpenuhi")) sla++;
      });
      indexCO = totalCO ? (relasiResolved/totalCO).toFixed(2) : 0;
    }

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${nama}</td>
      <td>${shift}</td>
      <td>${lastCO}</td>
      <td>${indexCO}</td>
      <td>${totalCO}</td>
      <td>${sla}</td>
      <td>${inProgress}</td>
      <td>${relasiResolved}</td>
    `;
    if(indexCO < 0.3) tr.classList.add("table-danger");
    tbody.appendChild(tr);
  });

  // === Judul Otomatis ===
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  const shiftText = shiftInput === "P" ? "Shift 1" :
                    shiftInput === "S" ? "Shift 2" :
                    shiftInput === "M" || shiftInput === "MH1" ? "Shift 3" : shiftInput;
  const tanggalLabel = document.getElementById("tanggalCek").textContent;
  document.getElementById("judulLaporan").textContent =
    `Laporan Index CO ${shiftText} — Tanggal ${tanggalLabel}`;
});

// === DOWNLOAD JPG ===
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
