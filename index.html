<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px;
                 box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    #judulLaporan { font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 15px; color:#000000; }
    #judulLaporan.is-history { color: #8e24aa; } /* Warna ungu saat lihat History */
    #copyright { text-align: center; font-size: 14px; color: #000; margin-top: 40px; margin-bottom: 10px; font-weight: 600; }

    /* Default header biru */
    #resultTable.table thead tr th {
      background-color: #1976d2 !important; color: white !important; text-align: center;
      font-weight: 700; cursor: pointer; padding: 10px; user-select: none;
      vertical-align: middle; border-color: #1565c0 !important;
    }
    #resultTable.table thead tr th:hover { background-color: #1565c0 !important; }

    /* Header abu-abu saat tampilan History */
    #resultArea.is-history thead tr th {
      background-color: #9e9e9e !important;
      border-color: #757575 !important;
      color: #fff !important;
    }

    #resultTable td { text-align: center; vertical-align: middle; font-size: 0.95rem; }
    .table-danger { background-color: #ffeaea !important; }
  </style>
</head>

<body>
<div class="container">
  <h4><b>Laporan Index Shift</b></h4>
  <p>Pilih shift → Generate Jadwal → Upload CSV → Hitung Index</p>

  <div class="mb-3 row align-items-end">
    <div class="col-auto">
      <label class="form-label">Mode</label><br />
      <select id="shiftInput" class="form-select w-auto d-inline-block">
        <option value="">Pilih Shift</option>
        <option value="IDX">Index hari ini</option>
        <option value="P">P (Pagi)</option>
        <option value="S">S (Siang)</option>
        <option value="M">M (Malam)</option>
        <option value="MH1">M H-1 (Malam H-1)</option>
      </select>
      <div id="modeNote" class="form-text text-muted mt-1"></div>
    </div>

    <div class="col-md-5">
      <label class="form-label">&nbsp;</label><br />
      <button id="ambilNamaBtn" class="btn btn-primary">Generate Jadwal</button>
    </div>

    <div class="col-md-4 text-end">
      <label class="form-label">Tanggal dicek:</label>
      <p id="tanggalCek"></p>
    </div>
  </div>

  <hr>

  <div class="mb-3">
    <label class="form-label">Upload CSV</label>
    <input type="file" id="csvFile" class="form-control" accept=".csv" />
  </div>

  <button id="generateBtn" class="btn btn-success mb-1" disabled>Hitung Index</button>
  <span id="statusText" class="ms-2 text-muted"></span>

  <!-- Toggle hanya aktif saat S -->
  <div class="form-check mt-2">
    <input class="form-check-input" type="checkbox" id="toggleSiang14" disabled>
    <label class="form-check-label text-muted" for="toggleSiang14" id="labelToggleSiang14">
      Hitung Siang mulai ≥ 14:00
    </label>
  </div>

  <div id="judulLaporan" class="mt-2"></div>

  <div id="resultArea" class="mt-2">
    <table id="resultTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th id="sortNama">Nama Karyawan</th>
          <th>Shift/Mode</th>
          <th id="sortLastCO">LastCO</th>
          <th id="sortIndexCO">IndexCO</th>
          <th id="sortTotalCO">TotalCO</th>
          <th id="sortSLA">SLA</th>
          <th id="sortInProgress">InProgress</th>
          <th id="sortRelasiResolved">RelasiResolved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button id="historyBtn" class="btn btn-secondary">History</button>
    <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
  </div>
</div>

<!-- Modal History -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">History Laporan (10 terakhir)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div id="historyList" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ==============================
   Bagian utama script tetap sama
   (perhitungan, history, render, dll)
   ============================== */

// hanya bagian tambahan penting terkait header abu-abu:

function showHistoryModal(){
  renderHistoryList();
  const modal = new bootstrap.Modal(document.getElementById("historyModal"));
  modal.show();
}

async function renderHistoryList(){
  const list = document.getElementById("historyList");
  list.innerHTML = '<div class="text-muted">Memuat...</div>';
  try{
    const arr = await loadHistory();
    if(!arr.length){
      list.innerHTML = '<div class="text-muted">Belum ada history.</div>';
      return;
    }
    list.innerHTML = "";
    arr.forEach(h=>{
      const btn = document.createElement("button");
      btn.type="button";
      btn.className="list-group-item list-group-item-action";
      const modeLabel = (h.mode==="IDX") ? "Index hari ini" : h.shiftLabel;
      btn.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${modeLabel}</h6>
          <small>${prettyDateTime(h.ts)}</small>
        </div>
        <div class="mb-1">Tanggal: ${prettyTanggalLabel(h.tanggal)} • Baris: ${h.results?.length||0}</div>
      `;
      btn.addEventListener("click", ()=>{
        lastResults = h.results || [];
        renderTable(lastResults);
        const judul = document.getElementById("judulLaporan");
        judul.classList.add("is-history");
        document.getElementById("resultArea").classList.add("is-history"); // <<-- ubah header jadi abu-abu
        judul.textContent =
          (h.mode==="IDX")
            ? `[HISTORY] Laporan Index CO — Index Hari Ini — Tanggal ${prettyTanggalLabel(h.tanggal)}`
            : `[HISTORY] Laporan Index CO ${h.shiftLabel} — Tanggal ${prettyTanggalLabel(h.tanggal)}`;
        document.getElementById("statusText").textContent = `Ditampilkan dari history (${prettyDateTime(h.ts)}).`;
        bootstrap.Modal.getInstance(document.getElementById("historyModal"))?.hide();
      });
      list.appendChild(btn);
    });
  }catch(err){
    list.innerHTML = `<div class="text-danger">Gagal memuat history: ${err.message}</div>`;
  }
}

/* Saat hitung laporan baru (bukan history), kembalikan header ke biru */
document.getElementById("generateBtn").addEventListener("click", ()=>{
  const judul=document.getElementById("judulLaporan");
  judul.classList.remove("is-history");
  document.getElementById("resultArea").classList.remove("is-history"); // <<-- reset header biru
});
</script>

<div id="copyright">
  © 2025 EDP Fai
</div>
</body>
</html>
