<script>
// ====================================================================
// GANTI URL INI jika skrip API Ambil Nama Anda berbeda
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec"; 

// URL BARU DARI ANDA UNTUK SIMPAN LOG/GAMBAR
const LOG_URL   = "https://script.google.com/macros/s/AKfycbwFsyoZt20LU_OSEQ-D4FQ6XwLXqARtOz24ZItWKGE1XQvbX9BGJ0iZyFD1xr8wbGVJ_w/exec";
// ====================================================================

let sheetData=[],csvData=[],lastResults=[];

document.getElementById("tanggalCek").textContent = 
    new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});

// === FUNGSI View History (Memanggil doGet) ===
// DIREVISI: Membaca respons langsung sebagai JSON
async function viewHistory() {
    const historyBody = document.querySelector("#historyTable tbody");
    const historyStatus = document.getElementById("historyStatus");
    historyBody.innerHTML = ''; 
    historyStatus.textContent = 'Memuat log dari Google Sheet...';

    try {
        const res = await fetch(LOG_URL, { method: "GET" });
        if (!res.ok) throw new Error(`Permintaan gagal dengan status ${res.status}`);
        
        // --- REVISI KRUSIAL: Membaca respons langsung sebagai JSON ---
        // Ini bekerja karena script GAS diubah untuk menggunakan ContentService untuk doGet
        const data = await res.json(); 
        // -----------------------------------------------------------
        
        if (data.success && data.logs && data.logs.length > 0) {
            historyStatus.textContent = `Ditemukan ${data.logs.length} log terakhir.`;
            
            data.logs.forEach(log => {
                const row = historyBody.insertRow();
                const d = new Date(log.timestamp);
                
                row.insertCell().textContent = d.toLocaleString('id-ID', {
                    hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short'
                });
                row.insertCell().textContent = log.shift;
                row.insertCell().textContent = log.csvName;
                
                const linkCell = row.insertCell();
                const a = document.createElement('a');
                a.href = log.fileLink || '#';
                a.target = '_blank';
                a.textContent = 'Lihat Gambar';
                linkCell.appendChild(a);
            });
        } else {
            historyStatus.textContent = data.message || "Tidak ada log yang ditemukan.";
        }
    } catch (err) {
        historyStatus.textContent = `❌ Gagal memuat history: ${err.message}. Pastikan script GAS sudah di-deploy ulang.`;
        console.error("Error History:", err);
    }
}

document.getElementById("historyBtn").addEventListener("click", viewHistory);


// === Simpan Log ke GAS (Mode No-CORS - DIBIARKAN AGAR POST TETAP BERHASIL) ===
async function simpanLogCO(shift, csvName, jpegBlob) {
    try {
        document.getElementById("statusText").textContent = "Mengambil tangkapan layar...";

        const base64Data = await new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onloadend = () => resolve(r.result);
            r.onerror = reject;
            r.readAsDataURL(jpegBlob);
        });

        document.getElementById("statusText").textContent = "Mengirim log dan gambar ke Google Drive (Mode No-CORS)...";
        const payload = { shift, csvName, jpegBase64: base64Data };
        
        await fetch(LOG_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            mode: "no-cors"
        });

        document.getElementById("statusText").innerHTML = `✅ Log berhasil dikirim ke Google Drive/Sheet. <a href="#" data-bs-toggle="modal" data-bs-target="#historyModal">Cek di History.</a>`;

    } catch (err) {
        document.getElementById("statusText").textContent = "❌ Gagal kirim log ke GAS: " + err.message;
        console.error("Kesalahan pengiriman log:", err);
    }
}

// === Fungsi bantu (TIDAK BERUBAH) ===
function normKey(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){ if(!v)return 0; const m=v.match(/(\d+)\s*d\s*(\d{1,2}):(\d{2}):(\d{2})/i); if(m)return m[1]*86400+m[2]*3600+m[3]*60+m[4]; const m2=v.match(/(\d{1,2}):(\d{2}):(\d{2})/); return m2?m2[1]*3600+m2[2]*60+m2[3]:0; }
function normalizeStatus(s){ return (s||"").replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }
function isAcceptedStatus(n){ return n.includes("resolved")||n.includes("closed")||n.includes("inprogress")||n.includes("in progress")||n.includes("pending"); }
function similarity(a,b){ a=normalizeName(a);b=normalizeName(b);if(!a||!b)return 0;const d=levenshtein(a,b);return 1-d/Math.max(a.length,b.length);}
function levenshtein(a,b){const al=a.length,bl=b.length;if(!al)return bl;if(!bl)return al;const dp=Array.from({length:al+1},()=>Array(bl+1).fill(0));for(let i=0;i<=al;i++)dp[i][0]=i;for(let j=0;j<=bl;j++)dp[0][j]=j;for(let i=1;i<=al;i++)for(let j=1;j<=bl;j++)dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1));return dp[al][bl];}
function ambilJamDariTanggal(s){const m=s&&s.match(/(\d{1,2}):(\d{2})/);return m?`${m[1].padStart(2,'0')}:${m[2]}`:"-";}

// === Ambil data GSheet (Perlu membaca respons sebagai teks lalu mengurai JSON) ===
document.getElementById("ambilNamaBtn").addEventListener("click", async()=>{
    const shift=document.getElementById("shiftInput").value.trim().toUpperCase();
    if(!shift)return alert("Masukkan shift (M, P, atau S)");
    document.getElementById("statusText").textContent="Mengambil data dari Google Sheet...";
    try{
        let shifts=[shift];
        if(shift==="P")shifts=["P","P1"];
        sheetData=[];
        for(const s of shifts){
            const res=await fetch(`${SHEET_URL}?shift=${s}`);
            const text = await res.text(); // Baca sebagai teks (API ini masih menggunakan HtmlService)
            const data = JSON.parse(text.match(/\{.*\}/s)[0]); // Urai JSON
            const list=(data.karyawan||[]).map(k=>({nama:(k.nama||"").trim(),nik:(k.nik||"").trim(),shift:s}));
            sheetData=sheetData.concat(list);
        }
        document.getElementById("statusText").textContent = 
            sheetData.length?`✅ Data ditemukan: ${sheetData.length} orang (Shift ${shifts.join(" / ")})`:"⚠️ Tidak ada data.";
        document.getElementById("generateBtn").disabled=!sheetData.length;
    }catch(e){document.getElementById("statusText").textContent="Gagal memanggil API: "+e.message;}
});

// === Upload CSV (TIDAK BERUBAH) ===
document.getElementById("csvFile").addEventListener("change",(e)=>{
    const f=e.target.files[0];if(!f)return;
    Papa.parse(f,{header:true,delimiter:";",skipEmptyLines:true,complete:(res)=>{
        csvData=res.data;document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;}});
});

// === Hitung + tampil + kirim log (TIDAK BERUBAH) ===
document.getElementById("generateBtn").addEventListener("click",async()=>{
    if(!sheetData.length)return alert("Ambil nama dari GSheet dulu.");
    if(!csvData.length)return alert("Upload file CSV dulu.");
    const results=sheetData.map(k=>({k,res:rataRata_byName(k.nama)}));
    lastResults=results;renderTable(results);
    document.getElementById("statusText").textContent="✅ Perhitungan selesai.";

    const shift=document.getElementById("shiftInput").value.trim();
    const csvName=document.getElementById("csvFile").files[0]?.name||"tanpa_nama.csv";
    const area=document.querySelector("#resultArea");
    
    const canvas=await html2canvas(area,{scale:2});
    canvas.toBlob(blob=>{if(blob)simpanLogCO(shift,csvName,blob);},"image/jpeg",0.9);
});

// === Hitung rata-rata per nama (TIDAK BERUBAH) ===
function computeC(r){return r.waktuSlaDetik>0?r.durasiDetik/r.waktuSlaDetik:0;}
function rataRata_byName(nama,thr=0.85){
    const match=csvData.filter(r=>isAcceptedStatus(normalizeStatus(r["Status Komplain"]||r.status))
        && similarity(nama,r["Diambil Oleh"]||r.diambilOleh)>=thr);
    if(!match.length)return{avg:null,count:0,lastTime:"-",slaCount:0,inProgressCount:0,relasiResolved:0};
    const sum=match.reduce((a,b)=>a+computeC({
        durasiDetik:durasiKeDetik(b["Durasi Komplain"]||b.durasiRaw),
        waktuSlaDetik:(parseFloat((b["Waktu SLA"]||"0").replace(",","."))||0)*3600}),0);
    const latest=match.map(r=>r["Tanggal Diambil"]||r.tanggalDiambil).sort().pop();
    const slaCount=match.filter(r=>(r["Status SLA"]||"").toLowerCase().includes("lewat")).length;
    const inProgressCount=match.filter(r=>normalizeStatus(r["Status Komplain"]||"").includes("progress")).length;
    const relasiResolved=match.filter(r=>normalizeStatus(r["Status Komplain"]||"").includes("pending")).length;
    return{avg:sum/match.length,count:match.length,lastTime:ambilJamDariTanggal(latest),slaCount,inProgressCount,relasiResolved};
}

// === Render tabel (TIDAK BERUBAH) ===
function renderTable(results){
    const tb=document.querySelector("#resultTable tbody");tb.innerHTML="";
    results.forEach((item,i)=>{
        const {k,res}=item;
        const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";
        const row=document.createElement("tr");
        if(res.slaCount>0)row.classList.add("table-danger");
        row.innerHTML=`<td>${i+1}</td><td>${k.nama}</td><td>${k.shift}</td>
            <td>${res.lastTime}</td><td>${avg}</td><td>${res.count}</td>
            <td>${res.slaCount}</td><td>${res.inProgressCount}</td><td>${res.relasiResolved}</td>`;
        tb.appendChild(row);
    });
}

// === Download JPG manual (TIDAK BERUBAH) ===
document.getElementById("downloadBtn").addEventListener("click",async()=>{
    const area=document.querySelector("#resultArea");
    const canvas=await html2canvas(area,{scale:2});
    const link=document.createElement("a");
    link.download="Laporan_Index_Shift.jpg";
    link.href=canvas.toDataURL("image/jpeg");
    link.click();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
