<script>
document.getElementById('processBtn').addEventListener('click', () => {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  if (!file) return alert('Pilih file CSV terlebih dahulu!');
  
  Papa.parse(file, {
    header: true,
    delimiter: ";",
    skipEmptyLines: true,
    complete: function(results) {
      const data = results.data;
      const summary = {};

      data.forEach(row => {
        const nik = row["NIK Pengambil"]?.trim();
        const status = row["Status Komplain"]?.trim()?.toUpperCase();
        const statusSLA = row["Status SLA"]?.trim()?.toUpperCase();
        const tglSelesai = row["Tanggal Selesai"]?.trim();

        // Hanya ambil status tertentu
        if (!nik || !["RESOLVED", "IN PROGRESS", "CLOSED"].includes(status)) return;

        if (!summary[nik]) {
          summary[nik] = { totalCO: 0, slaLewat: 0, lastCO: null };
        }

        summary[nik].totalCO++;

        // Cek SLA lewat
        if (statusSLA.includes("LEWAT")) summary[nik].slaLewat++;

        // Ambil jam terakhir dari Tanggal Selesai
        if (tglSelesai) {
          const parts = tglSelesai.split(" ");
          const jam = parts.length > 1 ? parts[1] : "";
          const dateObj = new Date(tglSelesai.replace(" ","T"));
          if (!summary[nik].lastCO || dateObj > summary[nik].lastCO) {
            summary[nik].lastCO = { date: dateObj, jam };
          }
        }
      });

      // Buat tabel hasil
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      Object.entries(summary).forEach(([nik, info]) => {
        const indexCO = info.totalCO > 0 ? (info.slaLewat / info.totalCO).toFixed(4) : "-";
        const jamTerakhir = info.lastCO ? info.lastCO.jam : "-";

        const row = `
          <tr>
            <td>${nik}</td>
            <td>${jamTerakhir}</td>
            <td>${indexCO}</td>
            <td>${info.totalCO} Co diambil</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      alert("âœ… Selesai menghitung " + Object.keys(summary).length + " personil");
    }
  });
});
</script>
