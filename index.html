<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px;
                 box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    #judulLaporan { font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 15px; color:#000; }
    #judulLaporan.is-history { color: #8e24aa; }
    #resultTable td { text-align: center; vertical-align: middle; font-size: 0.95rem; }

    /* Merah bila ada SLA lewat (sudah ada di bootstrap class table-danger tetapi safety) */
    .table-danger td {
      background-color: #ffeaea !important;
    }

    /* Oranye/kuning untuk index > 0.35 pada seluruh baris (override striped/other styles) */
    .table-index-warning td {
      background-color: #ffcc80 !important; /* oranye-kuning */
      color: #000 !important;
    }
  </style>
</head>
<body>
<div class="container">
  <h4><b>Laporan Index Shift</b></h4>
  <p>Pilih shift → Generate Jadwal → Upload CSV → Hitung Index</p>

  <!-- (UI seperti sebelumnya) -->
  <div class="mb-3 row align-items-end">
    <div class="col-auto">
      <label class="form-label">Mode</label><br />
      <select id="shiftInput" class="form-select w-auto d-inline-block">
        <option value="">Pilih Shift</option>
        <option value="IDX">Index hari ini</option>
        <option value="P">P (Pagi)</option>
        <option value="S">S (Siang)</option>
        <option value="M">M (Malam)</option>
        <option value="MH1">M H-1 (Malam H-1)</option>
      </select>
      <div id="modeNote" class="form-text text-muted mt-1"></div>
    </div>

    <div class="col-md-5">
      <label class="form-label">&nbsp;</label><br />
      <button id="ambilNamaBtn" class="btn btn-primary">Generate Jadwal</button>
    </div>

    <div class="col-md-4 text-end">
      <label class="form-label">Tanggal dicek:</label>
      <p id="tanggalCek"></p>
    </div>
  </div>

  <hr>

  <div class="mb-3">
    <label class="form-label">Upload CSV</label>
    <input type="file" id="csvFile" class="form-control" accept=".csv" />
  </div>

  <button id="generateBtn" class="btn btn-success mb-1" disabled>Hitung Index</button>
  <span id="statusText" class="ms-2 text-muted"></span>

  <div class="form-check mt-2">
    <input class="form-check-input" type="checkbox" id="toggleSiang14" disabled>
    <label class="form-check-label text-muted" for="toggleSiang14" id="labelToggleSiang14">
      Hitung Siang mulai ≥ 13:00
    </label>
  </div>

  <div id="judulLaporan" class="mt-2"></div>

  <div id="resultArea" class="mt-2">
    <table id="resultTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th id="sortNama">Nama Karyawan</th>
          <th>Shift</th>
          <th id="sortLastCO">LastCO</th>
          <th id="sortIndexCO">IndexCO</th>
          <th id="sortTotalCO">TotalCO</th>
          <th id="sortSLA">SLA</th>
          <th id="sortInProgress">InProgress</th>
          <th id="sortRelasiResolved">RelasiResolved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button id="historyBtn" class="btn btn-secondary">History</button>
    <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ----- (Saya tidak ubah bagian lainnya — pertahankan fungsi Anda) ----- */
/* Hanya pastikan renderTable seperti di bawah ini (paste menggantikan fungsi renderTable lama) */

function renderTable(results){
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  results.forEach((item, index) => {
    const { k, res } = item;

    // Normalize avg: handle numbers, strings with comma, null/undefined
    let avgNum = null;
    if (res && res.avg !== null && res.avg !== undefined && res.avg !== "") {
      // convert anything like "0,36" -> "0.36" then Number()
      const raw = String(res.avg).trim().replace(/\s+/g, "");
      avgNum = Number(raw.replace(",", "."));
      if (Number.isNaN(avgNum)) avgNum = null;
    }

    const avg = (avgNum !== null) ? (Math.round(avgNum * 100) / 100).toFixed(2) : "-";

    const tr = document.createElement("tr");

    // Prioritas: merah bila ada SLA lewat
    if (res && (res.slaCount || 0) > 0) {
      tr.classList.add("table-danger");
    } else if (avgNum !== null && avgNum > 0.35) {
      // Oranye jika avg > 0.35 (bukan >=)
      tr.classList.add("table-index-warning");
    }

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${k.nama}</td>
      <td>${k.shift || '-'}</td>
      <td>${res.lastTime}</td>
      <td>${avg}</td>
      <td>${res.count || 0}</td>
      <td>${res.slaCount || 0}</td>
      <td>${res.inProgressCount || 0}</td>
      <td>${res.relasiResolved || 0}</td>
    `;

    tbody.appendChild(tr);
  });

  // reattach sorting handlers if needed (sama seperti sblmnya)
  ["Nama","LastCO","IndexCO","TotalCO","SLA","InProgress","RelasiResolved"].forEach(k=>{
    const el = document.getElementById(`sort${k}`);
    if (el) el.onclick = () => sortColumn(k);
  });
}

/* ----- Sisanya: biarkan fungsi Anda yang sudah ada sebelumnya (CSV parse, compute, generateBtn, dll.) ----- */
/* Pastikan tidak ada fungsi renderTable ganda; hanya gunakan fungsi di atas. */
</script>

</body>
</html>
