<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>

  <!-- Favicon & Apple touch (data-URL SVG, bundar merah dengan teks putih "R3") -->
  <!-- Data-URL menggunakan SVG inline; jika browser cache lama favicon, refresh / buka incognito -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='32' fill='%23b71c1c'/><text x='50%25' y='50%25' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='28' text-anchor='middle' dominant-baseline='central'>R3</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='32' fill='%23b71c1c'/><text x='50%25' y='50%25' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='28' text-anchor='middle' dominant-baseline='central'>R3</text></svg>">
  <meta name="theme-color" content="#1976d2">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 0; 
                 box-shadow: 0 2px 6px rgba(0,0,0,0.1); overflow: hidden; }

    /* Top header area (mirip contoh biru) */
    .site-top {
      background: linear-gradient(#2286d2, #1976d2);
      color: #fff;
      padding: 18px 22px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .site-top h1 { margin:0; font-size:20px; font-weight:700; letter-spacing:0.5px; }
    .site-top .logo-circle {
      width:44px; height:44px; border-radius:50%;
      display:inline-block; overflow:hidden; flex:0 0 44px; align-items:center; justify-content:center;
    }
    .site-top .logo-circle img { width:100%; height:100%; object-fit:cover; display:block; }

    .content-area { padding:20px 25px; }

    #judulLaporan { font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 8px; color:#000; }
    #judulLaporan.is-history { color: #8e24aa; }
    #resultTable td { text-align: center; vertical-align: middle; font-size: 0.95rem; }

    /* Header tabel biru + teks putih, dan align center */
    #resultTable.table thead tr th {
      background-color: #1976d2 !important;
      color: #fff !important;
      text-align: center !important;
      font-weight: 700;
      cursor: pointer;
      padding: 10px;
      user-select: none;
      vertical-align: middle;
      border-color: #1565c0 !important;
    }
    #resultTable.table thead tr th:hover { background-color: #1565c0 !important; }

    /* Header abu-abu saat lihat HISTORY */
    #resultArea.is-history thead tr th {
      background-color: #9e9e9e !important;
      border-color: #757575 !important;
      color: #fff !important;
    }

    /* Merah bila ada SLA lewat (prioritas) */
    .table-danger td {
      background-color: #ffeaea !important;
      color: #000 !important;
    }

    /* Oranye/kuning untuk index > 0.35 pada seluruh baris */
    .table-index-warning td {
      background-color: #ffcc80 !important; /* oranye-kuning */
      color: #000 !important;
    }

    /* kecilkan spasi panah supaya rapi */
    .hdr-arrow { font-weight: 700; margin-left: 6px; font-size: 0.9em; }

    /* buat ikon/logo di tabel header tetap clickable area */
    #resultTable thead th { white-space: nowrap; }

    /* footer */
    #copyright { text-align: center; font-size: 13px; color: #666; margin: 18px 0; padding-bottom: 14px; }

    /* responsive tweaks */
    @media (max-width: 600px){
      .site-top h1 { font-size:16px; }
      .site-top { padding:12px; gap:10px; }
      .content-area { padding:12px; }
    }
  </style>
</head>

<body>
<div class="container">
  <!-- top blue header with circular logo (embedded SVG data URL) -->
  <div class="site-top">
    <div class="logo-circle">
      <img alt="logo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='32' fill='%23b71c1c'/><text x='50%25' y='50%25' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='28' text-anchor='middle' dominant-baseline='central'>R3</text></svg>">
    </div>
    <h1>LAPORAN</h1>
  </div>

  <div class="content-area">
    <p style="margin:0 0 12px 0;color:#333">Pilih shift → Generate Jadwal → Upload CSV → Hitung Index</p>

    <div class="mb-3 row align-items-end">
      <div class="col-auto">
        <label class="form-label">Mode</label><br />
        <select id="shiftInput" class="form-select w-auto d-inline-block">
          <option value="">Pilih Shift</option>
          <option value="IDX">Index hari ini</option>
          <option value="P">P (Pagi)</option>
          <option value="S">S (Siang)</option>
          <option value="M">M (Malam)</option>
          <option value="MH1">M H-1 (Malam H-1)</option>
        </select>
        <div id="modeNote" class="form-text text-muted mt-1"></div>
      </div>

      <div class="col-md-5">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Generate Jadwal</button>
      </div>

      <div class="col-md-4 text-end">
        <label class="form-label">Tanggal dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-1" disabled>Hitung Index</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <!-- Toggle hanya aktif saat S -->
    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" id="toggleSiang14" disabled>
      <label class="form-check-label text-muted" for="toggleSiang14" id="labelToggleSiang14">
        Hitung Siang mulai ≥ 13:00
      </label>
    </div>

    <div id="judulLaporan" class="mt-2"></div>

    <div id="resultArea" class="mt-2">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">Relasi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button id="historyBtn" class="btn btn-secondary">History</button>
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

  <div id="copyright">
    © 2025 EDP Fai
  </div>
</div>

<!-- Modal History -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">History Laporan (10 terakhir)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div id="historyList" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ====== KONFIG / STATE ====== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";
const HISTORY_GAS_URL = "https://script.google.com/macros/s/AKfycbwrXZlIB4nyiQtb-MM79c8rm1rDuoVyEZRxdk4-yTHaM_teOWR-XxC_BK50RsVlmo-P/exec";

let sheetData = [], csvData = [], lastResults = [];
let shiftLabel = "";

let sortAscNama=true, sortAscLastCO=false, sortAscIndexCO=false, sortAscTotalCO=true,
    sortAscSLA=false, sortAscInProgress=false, sortAscRelasiResolved=false;

/* store original header innerHTML so sorting won't clobber labels */
const originalHeaderText = {};

/* ====== INIT ====== */
document.getElementById("tanggalCek").textContent = new Date().toLocaleDateString("id-ID", {day:"numeric",month:"long",year:"numeric"});

/* ====== UTIL ====== */
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){
  if(!v) return 0;
  const s = v.toString().trim();
  const m1 = s.match(/(\d+) d (\d{1,2}):(\d{2}):(\d{2})/i);
  if(m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
  const m2 = s.match(/(\d{1,2}):(\d{2}):(\d{2})/);
  if(m2) return (+m2[1])*3600 + (+m2[2])*60 + (+m2[3]);
  return 0;
}
function normalizeStatus(s){ if(!s) return ""; return String(s).replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }
function isAcceptedStatus(norm){ return norm.includes("resolved")||norm.includes("closed")||norm.includes("inprogress")||norm.includes("in progress")||norm.includes("pending"); }
function ambilJamDariTanggal(s){ if(!s) return "-"; const m = s.match(/(\d{1,2}):(\d{2})/); return m?`${m[1].padStart(2,'0')}:${m[2]}`:"-"; }
function jamMenitDariTanggal(s){ const m = (s||"").match(/(\d{1,2}):(\d{2})(?::\d{2}(?:\.\d+)?)?/); if(!m) return null; return { h: parseInt(m[1],10), m: parseInt(m[2],10) }; }
function prettyTanggalLabel(value){ if(typeof value === "string" && value.includes("T")){ const d = new Date(value); if(!isNaN(d)) return d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});} if(typeof value === "number"){ const d = new Date(value); if(!isNaN(d)) return d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});} return String(value||""); }
function prettyDateTime(ts){ const d=new Date(ts); return d.toLocaleString("id-ID",{ day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" }); }

/* ====== FILTER SIANG >=13:00 (toggle) ====== */
function lolosFilterShiftSiangByTanggalDiambil(record){
  const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
  if(shift !== "S") return true;
  const useSiang = document.getElementById("toggleSiang14")?.checked;
  if(!useSiang) return true;
  const sumber = record.tanggalDiambil || "";
  const t = jamMenitDariTanggal(sumber);
  if(!t) return false;
  if(t.h > 13) return true;
  if(t.h === 13 && t.m >= 0) return true;
  return false;
}

/* ====== HISTORY API ====== */
async function saveHistoryEntry(entry){
  const compactResults = (entry.results || []).map(x => ({
    k: { nama: x.k?.nama || "", shift: x.k?.shift || "" },
    res:{
      avg: x.res?.avg ?? null,
      count: x.res?.count ?? 0,
      lastTime: x.res?.lastTime ?? "-",
      slaCount: x.res?.slaCount ?? 0,
      inProgressCount: x.res?.inProgressCount ?? 0,
      relasiResolved: x.res?.relasiResolved ?? 0
    }
  }));
  const payload = { action: "saveHistory", data: { ts: entry.ts, mode: entry.mode, shiftLabel: entry.shiftLabel, tanggal: entry.tanggal, toggleSiang14: entry.toggleSiang14, results: compactResults } };
  try {
    const res = await fetch(HISTORY_GAS_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    await res.text();
  } catch(e) {
    console.warn("saveHistoryEntry failed:", e);
  }
}
async function loadHistory(){
  const url = `${HISTORY_GAS_URL}?action=getHistory`;
  const res = await fetch(url);
  const json = await res.json();
  return (json.items||[]).map(h => ({
    ts: h.ts, mode: h.mode, shiftLabel: h.shiftLabel, tanggal: h.tanggal, toggleSiang14: h.toggleSiang14,
    results: (h.rows||[]).map(r => ({ k: { nama: r.nama, shift: r.shift }, res: { avg: r.avg, count: r.count, lastTime: r.lastTime, slaCount: r.slaCount, inProgressCount: r.inProgressCount, relasiResolved: r.relasiResolved } }))
  }));
}
function showHistoryModal(){ renderHistoryList(); const modal = new bootstrap.Modal(document.getElementById("historyModal")); modal.show(); }
async function renderHistoryList(){
  const list = document.getElementById("historyList");
  list.innerHTML = '<div class="text-muted">Memuat...</div>';
  try{
    const arr = await loadHistory();
    if(!arr.length){ list.innerHTML = '<div class="text-muted">Belum ada history.</div>'; return; }
    list.innerHTML = "";
    arr.forEach(h=>{
      const btn = document.createElement("button");
      btn.type="button";
      btn.className="list-group-item list-group-item-action";
      const modeLabel = (h.mode==="IDX") ? "Index hari ini" : h.shiftLabel;
      btn.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${modeLabel}</h6><small>${prettyDateTime(h.ts)}</small></div><div class="mb-1">Tanggal: ${prettyTanggalLabel(h.tanggal)} • Personil: ${h.results?.length||0}</div>`;
      btn.addEventListener("click", ()=>{
        lastResults = h.results || [];
        renderTable(lastResults);
        const judul = document.getElementById("judulLaporan");
        judul.classList.add("is-history");
        document.getElementById("resultArea").classList.add("is-history");
        judul.textContent = (h.mode==="IDX") ? `[HISTORY] Laporan Index CO — Index Hari Ini — Tanggal ${prettyTanggalLabel(h.tanggal)}` : `[HISTORY] Laporan Index CO ${h.shiftLabel} — Tanggal ${prettyTanggalLabel(h.tanggal)}`;
        document.getElementById("statusText").textContent = `Ditampilkan dari history (${prettyDateTime(h.ts)}).`;
        bootstrap.Modal.getInstance(document.getElementById("historyModal"))?.hide();
      });
      list.appendChild(btn);
    });
  }catch(err){
    list.innerHTML = `<div class="text-danger">Gagal memuat history: ${err.message}</div>`;
  }
}

/* ====== CSV LOAD ====== */
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file = e.target.files[0]; if(!file) return;
  Papa.parse(file,{header:true,delimiter:";",skipEmptyLines:true,
    complete:(res)=>{
      const headerMap={}; (res.meta.fields||[]).forEach(f=>headerMap[normKey(f)]=f);
      const getCol = (row,arr)=>{
        for(const c of arr){ for(const key in headerMap){ if(key.includes(c)){ const realKey=headerMap[key]; if(row[realKey]) return row[realKey].toString(); } } }
        return "";
      };
      csvData = res.data.map(r=>{
        const diambilOleh = getCol(r,['diambiloleh','diambil oleh']);
        const durasiRaw = getCol(r,['durasikomplain','durasi']);
        const waktuSlaRaw = getCol(r,['waktusla','waktu sla']);
        const statusRaw = getCol(r,['statuskomplain','status']);
        const statusSlaRaw = getCol(r,['statussla','status sla']);
        const tglDiambilRaw = getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
        const tipeLokasiRaw = getCol(r,['tipelokasiasal','tipe lokasi asal']);
        const slaNum = parseFloat((waktuSlaRaw||"").replace(",","."))||0;
        return {
          diambilOleh,
          durasiRaw,
          durasiDetik: durasiKeDetik(durasiRaw),
          waktuSlaDetik: slaNum*3600,
          status: statusRaw,
          statusNorm: normalizeStatus(statusRaw),
          statusSLA: statusSlaRaw,
          tanggalDiambil: tglDiambilRaw,
          tipeLokasi: (tipeLokasiRaw||"").trim()
        };
      });

      const mode = document.getElementById("shiftInput").value.trim().toUpperCase();
      if(mode==="IDX"){
        sheetData = buildUniqueNamesFromCSV(csvData);
        document.getElementById("generateBtn").disabled = sheetData.length===0;
        document.getElementById("modeNote").textContent = sheetData.length ? " " : "(Mode Index) Tidak ada nama pada kolom 'Diambil oleh'.";
      }
      document.getElementById("statusText").textContent = `File CSV terbaca: ${csvData.length} baris.`;
    }});
});

/* ====== BUILD NAMA (MODE IDX) ====== */
function buildUniqueNamesFromCSV(rows){
  const map=new Map();
  for(const r of rows){
    const raw=(r.diambilOleh||"").trim();
    if(!raw) continue;
    const key=normalizeName(raw);
    if(!map.has(key)) map.set(key, raw);
  }
  return Array.from(map.values()).map(nm=>({nama:nm, nik:'', shift:'Index'}));
}

/* ====== AMBIL NAMA DARI GSHEET ====== */
document.getElementById("ambilNamaBtn").addEventListener("click", async ()=>{
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!shiftInput){ alert("Pilih mode dulu!"); return; }
  if(shiftInput==="IDX"){ document.getElementById("statusText").textContent="Mode IDX: upload CSV lalu Hitung Index."; return; }

  document.getElementById("statusText").textContent="Mengambil data dari GSheet...";
  try{
    const now = new Date();
    let tanggalLabel;
    if(shiftInput==="MH1"){ const y=new Date(now); y.setDate(now.getDate()-1); tanggalLabel = y.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}); }
    else tanggalLabel = now.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    document.getElementById("tanggalCek").textContent = tanggalLabel;

    let shifts=[shiftInput];
    if(shiftInput==="P") shifts = ["P","P1"];
    const shiftMap={P:"Shift 1",S:"Shift 2",M:"Shift 3",MH1:"Shift 3"};
    shiftLabel = shiftMap[shiftInput] || shiftInput;

    sheetData = [];
    for(const s of shifts){
      const url = `${GAS_URL}?shift=${encodeURIComponent(s)}`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Gagal ambil data GSheet");
      const list = (data.karyawan||[]).map(k=>({nama:(k.nama||"").trim(), nik:(k.nik||"").trim(), shift:(k.shift||"").trim()}));
      sheetData = sheetData.concat(list);
    }
    sheetData = sheetData.filter((obj,idx,arr)=> idx===arr.findIndex(t=>t.nama===obj.nama));
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("statusText").textContent = `✅ ${sheetData.length} nama berhasil diambil (${shiftLabel}).`;
  }catch(err){
    console.error(err);
    alert("Gagal mengambil data: " + err.message);
    document.getElementById("statusText").textContent = "❌ Gagal mengambil data dari GSheet.";
  }
});

/* ====== PERHITUNGAN ====== */
function computeC(r){ return r.waktuSlaDetik>0 ? r.durasiDetik / r.waktuSlaDetik : 0; }
function rataRata_byName(nama,thr=0.85){
  const matches=[];
  const keyNama = normalizeName(nama);
  for(const r of csvData){
    if(!isAcceptedStatus(r.statusNorm)) continue;
    if(r.tipeLokasi && r.tipeLokasi.trim().toLowerCase()==="branch") continue;
    if(!lolosFilterShiftSiangByTanggalDiambil(r)) continue;
    const currentShift = document.getElementById("shiftInput").value.trim().toUpperCase();
    if(currentShift==="IDX"){
      if(normalizeName(r.diambilOleh) !== keyNama) continue;
    }else{
      if(similarity(nama, r.diambilOleh) < thr) continue;
    }
    matches.push(r);
  }
  if(!matches.length) return { avg:null, count:0, lastTime:"-", slaCount:0, inProgressCount:0, relasiResolved:0 };
  const sum = matches.reduce((a,b)=>a+computeC(b),0);
  const latest = matches.map(r=>r.tanggalDiambil).filter(Boolean).sort().pop();
  return {
    avg: sum / matches.length,
    count: matches.length,
    lastTime: ambilJamDariTanggal(latest),
    slaCount: matches.filter(r=>r.statusSLA && r.statusSLA.toLowerCase().includes("lewat")).length,
    inProgressCount: matches.filter(r=>r.statusNorm.includes("inprogress")||r.statusNorm.includes("in progress")).length,
    relasiResolved: matches.filter(r=>r.statusNorm.includes("pending")).length
  };
}

/* simple levenshtein/similarity */
function levenshtein(a,b){ a=a||""; b=b||""; const al=a.length, bl=b.length; if(!al) return bl; if(!bl) return al;
  const dp=Array.from({length:al+1},()=>Array(bl+1).fill(0));
  for(let i=0;i<=al;i++) dp[i][0]=i; for(let j=0;j<=bl;j++) dp[0][j]=j;
  for(let i=1;i<=al;i++) for(let j=1;j<=bl;j++) dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1] + (a[i-1]===b[j-1]?0:1));
  return dp[al][bl];
}
function similarity(a,b){ a=normalizeName(a); b=normalizeName(b); if(!a||!b) return 0; const d=levenshtein(a,b); return 1 - d / Math.max(a.length,b.length); }

/* ====== HITUNG & RENDER TABEL (Generate Button) ====== */
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  const mode = document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!csvData.length) return alert("Upload CSV dulu!");
  if(mode==="IDX"){
    if(!sheetData.length) sheetData = buildUniqueNamesFromCSV(csvData);
    if(!sheetData.length){ alert('Tidak ada nama pada kolom "Diambil oleh" di CSV.'); return; }
    shiftLabel = "Index Hari Ini";
  } else {
    if(!sheetData.length) return alert("Klik 'Generate Jadwal' dulu untuk ambil nama dari GSheet.");
    const shiftMap={P:"Shift 1",S:"Shift 2",M:"Shift 3",MH1:"Shift 3"};
    shiftLabel = shiftMap[mode] || mode;
  }

  let results = sheetData.map(k => ({ k, res: rataRata_byName(k.nama) }));

  if(mode==="IDX"){
    results.sort((a,b)=> {
      const av = a.res.avg === null ? -Infinity : a.res.avg;
      const bv = b.res.avg === null ? -Infinity : b.res.avg;
      return bv - av;
    });
    setHeaderArrow('sortIndexCO', '↓');
    sortAscIndexCO = false;
  }

  lastResults = results;
  renderTable(results);

  const tgl = document.getElementById("tanggalCek").textContent;
  const judul = document.getElementById("judulLaporan");
  judul.classList.remove("is-history");
  document.getElementById("resultArea").classList.remove("is-history");
  judul.textContent = (mode==="IDX") ? `Laporan Index CO — Index Hari Ini — Tanggal ${tgl}` : `Laporan Index CO ${shiftLabel} — Tanggal ${tgl}`;
  document.getElementById("statusText").textContent = "✅ Perhitungan selesai.";

  try{
    saveHistoryEntry({ ts: Date.now(), mode, shiftLabel, tanggal: tgl, toggleSiang14: document.getElementById("toggleSiang14").checked, results });
  }catch(e){
    console.warn("Gagal simpan history:", e);
  }
});

/* ====== RENDER TABEL ====== */
function renderTable(results){
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  results.forEach((item, index) => {
    const { k, res } = item;

    // normalize avg to Number or null (handle strings like "0,36")
    let avgNum = null;
    if (res && res.avg !== null && res.avg !== undefined && res.avg !== "") {
      const raw = String(res.avg).trim().replace(/\s+/g,"");
      avgNum = Number(raw.replace(",", "."));
      if(Number.isNaN(avgNum)) avgNum = null;
    }

    const avg = (avgNum !== null) ? (Math.round(avgNum * 100) / 100).toFixed(2) : "-";

    const tr = document.createElement("tr");

    // Prioritaskan merah bila ada SLA lewat
    if (res && (res.slaCount || 0) > 0) {
      tr.classList.add("table-danger");
    } else if (avgNum !== null && avgNum > 0.35) {
      // oranye bila avg > 0.35 (bukan >=)
      tr.classList.add("table-index-warning");
    }

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${k.nama}</td>
      <td>${k.shift || '-'}</td>
      <td>${res.lastTime}</td>
      <td>${avg}</td>
      <td>${res.count || 0}</td>
      <td>${res.slaCount || 0}</td>
      <td>${res.inProgressCount || 0}</td>
      <td>${res.relasiResolved || 0}</td>
    `;
    tbody.appendChild(tr);
  });

  // reattach sorting handlers
  ["Nama","LastCO","IndexCO","TotalCO","SLA","InProgress","RelasiResolved"].forEach(k=>{
    const el = document.getElementById(`sort${k}`);
    if(el) el.onclick = () => sortColumn(k);
  });
}

/* ====== SORTING ====== */
/* Helper: reset all headers to original, then set arrow on one */
function resetAllHeaderArrows(){
  Object.keys(originalHeaderText).forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.innerHTML = originalHeaderText[id];
  });
}
function setHeaderArrow(headerId, arrow){
  resetAllHeaderArrows();
  const el = document.getElementById(headerId);
  if(!el) return;
  const orig = originalHeaderText[headerId] || el.innerHTML;
  el.innerHTML = orig + `<span class="hdr-arrow">${arrow}</span>`;
}

function sortColumn(key){
  if(!lastResults.length) return alert("Belum ada data tabel.");
  let asc, valFunc, headerId = `sort${key}`;
  switch(key){
    case "Nama": asc=sortAscNama; valFunc=r=> (r.k.nama||"").toLowerCase(); sortAscNama=!sortAscNama; break;
    case "LastCO": asc=sortAscLastCO; valFunc=r=> r.res.lastTime==="-"?0:parseInt(r.res.lastTime.replace(":","")); sortAscLastCO=!sortAscLastCO; break;
    case "IndexCO": asc=sortAscIndexCO; valFunc=r=> r.res.avg || 0; sortAscIndexCO=!sortAscIndexCO; break;
    case "TotalCO": asc=sortAscTotalCO; valFunc=r=> r.res.count || 0; sortAscTotalCO=!sortAscTotalCO; break;
    case "SLA": asc=sortAscSLA; valFunc=r=> r.res.slaCount || 0; sortAscSLA=!sortAscSLA; break;
    case "InProgress": asc=sortAscInProgress; valFunc=r=> r.res.inProgressCount || 0; sortAscInProgress=!sortAscInProgress; break;
    case "RelasiResolved": asc=sortAscRelasiResolved; valFunc=r=> r.res.relasiResolved || 0; sortAscRelasiResolved=!sortAscRelasiResolved; break;
    default: return;
  }

  if(key==="Nama") lastResults.sort((a,b)=> asc? valFunc(a).localeCompare(valFunc(b)) : valFunc(b).localeCompare(valFunc(a)));
  else lastResults.sort((a,b)=> asc? (valFunc(a)-valFunc(b)) : (valFunc(b)-valFunc(a)));
  renderTable(lastResults);

  // update header arrows without changing original labels
  setHeaderArrow(headerId, asc ? "↑" : "↓");
}

/* ====== DOWNLOAD JPG ====== */
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const area = document.querySelector("#resultArea");
  const canvas = await html2canvas(area, { scale: 2 });
  const link = document.createElement("a");
  link.download = "Laporan_Index_Shift.jpg";
  link.href = canvas.toDataURL("image/jpeg");
  link.click();
});

/* ====== UI helper for toggle siang and button states ====== */
function updateToggleSiangAvailability(){
  const mode = document.getElementById("shiftInput").value.trim().toUpperCase();
  const cb = document.getElementById("toggleSiang14");
  const label = document.getElementById("labelToggleSiang14");
  const btnGsheet = document.getElementById("ambilNamaBtn");
  const note = document.getElementById("modeNote");
  const isSiang = (mode === "S");

  cb.disabled = !isSiang;
  // auto-check when Siang and current hour >=13
  const nowHour = new Date().getHours();
  cb.checked  = isSiang && (nowHour >= 13);

  label.classList.toggle("text-muted", !isSiang);
  cb.title = isSiang ? "Jika aktif → hitung siang mulai jam 13:00" : (mode==="IDX" ? "Tidak berlaku pada mode Index hari ini" : "Tidak berlaku untuk shift selain Siang (S)");

  if(mode==="IDX"){
    btnGsheet.disabled = true;
    document.getElementById("generateBtn").disabled = sheetData.length===0;
  } else if(mode){
    btnGsheet.disabled = false;
    btnGsheet.title = "Ambil nama dari GSheet";
    note.textContent = "";
    document.getElementById("generateBtn").disabled = true;
  } else {
    btnGsheet.disabled = false;
    btnGsheet.title = "Pilih mode terlebih dahulu";
    note.textContent = "";
    document.getElementById("generateBtn").disabled = true;
  }
}

/* ====== EVENTS ====== */
document.getElementById("historyBtn").addEventListener("click", showHistoryModal);

document.getElementById("shiftInput").addEventListener("change", ()=>{
  updateToggleSiangAvailability();
  const mode = document.getElementById("shiftInput").value.trim().toUpperCase();
  if(mode==="IDX"){
    if(csvData.length){
      sheetData = buildUniqueNamesFromCSV(csvData);
      document.getElementById("generateBtn").disabled = sheetData.length===0;
    } else {
      document.getElementById("generateBtn").disabled = true;
    }
  } else {
    document.getElementById("generateBtn").disabled = true;
  }
});

/* === ensure initial UI state === */
document.addEventListener("DOMContentLoaded", ()=> {
  // save original header innerHTMLs so we can restore labels later
  document.querySelectorAll('#resultTable thead th[id]').forEach(th=>{
    originalHeaderText[th.id] = th.innerHTML;
  });
  updateToggleSiangAvailability();
});
</script>
</body>
</html>
