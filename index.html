<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Hitung Index Komplain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <h3 class="mb-3 text-center">ðŸ“Š Hitung Index Komplain</h3>

  <div class="mb-3">
    <label class="form-label">Upload File CSV (delimiter ;):</label>
    <input type="file" id="csvFile" accept=".csv" class="form-control">
  </div>

  <div class="mb-3">
    <label class="form-label">Total Shift Aktif:</label>
    <input type="number" id="totalShift" class="form-control" placeholder="Masukkan total shift aktif (mis. 40)">
  </div>

  <button class="btn btn-primary w-100" onclick="prosesCSV()">Proses File</button>

  <div id="hasil" class="mt-4"></div>

  <script>
    function prosesCSV() {
      const file = document.getElementById('csvFile').files[0];
      const totalShift = parseFloat(document.getElementById('totalShift').value);
      if (!file) return alert("Pilih file CSV terlebih dahulu!");
      if (!totalShift || totalShift <= 0) return alert("Masukkan total shift aktif yang valid!");

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/).filter(r => r.trim() !== "");
        const headers = lines[0].split(";").map(h => h.trim());
        const data = lines.slice(1).map(line => line.split(";").map(c => c.trim()));

        const idxNik = headers.indexOf("NIK Pengambil");
        const idxStatus = headers.indexOf("Status Komplain");

        if (idxNik === -1 || idxStatus === -1) {
          alert("Kolom 'NIK Pengambil' atau 'Status Komplain' tidak ditemukan!");
          return;
        }

        const hasilMap = {};

        data.forEach(row => {
          const nik = row[idxNik];
          const status = row[idxStatus].toUpperCase();

          if (["RESOLVED", "CLOSED", "IN PROGRESS"].includes(status)) {
            if (!hasilMap[nik]) hasilMap[nik] = { total: 0 };
            hasilMap[nik].total += 1;
          }
        });

        let html = `
          <table class="table table-bordered table-striped mt-3">
            <thead class="table-dark">
              <tr>
                <th>No</th>
                <th>NIK</th>
                <th>Total Komplain</th>
                <th>Index</th>
              </tr>
            </thead>
            <tbody>
        `;

        let no = 1;
        for (const [nik, val] of Object.entries(hasilMap)) {
          const index = (val.total / totalShift).toFixed(4);
          html += `
            <tr>
              <td>${no++}</td>
              <td>${nik}</td>
              <td>${val.total}</td>
              <td>${index}</td>
            </tr>
          `;
        }

        html += "</tbody></table>";
        document.getElementById('hasil').innerHTML = html;
      };

      reader.readAsText(file);
    }
  </script>
</body>
</html>
