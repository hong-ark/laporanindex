<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background:#f6f7fb; padding:20px; }
    .container {
      max-width:1100px; background:white; border-radius:10px; padding:25px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    table { font-size:15px; }
    #resultTable thead { background:#e3f2fd; }
    #resultTable th {
      color:#000; text-align:center; font-weight:700;
      padding:10px 8px; border-bottom:2px solid #bbdefb;
      cursor:pointer; transition:background 0.2s ease;
    }
    #resultTable th:hover { background:#bbdefb; }
    #resultTable td { text-align:center; vertical-align:middle; }
  </style>
</head>
<body>
<div class="container">
  <h4><b>Laporan Index Shift</b></h4>
  <p>Input shift → Ambil nama dari GSheet → Upload CSV dari WEB CO → Generate Tabel.</p>

  <div class="mb-3 row">
    <div class="col-md-2">
      <label class="form-label">Shift</label>
      <select id="shiftInput" class="form-select">
        <option value="">Pilih Shift</option>
        <option value="M">M (Malam)</option>
        <option value="MH1">M H-1 (Malam H-1)</option>
        <option value="S">S (Siang)</option>
        <option value="P">P (Pagi)</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">&nbsp;</label><br />
      <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
    </div>
    <div class="col-md-6 text-end">
      <label class="form-label">Tanggal yang dicek:</label>
      <p id="tanggalCek"></p>
    </div>
  </div>
  <hr />

  <div class="mb-3">
    <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
    <input type="file" id="csvFile" class="form-control" accept=".csv" />
    <small class="text-muted">
      Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, 
      Tanggal Diambil, Diambil Oleh, Dibuat Oleh).
    </small>
  </div>

  <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
  <span id="statusText" class="ms-2 text-muted"></span>

  <div id="resultArea" class="mt-4">
    <table id="resultTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th>Nama Karyawan</th>
          <th>Shift</th>
          <th>LastCO</th>
          <th>IndexCO</th>
          <th>TotalCO</th>
          <th>SLA</th>
          <th>InProgress</th>
          <th>RelasiResolved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="text-end mt-3">
    <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";

let sheetData = [];
let csvData = [];
let lastResults = [];

// tampilkan tanggal default hari ini
document.getElementById("tanggalCek").textContent =
  new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});

// tombol ambil nama
document.getElementById("ambilNamaBtn").addEventListener("click", async()=>{
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!shiftInput) return alert("Masukkan shift (M, P, atau S)");
  document.getElementById("statusText").textContent="Mengambil data dari Google Sheet...";

  try {
    let shifts=[shiftInput];
    if(shiftInput==="P") shifts=["P","P1"];

    const today=new Date();
    let tanggal;
    if(shiftInput==="MH1"){
      const yesterday=new Date(today);
      yesterday.setDate(today.getDate()-1);
      tanggal=yesterday.toISOString().split("T")[0];
      document.getElementById("tanggalCek").textContent=
        yesterday.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    } else {
      tanggal=today.toISOString().split("T")[0];
      document.getElementById("tanggalCek").textContent=
        today.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    }

    sheetData=[];
    for(const s of shifts){
      const url=`${GAS_URL}?shift=${encodeURIComponent(s)}&tanggal=${encodeURIComponent(tanggal)}`;
      const res=await fetch(url);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      const list=(data.karyawan||[]).map(k=>({
        nama:k.nama, shift:k.shift
      }));
      sheetData=sheetData.concat(list);
    }

    // filter unik nama
    sheetData=sheetData.filter((obj,idx,arr)=>idx===arr.findIndex(t=>t.nama===obj.nama));
    document.getElementById("statusText").textContent=`✅ ${sheetData.length} nama berhasil diambil dari GSheet.`;
    document.getElementById("generateBtn").disabled=false;
  }catch(err){
    console.error(err);
    alert("Gagal memanggil API: "+err.message);
    document.getElementById("statusText").textContent="❌ Gagal mengambil data dari GSheet.";
  }
});

// handle upload CSV
document.getElementById("csvFile").addEventListener("change",function(e){
  const file=e.target.files[0];
  if(!file) return;
  Papa.parse(file,{
    header:true, skipEmptyLines:true,
    complete:function(results){
      csvData=results.data;
      alert("✅ CSV berhasil diunggah. Total baris: "+csvData.length);
    }
  });
});

// generate tabel
document.getElementById("generateBtn").addEventListener("click",()=>{
  if(sheetData.length===0 || csvData.length===0){
    alert("Data GSheet atau CSV belum siap!");
    return;
  }

  const resultBody=document.querySelector("#resultTable tbody");
  resultBody.innerHTML="";
  lastResults=[];

  sheetData.forEach((row,idx)=>{
    const nama=row.nama;
    const shift=row.shift;
    const dataUser=csvData.filter(r=>
      (r["Diambil Oleh"]||"").trim().toLowerCase()===nama.toLowerCase()
    );

    const totalCO=dataUser.length;
    const inProgress=dataUser.filter(r=>r["Status Komplain"]==="In Progress").length;
    const relasiResolved=dataUser.filter(r=>r["Status Komplain"]==="Relasi Resolved").length;
    const sla=dataUser.filter(r=>r["Status SLA"]==="SLA").length;
    const indexCO=dataUser.filter(r=>r["Status Komplain"]==="Index").length;
    const lastCO=(dataUser[dataUser.length-1]?.["Tanggal Diambil"])||"-";

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${nama}</td>
      <td>${shift}</td>
      <td>${lastCO}</td>
      <td>${indexCO}</td>
      <td>${totalCO}</td>
      <td>${sla}</td>
      <td>${inProgress}</td>
      <td>${relasiResolved}</td>
    `;
    resultBody.appendChild(tr);

    lastResults.push({nama,shift,lastCO,indexCO,totalCO,sla,inProgress,relasiResolved});
  });
});

// download hasil tabel jadi JPG
document.getElementById("downloadBtn").addEventListener("click",()=>{
  html2canvas(document.querySelector("#resultArea")).then(canvas=>{
    const link=document.createElement("a");
    link.download="laporan_shift.jpg";
    link.href=canvas.toDataURL("image/jpeg");
    link.click();
  });
});
</script>
</body>
</html>
