<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    table { font-size: 14px; }
    th { cursor: pointer; background-color: #0d6efd; color: white; text-align: center; }
    td { text-align: center; vertical-align: middle; }
  </style>
</head>
<body class="container py-4">
  <h3 class="mb-3 text-center fw-bold">ðŸ“Š Laporan Index Shift (Index terakhir CO)</h3>

  <div class="d-flex gap-2 justify-content-center mb-4 flex-wrap">
    <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet</button>
    <input type="file" id="csvFile" accept=".csv" class="form-control" style="max-width:250px;">
    <button id="generateBtn" class="btn btn-success">Generate Tabel</button>
    <button id="downloadBtn" class="btn btn-warning text-dark">Download JPG</button>
  </div>

  <div class="table-responsive">
    <table id="dataTable" class="table table-bordered table-striped align-middle">
      <thead>
        <tr>
          <th>No</th>
          <th id="sortNama">Nama</th>
          <th>LastCO</th>
          <th id="sortIndexCO">IndexCO</th>
          <th id="sortTotalCO">TotalCO</th>
          <th id="sortSLA">SLA</th>
          <th id="sortInProgress">InProgress</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let csvData = [];
    let namaList = [];
    let sortDirections = {};

    // Ambil data nama dari GSheet
    document.getElementById("ambilNamaBtn").addEventListener("click", () => {
      fetch("https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec")
        .then(r => r.json())
        .then(d => { namaList = d.data || []; })
        .catch(err => console.error("Gagal ambil data:", err));
    });

    // Upload CSV
    document.getElementById("csvFile").addEventListener("change", function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const lines = e.target.result.split("\n").map(l => l.split(","));
        const headers = lines.shift().map(h => h.trim().toLowerCase());
        csvData = lines.map(l => {
          const obj = {};
          headers.forEach((h, i) => obj[h] = (l[i] || "").trim());
          obj.statusNorm = (obj["status komplain"] || "").toLowerCase();
          obj.nik = obj["nik"] || "";
          obj.nama = obj["nama"] || "";
          return obj;
        }).filter(r => r.nik || r.nama);
      };
      reader.readAsText(file);
    });

    // Fungsi bantu
    function isAcceptedStatus(status) {
      return ["resolved","closed","in progress","inprogress","pending"].includes(status);
    }

    function rataRata_byNIK(nik) {
      const rows = csvData.filter(r => r.nik === nik && isAcceptedStatus(r.statusNorm));
      if (rows.length === 0) return null;
      const totalCO = rows.length;
      const lastCO = rows[rows.length-1]?.["waktu sla"] || "-";
      const indexCO = rows.length;
      const sla = rows.filter(r => parseFloat(r["sla"]||0) > 0).length;
      const inProgress = csvData.filter(r => r.nik === nik && r.statusNorm === "inprogress").length;
      return { lastCO, indexCO, totalCO, sla, inProgress };
    }

    // Generate tabel
    document.getElementById("generateBtn").addEventListener("click", () => {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      let no = 1;
      namaList.forEach(n => {
        const nik = n[0];
        const nama = n[1];
        const data = rataRata_byNIK(nik);
        if (data) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${no++}</td>
            <td>${nama}</td>
            <td>${data.lastCO}</td>
            <td>${data.indexCO}</td>
            <td>${data.totalCO}</td>
            <td>${data.sla}</td>
            <td>${data.inProgress}</td>
          `;
          tbody.appendChild(row);
        }
      });

      sortTable("IndexCO", false);
    });

    // Fungsi sort tabel
    function sortTable(columnName, toggle = true) {
      const th = document.getElementById("sort" + columnName);
      const table = document.getElementById("dataTable");
      const rows = Array.from(table.querySelectorAll("tbody tr"));
      const idx = Array.from(th.parentNode.children).indexOf(th);

      if (toggle) sortDirections[columnName] = !sortDirections[columnName];
      const asc = sortDirections[columnName];

      rows.sort((a,b)=>{
        const aText = a.children[idx].textContent.trim();
        const bText = b.children[idx].textContent.trim();
        const aVal = parseFloat(aText) || aText;
        const bVal = parseFloat(bText) || bText;
        return (aVal > bVal ? 1 : -1) * (asc ? 1 : -1);
      });

      const tbody = table.querySelector("tbody");
      rows.forEach(r => tbody.appendChild(r));
    }

    ["Nama","IndexCO","TotalCO","SLA","InProgress"].forEach(col => {
      const el = document.getElementById("sort"+col);
      if (el) el.addEventListener("click", ()=> sortTable(col));
    });

    // Download JPG
    document.getElementById("downloadBtn").addEventListener("click", ()=>{
      html2canvas(document.querySelector("table")).then(canvas=>{
        const link = document.createElement("a");
        link.download = "Laporan_IndexShift.jpg";
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>
</body>
</html>
