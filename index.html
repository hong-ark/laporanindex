<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px;
                 box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    #judulLaporan { font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 15px; color:#000; }
    #judulLaporan.is-history { color: #8e24aa; }
    #copyright { text-align: center; font-size: 14px; color: #000; margin-top: 40px; margin-bottom: 10px; font-weight: 600; }

    #resultTable.table thead tr th {
      background-color: #1976d2 !important; color: white !important; text-align: center;
      font-weight: 700; cursor: pointer; padding: 10px; user-select: none;
      vertical-align: middle; border-color: #1565c0 !important;
    }
    #resultTable.table thead tr th:hover { background-color: #1565c0 !important; }

    #resultArea.is-history thead tr th {
      background-color: #9e9e9e !important;
      border-color: #757575 !important;
      color: #fff !important;
    }

    #resultTable td { text-align: center; vertical-align: middle; font-size: 0.95rem; }
    .table-danger { background-color: #ffeaea !important; }
  </style>
</head>

<body>
<div class="container">
  <h4><b>Laporan Index Shift</b></h4>
  <p>Pilih shift → Generate Jadwal → Upload CSV → Hitung Index</p>

  <div class="mb-3 row align-items-end">
    <div class="col-auto">
      <label class="form-label">Mode</label><br />
      <select id="shiftInput" class="form-select w-auto d-inline-block">
        <option value="">Pilih Shift</option>
        <option value="IDX">Index hari ini</option>
        <option value="P">P (Pagi)</option>
        <option value="S">S (Siang)</option>
        <option value="M">M (Malam)</option>
        <option value="MH1">M H-1 (Malam H-1)</option>
      </select>
      <div id="modeNote" class="form-text text-muted mt-1"></div>
    </div>

    <div class="col-md-5">
      <label class="form-label">&nbsp;</label><br />
      <button id="ambilNamaBtn" class="btn btn-primary">Generate Jadwal</button>
    </div>

    <div class="col-md-4 text-end">
      <label class="form-label">Tanggal dicek:</label>
      <p id="tanggalCek"></p>
    </div>
  </div>

  <hr>

  <div class="mb-3">
    <label class="form-label">Upload CSV</label>
    <input type="file" id="csvFile" class="form-control" accept=".csv" />
  </div>

  <button id="generateBtn" class="btn btn-success mb-1" disabled>Hitung Index</button>
  <span id="statusText" class="ms-2 text-muted"></span>

  <div class="form-check mt-2">
    <input class="form-check-input" type="checkbox" id="toggleSiang14" disabled>
    <label class="form-check-label text-muted" for="toggleSiang14" id="labelToggleSiang14">
      Hitung Siang mulai ≥ 14:00
    </label>
  </div>

  <div id="judulLaporan" class="mt-2"></div>

  <div id="resultArea" class="mt-2">
    <table id="resultTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th id="sortNama">Nama Karyawan</th>
          <th>Shift</th>
          <th id="sortLastCO">LastCO</th>
          <th id="sortIndexCO">IndexCO</th>
          <th id="sortTotalCO">TotalCO</th>
          <th id="sortSLA">SLA</th>
          <th id="sortInProgress">InProgress</th>
          <th id="sortRelasiRslvd">RelasiRslvd</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button id="historyBtn" class="btn btn-secondary">History</button>
    <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
  </div>
</div>

<!-- Modal History -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">History Laporan (10 terakhir)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div id="historyList" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";
const HISTORY_GAS_URL="https://script.google.com/macros/s/AKfycbwrXZlIB4nyiQtb-MM79c8rm1rDuoVyEZRxdk4-yTHaM_teOWR-XxC_BK50RsVlmo-P/exec";

let sheetData=[], csvData=[], lastResults=[];
let shiftLabel="";

/* ================== UTILITAS =================== */
function normalizeName(s){return(s||"").toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim();}
function durasiKeDetik(v){if(!v)return 0;const m=v.match(/(\d{1,2}):(\d{2}):(\d{2})/);return m?(+m[1])*3600+(+m[2])*60+(+m[3]):0;}
function normalizeStatus(s){if(!s)return"";return s.replace(/\s+/g,' ').trim().toLowerCase();}
function isAcceptedStatus(n){return["resolved","closed","inprogress","in progress","pending"].some(x=>n.includes(x));}
function similarity(a,b){a=normalizeName(a);b=normalizeName(b);if(!a||!b)return 0;
  const d=Math.abs(a.length-b.length);return 1-d/Math.max(a.length,b.length);}
function ambilJamDariTanggal(s){const m=s.match(/(\d{1,2}):(\d{2})/);return m?`${m[1].padStart(2,'0')}:${m[2]}`:"-";}
function prettyTanggalLabel(value){const d=new Date(value);return d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});}
function prettyDateTime(ts){const d=new Date(ts);return d.toLocaleString("id-ID",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});}

/* ================== HISTORY =================== */
async function saveHistoryEntry(entry){
  const compactResults=(entry.results||[]).map(x=>({
    k:x.k,res:{
      avg:x.res?.avg??null,
      count:x.res?.count??0,
      lastTime:x.res?.lastTime??"-",
      slaCount:x.res?.slaCount??0,
      inProgressCount:x.res?.inProgressCount??0,
      RelasiRslvd:x.res?.RelasiRslvd??0
    }
  }));
  const payload={action:"saveHistory",data:{...entry,results:compactResults}};
  await fetch(HISTORY_GAS_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});
}

async function loadHistory(){
  const res=await fetch(`${HISTORY_GAS_URL}?action=getHistory`);
  const json=await res.json();
  return (json.items||[]).map(h=>({
    ts:h.ts,mode:h.mode,shiftLabel:h.shiftLabel,tanggal:h.tanggal,toggleSiang14:h.toggleSiang14,
    results:(h.rows||[]).map(r=>({k:{nama:r.nama,shift:r.shift},res:{
      avg:r.avg,count:r.count,lastTime:r.lastTime,slaCount:r.slaCount,inProgressCount:r.inProgressCount,RelasiRslvd:r.RelasiRslvd
    }}))
  }));
}

async function renderHistoryList(){
  const list=document.getElementById("historyList");
  list.innerHTML="<div>Memuat...</div>";
  try{
    const arr=await loadHistory();
    if(!arr.length)return list.innerHTML="<div>Belum ada history.</div>";
    list.innerHTML="";
    arr.forEach(h=>{
      const btn=document.createElement("button");
      btn.className="list-group-item list-group-item-action";
      btn.innerHTML=`<b>${h.shiftLabel}</b><br><small>${prettyDateTime(h.ts)}</small>`;
      btn.onclick=()=>{
        lastResults=h.results||[];
        renderTable(lastResults);
        document.getElementById("judulLaporan").textContent=`[HISTORY] ${h.shiftLabel} (${prettyTanggalLabel(h.tanggal)})`;
        document.getElementById("judulLaporan").classList.add("is-history");
        document.getElementById("resultArea").classList.add("is-history");
        bootstrap.Modal.getInstance(document.getElementById("historyModal")).hide();
      };
      list.appendChild(btn);
    });
  }catch(e){list.innerHTML=`<div class='text-danger'>${e.message}</div>`;}
}

document.getElementById("historyBtn").onclick=()=>{
  renderHistoryList();
  new bootstrap.Modal(document.getElementById("historyModal")).show();
};

/* ================== CSV =================== */
document.getElementById("csvFile").addEventListener("change",e=>{
  const file=e.target.files[0];if(!file)return;
  Papa.parse(file,{header:true,delimiter:";",skipEmptyLines:true,complete:r=>{
    csvData=r.data.map(x=>({
      diambilOleh:x["Diambil oleh"]||x["DiambilOleh"]||"",
      durasiDetik:durasiKeDetik(x["Durasi Komplain"]||""),
      waktuSlaDetik:(parseFloat((x["Waktu SLA"]||"").replace(",","."))||0)*3600,
      statusNorm:normalizeStatus(x["Status Komplain"]||""),
      statusSLA:x["Status SLA"]||"",
      tanggalDiambil:x["Tanggal Diambil"]||"",
      tipeLokasi:(x["Tipe Lokasi Asal"]||"").trim()
    }));
    document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
  }});
});

/* ================== NAMA =================== */
document.getElementById("ambilNamaBtn").onclick=async()=>{
  const shift=document.getElementById("shiftInput").value.trim().toUpperCase();
  if(!shift)return alert("Pilih shift dulu!");
  if(shift==="IDX"){document.getElementById("statusText").textContent="Mode Index: upload CSV lalu langsung hitung.";return;}
  const res=await fetch(`${GAS_URL}?shift=${shift}`);
  const data=await res.json();
  sheetData=(data.karyawan||[]).map(k=>({nama:k.nama,shift:k.shift}));
  document.getElementById("generateBtn").disabled=false;
};

/* ================== PERHITUNGAN =================== */
function computeC(r){return r.waktuSlaDetik>0?r.durasiDetik/r.waktuSlaDetik:0;}
function rataRata_byName(nama){
  const key=normalizeName(nama);
  const match=csvData.filter(r=>normalizeName(r.diambilOleh)===key && isAcceptedStatus(r.statusNorm));
  if(!match.length)return{avg:null,count:0,lastTime:"-",slaCount:0,inProgressCount:0,RelasiRslvd:0};
  const avg=match.reduce((a,b)=>a+computeC(b),0)/match.length;
  const last=match.map(x=>x.tanggalDiambil).sort().pop();
  return{
    avg,count:match.length,lastTime:ambilJamDariTanggal(last),
    slaCount:match.filter(x=>x.statusSLA.toLowerCase().includes("lewat")).length,
    inProgressCount:match.filter(x=>x.statusNorm.includes("inprogress")).length,
    RelasiRslvd:match.filter(x=>x.statusNorm.includes("pending")).length
  };
}

/* ================== GENERATE =================== */
document.getElementById("generateBtn").onclick=async()=>{
  if(!csvData.length)return alert("Upload CSV dulu!");
  const mode=document.getElementById("shiftInput").value.trim().toUpperCase();
  if(mode==="IDX"){sheetData=buildUniqueFromCSV(csvData);}
  const results=sheetData.map(k=>({k,res:rataRata_byName(k.nama)}));
  lastResults=results;renderTable(results);
  document.getElementById("judulLaporan").textContent=`Laporan ${mode}`;
  await saveHistoryEntry({ts:Date.now(),mode,shiftLabel:mode,tanggal:new Date(),results});
};

/* ================== RENDER TABEL =================== */
function renderTable(arr){
  const tb=document.querySelector("#resultTable tbody");tb.innerHTML="";
  arr.forEach((x,i)=>{
    tb.innerHTML+=`
    <tr ${x.res.slaCount>0?'class="table-danger"':''}>
      <td>${i+1}</td>
      <td>${x.k.nama}</td>
      <td>${x.k.shift||'-'}</td>
      <td>${x.res.lastTime}</td>
      <td>${x.res.avg?x.res.avg.toFixed(2):'-'}</td>
      <td>${x.res.count}</td>
      <td>${x.res.slaCount}</td>
      <td>${x.res.inProgressCount}</td>
      <td>${x.res.RelasiRslvd}</td>
    </tr>`;
  });
}

/* ================== BANTUAN =================== */
function buildUniqueFromCSV(rows){
  const map=new Map();
  rows.forEach(r=>{
    const nm=(r.diambilOleh||"").trim();
    if(nm&&!map.has(nm))map.set(nm,{nama:nm,shift:"Index"});
  });
  return Array.from(map.values());
}
</script>

<div id="copyright">© 2025 EDP Fai</div>
</body>
</html>
