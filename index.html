<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background: #f6f7fb;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #resultTable.table thead tr th {
      background-color: #1976d2 !important;
      color: white !important;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      padding: 10px;
      user-select: none;
      vertical-align: middle;
      border-color: #1565c0 !important;
      position: relative;
    }

    #resultTable.table thead tr th:hover {
      background-color: #1565c0 !important;
    }

    #resultTable td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .table-danger {
      background-color: #ffeaea !important;
    }

    th.sort-asc::after {
      content: " ▲";
      font-size: 0.8em;
    }

    th.sort-desc::after {
      content: " ▼";
      font-size: 0.8em;
    }

    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV → Generate Tabel</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-select">
          <option value="">Pilih Shift</option>
          <option value="M">M (Malam)</option>
          <option value="S">S (Siang)</option>
          <option value="P">P (Pagi)</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet</button>
      </div>

      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <h5 id="judulLaporan" class="fw-bold text-start mb-3"></h5>
    <hr>

    <div class="mb-3">
      <label class="form-label">Upload CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th data-key="no">No</th>
            <th data-key="nama">Nama Karyawan</th>
            <th data-key="shift">Shift</th>
            <th data-key="last">LastCO</th>
            <th data-key="indexco">IndexCO</th>
            <th data-key="totalco">TotalCO</th>
            <th data-key="sla">SLA</th>
            <th data-key="progress">InProgress</th>
            <th data-key="resolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <footer>© 2025 EDP Fai</footer>
  </div>

  <script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";
let sheetData = [], csvData = [], lastResults = [], sortState = {key:null,asc:true};

// === SET TANGGAL SEKARANG ===
document.getElementById("tanggalCek").textContent =
  new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });

// === AMBIL DATA GSheet ===
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shiftInput) return alert("Pilih shift dulu!");
  document.getElementById("statusText").textContent = "Mengambil data dari GSheet...";

  try {
    const tanggalLabel = new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });
    document.getElementById("tanggalCek").textContent = tanggalLabel;

    let shifts = [];
    if (shiftInput === "P") shifts = ["P", "P1"]; else shifts = [shiftInput];

    sheetData = [];
    for (const s of shifts) {
      const res = await fetch(`${GAS_URL}?shift=${encodeURIComponent(s)}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Gagal ambil data");
      sheetData = sheetData.concat(data.karyawan || []);
    }

    // hapus duplikat
    sheetData = sheetData.filter((v, i, a) =>
      a.findIndex(t => t.nama.trim().toLowerCase() === v.nama.trim().toLowerCase()) === i
    );

    document.getElementById("statusText").textContent =
      `✅ ${sheetData.length} nama berhasil diambil (Shift ${shiftInput}).`;
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("judulLaporan").textContent =
      `Laporan Index CO Shift ${shiftInput === "P" ? "1" : shiftInput === "S" ? "2" : "3"} — Tanggal ${tanggalLabel}`;

  } catch (err) {
    alert("Gagal ambil data: " + err.message);
    document.getElementById("statusText").textContent = "❌ Gagal mengambil data dari GSheet.";
  }
});

// === BACA CSV ===
document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header:true, delimiter:";", skipEmptyLines:true,
    complete:(res)=>{
      csvData = res.data.map(r=>({
        diambilOleh: r["Diambil Oleh"] || r["diambil oleh"] || "",
        durasi: r["Durasi Komplain"] || "",
        waktuSLA: parseFloat((r["Waktu SLA"]||"0").replace(",",".")||0)*3600,
        status: (r["Status Komplain"]||"").toLowerCase(),
        statusSLA: r["Status SLA"] || "",
        tanggal: r["Tanggal Diambil"] || ""
      }));
      document.getElementById("statusText").textContent = `File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

// === HITUNG DATA ===
function toSeconds(d){
  const m=d.match(/(\d+) d (\d{1,2}):(\d{2}):(\d{2})/);
  if(m) return +m[1]*86400 + +m[2]*3600 + +m[3]*60 + +m[4];
  const t=d.match(/(\d{1,2}):(\d{2}):(\d{2})/);
  return t ? +t[1]*3600 + +t[2]*60 + +t[3] : 0;
}

function hitung(nama){
  const rows = csvData.filter(r => r.diambilOleh &&
    r.diambilOleh.toLowerCase().includes(nama.toLowerCase()));
  if(!rows.length) return {avg:null,count:0,last:"-",sla:0,progress:0,resolved:0};
  const total = rows.reduce((a,b)=>a+(b.waktuSLA?toSeconds(b.durasi)/b.waktuSLA:0),0);
  const last = rows.map(r=>r.tanggal).filter(Boolean).sort().pop()||"-";
  return {
    avg: total/rows.length,
    count: rows.length,
    last: last,
    sla: rows.filter(r=>r.statusSLA && r.statusSLA.toLowerCase().includes("lewat")).length,
    progress: rows.filter(r=>r.status.includes("in progress")).length,
    resolved: rows.filter(r=>r.status.includes("pending")).length
  };
}

// === GENERATE TABEL ===
document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!sheetData.length) return alert("Ambil nama dulu!");
  if(!csvData.length) return alert("Upload CSV dulu!");
  const results = sheetData.map(k=>({k,res:hitung(k.nama)}));
  lastResults = results;
  render(results);
  document.getElementById("statusText").textContent = "✅ Perhitungan selesai.";
});

function render(results){
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  results.forEach((item,i)=>{
    const {k,res}=item;
    const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";
    const tr=document.createElement("tr");
    if(res.sla>0) tr.className="table-danger";
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${k.nama}</td>
      <td>${k.shift}</td>
      <td>${res.last}</td>
      <td>${avg}</td>
      <td>${res.count}</td>
      <td>${res.sla}</td>
      <td>${res.progress}</td>
      <td>${res.resolved}</td>`;
    tbody.appendChild(tr);
  });
}

// === SORTING FITUR ===
document.querySelectorAll("#resultTable thead th").forEach(th=>{
  th.addEventListener("click",()=>{
    const key = th.dataset.key;
    if(!key || !lastResults.length) return;
    document.querySelectorAll("#resultTable thead th").forEach(t=>t.classList.remove("sort-asc","sort-desc"));
    if(sortState.key===key) sortState.asc=!sortState.asc;
    else sortState={key,asc:true};
    th.classList.add(sortState.asc?"sort-asc":"sort-desc");
    const sorted=[...lastResults].sort((a,b)=>{
      const va=getVal(a,key), vb=getVal(b,key);
      if(typeof va==="number" && typeof vb==="number") return sortState.asc?va-vb:vb-va;
      return sortState.asc?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
    });
    render(sorted);
  });
});

function getVal(obj,key){
  switch(key){
    case "no": return 0;
    case "nama": return obj.k.nama;
    case "shift": return obj.k.shift;
    case "last": return obj.res.last;
    case "indexco": return obj.res.avg||0;
    case "totalco": return obj.res.count||0;
    case "sla": return obj.res.sla||0;
    case "progress": return obj.res.progress||0;
    case "resolved": return obj.res.resolved||0;
    default: return "";
  }
}

// === DOWNLOAD JPG ===
document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
  </script>
</body>
</html>
