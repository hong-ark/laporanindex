<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container {
      max-width: 1100px; background: white; border-radius: 10px; padding: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h4 b { color: #1976d2; }
    #laporanJudul {
      text-align: center; font-weight: 700; font-size: 1.2rem;
      color: #0d47a1; margin-top: 15px; margin-bottom: 15px;
    }
    #resultTable.table thead tr th {
      background-color: #1976d2 !important; color: white !important;
      text-align: center; font-weight: 700; cursor: pointer; padding: 10px;
    }
    #resultTable.table thead tr th:hover { background-color: #1565c0 !important; }
    #resultTable td { text-align: center; vertical-align: middle; font-size: 0.95rem; }
    .table-danger { background-color: #ffeaea !important; }
  </style>
</head>

<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Pilih shift → Ambil nama dari GSheet → Upload CSV → Generate Tabel</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-select">
          <option value="">Pilih Shift</option>
          <option value="M">M (Malam)</option>
          <option value="MH1">M H-1 (Malam H-1)</option>
          <option value="S">S (Siang)</option>
          <option value="P">P (Pagi)</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet</button>
      </div>

      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="laporanJudul"></div>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzR5FqFZM_G3XcPFeurBRFMrU-NNqxMW2ZtSCRIpESCpC4Nz7VzdKRmt-Zx1rJXjnRd-g/exec";
let sheetData = [], csvData = [], lastResults = [];
let tanggalCekLabel = "";

document.getElementById("tanggalCek").textContent =
  new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});

document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shiftInput) return alert("Pilih shift dulu!");
  document.getElementById("statusText").textContent = "Mengambil data dari GSheet...";

  try {
    const now = new Date();
    let tanggalLabel;
    if (shiftInput === "MH1") {
      const y = new Date(now);
      y.setDate(now.getDate() - 1);
      tanggalLabel = y.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    } else {
      tanggalLabel = now.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
    }
    tanggalCekLabel = tanggalLabel;
    document.getElementById("tanggalCek").textContent = tanggalLabel;

    let shifts = [shiftInput];
    if (shiftInput === "P") shifts = ["P","P1"];

    sheetData = [];
    for (const s of shifts) {
      const url = `${GAS_URL}?shift=${encodeURIComponent(s)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Gagal ambil data GSheet");
      const list = (data.karyawan || []).map(k => ({
        nama: (k.nama || "").trim(),
        nik: (k.nik || "").trim(),
        shift: (k.shift || "").trim()
      }));
      sheetData = sheetData.concat(list);
    }

    sheetData = sheetData.filter((obj,idx,arr)=>idx===arr.findIndex(t=>t.nama===obj.nama));
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("statusText").textContent =
      `✅ ${sheetData.length} nama berhasil diambil (Shift ${shiftInput}).`;
  } catch(err) {
    console.error(err);
    alert("Gagal mengambil data: " + err.message);
    document.getElementById("statusText").textContent = "❌ Gagal mengambil data dari GSheet.";
  }
});

document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file,{
    header:true, delimiter:";", skipEmptyLines:true,
    complete:(res)=>{
      csvData = res.data;
      document.getElementById("statusText").textContent = `✅ File CSV terbaca (${csvData.length} baris).`;
    }
  });
});

document.getElementById("generateBtn").addEventListener("click",()=>{
  if (!sheetData.length) return alert("Ambil nama dulu!");
  if (!csvData.length) return alert("Upload CSV dulu!");

  // tampilkan judul laporan
  const shiftNow = document.getElementById("shiftInput").value.trim().toUpperCase();
  document.getElementById("laporanJudul").innerHTML =
    `Laporan Index Shift <u>${shiftNow}</u> — <i>${tanggalCekLabel}</i>`;

  // (contoh logika sederhana demo hasil)
  const tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";
  sheetData.forEach((d,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${d.nama}</td><td>${d.shift}</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
    tbody.appendChild(tr);
  });
});
</script>
</body>
</html>

