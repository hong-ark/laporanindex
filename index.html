<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
      font-family: "Segoe UI", sans-serif;
    }
    canvas {
      display: none;
    }
    #resultCard {
      display: none;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 14px;
      color: #666;
    }
    #logStatus {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h3 class="text-center mb-3">üìä Laporan Index Shift (Index Terakhir CO)</h3>

    <div class="mb-3">
      <label class="form-label">Pilih Shift:</label>
      <select class="form-select" id="shiftSelect">
        <option value="">-- Pilih Shift --</option>
        <option value="M">Shift M</option>
        <option value="S">Shift S</option>
        <option value="P">Shift P</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Upload File CSV:</label>
      <input type="file" class="form-control" id="csvFile" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-primary w-100 mb-3">üöÄ Generate Penghitungan</button>
    <div id="logStatus"></div>

    <div id="resultCard" class="card p-3 shadow-sm">
      <h5>Hasil Penghitungan</h5>
      <div id="resultText"></div>
      <button id="downloadJpeg" class="btn btn-success mt-3">üì∏ Download Hasil (.jpg)</button>
    </div>

    <canvas id="canvas"></canvas>

    <footer>¬© 2025 - Sistem Laporan Shift Otomatis</footer>
  </div>

  <script>
    const logUrl = "https://script.google.com/macros/s/AKfycbztSrAD09xjqVc5qVWx95Rr6AojT3CNjCdY20t0MMjkP5vY-CZKacV8UpwL0c7cvGWGCg/exec";

    document.getElementById("generateBtn").addEventListener("click", handleGenerate);

    async function handleGenerate() {
      const shift = document.getElementById("shiftSelect").value.trim();
      const fileInput = document.getElementById("csvFile");
      const file = fileInput.files[0];
      const logStatus = document.getElementById("logStatus");

      if (!shift || !file) {
        alert("‚ö†Ô∏è Silakan pilih shift dan upload file CSV terlebih dahulu!");
        return;
      }

      logStatus.textContent = "‚è≥ Sedang memproses...";
      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvData = e.target.result;
        const lines = csvData.split("\n").filter(l => l.trim() !== "");
        const total = lines.length - 1; // anggap baris pertama header

        // Simulasi hasil penghitungan
        const resultText = `
          <p><strong>Shift:</strong> ${shift}</p>
          <p><strong>File:</strong> ${file.name}</p>
          <p><strong>Total Data:</strong> ${total}</p>
          <p><strong>Waktu:</strong> ${new Date().toLocaleString("id-ID")}</p>
        `;
        document.getElementById("resultText").innerHTML = resultText;
        document.getElementById("resultCard").style.display = "block";

        // Buat JPEG hasil tampilan
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 600;
        canvas.height = 200;
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, 600, 200);
        ctx.fillStyle = "#000";
        ctx.font = "16px Segoe UI";
        ctx.fillText(`Shift: ${shift}`, 20, 40);
        ctx.fillText(`File: ${file.name}`, 20, 70);
        ctx.fillText(`Total: ${total}`, 20, 100);
        ctx.fillText(`Waktu: ${new Date().toLocaleString("id-ID")}`, 20, 130);

        const jpegBase64 = canvas.toDataURL("image/jpeg");

        // Kirim ke GAS
        await kirimLogKeGAS(shift, file.name, jpegBase64);
        logStatus.textContent = "‚úÖ Penghitungan selesai dan log disimpan!";
      };
      reader.readAsText(file);
    }

    async function kirimLogKeGAS(shift, csvName, jpegBase64) {
      try {
        const response = await fetch(logUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            shift: shift,
            csvName: csvName,
            jpegBase64: jpegBase64,
          }),
        });

        const result = await response.json();
        if (result.success) {
          console.log("‚úÖ Log tersimpan di GAS:", result.fileLink);
        } else {
          console.error("‚ùå Gagal simpan log:", result.error);
          document.getElementById("logStatus").textContent = "‚ùå Gagal simpan log: " + result.error;
        }
      } catch (error) {
        console.error("‚ùå Gagal kirim log ke GAS:", error);
        document.getElementById("logStatus").textContent = "‚ùå Gagal kirim log ke GAS: " + error;
      }
    }

    // Tombol download manual JPEG
    document.getElementById("downloadJpeg").addEventListener("click", function() {
      const canvas = document.getElementById("canvas");
      const link = document.createElement("a");
      link.download = `Hasil_${new Date().toISOString()}.jpg`;
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    });
  </script>
</body>
</html>
