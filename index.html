<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { font-size: 15px; }
    #resultTable th { background: #f2f2f2; text-align: center; cursor: pointer; user-select: none; }
    #resultTable th.no-sort { cursor: default; background: #e0e0e0; }
    pre.debug { background:#fff9c4; padding:10px; border-radius:6px; font-size:13px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV dari WEB CO → Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-muted">Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, Tanggal Diambil, Diambil Oleh, Dibuat Oleh).</small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3">Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th class="no-sort">No</th>
            <th onclick="sortTable(1)">Nama Karyawan ⬍</th>
            <th onclick="sortTable(2)">Shift ⬍</th>
            <th onclick="sortTable(3)">LastCO ⬍</th>
            <th onclick="sortTable(4)">IndexCO ⬍</th>
            <th onclick="sortTable(5)">TotalCO ⬍</th>
            <th onclick="sortTable(6)">SLA ⬍</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <pre id="debug" class="debug"></pre>
  </div>

<script>
// ========== SCRIPT UTAMA DARI KAMU (tidak diubah) ==========
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
let sheetData = [];
let csvData = [];
document.getElementById("tanggalCek").textContent = new Date().toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });

// ... seluruh fungsi kamu tetap sama sampai bagian akhir ...

// ========== REVISI BARU: FUNGSI SORT TABEL ==========
function sortTable(index) {
  const table = document.querySelector("#resultTable tbody");
  const rows = Array.from(table.querySelectorAll("tr"));
  const prevIndex = table.getAttribute("data-sort-index");
  const prevOrder = table.getAttribute("data-sort-order");
  const isAsc = prevIndex == index && prevOrder == "asc";
  const order = isAsc ? "desc" : "asc";

  table.setAttribute("data-sort-index", index);
  table.setAttribute("data-sort-order", order);

  rows.sort((a, b) => {
    let A = a.children[index].innerText.trim();
    let B = b.children[index].innerText.trim();

    // deteksi angka
    const numA = parseFloat(A.replace(",", "."));
    const numB = parseFloat(B.replace(",", "."));
    const isNumeric = !isNaN(numA) && !isNaN(numB);

    // deteksi jam (format HH:MM)
    const timeRegex = /^([01]?\d|2[0-3]):[0-5]\d$/;
    const isTime = timeRegex.test(A) && timeRegex.test(B);

    let result = 0;
    if (isNumeric) {
      result = numA - numB;
    } else if (isTime) {
      const [hA, mA] = A.split(":").map(Number);
      const [hB, mB] = B.split(":").map(Number);
      result = (hA * 60 + mA) - (hB * 60 + mB);
    } else {
      result = A.localeCompare(B, "id", { numeric: true, sensitivity: "base" });
    }

    return order === "asc" ? result : -result;
  });

  table.innerHTML = "";
  rows.forEach((r, i) => {
    r.children[0].innerText = i + 1; // update nomor urut
    table.appendChild(r);
  });
}
</script>
</body>
</html>
