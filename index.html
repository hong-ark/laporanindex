<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { font-size: 15px; }
    #resultTable th { background: #f2f2f2; text-align: center; }
    pre.debug { background:#fff9c4; padding:10px; border-radius:6px; font-size:13px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV (pemisah `;`) → Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <select id="shiftInput" class="form-select">
          <option value="M" selected>Shift M (Pagi)</option>
          <option value="P">Shift P (Siang)</option>
          <option value="S">Shift S (Malam)</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV (dipisah dengan ;)</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-muted">Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, Tanggal Diambil, Diambil Oleh, Dibuat Oleh).</small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3">Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Karyawan</th>
            <th>Shift</th>
            <th>LastCO</th>
            <th>IndexCO</th>
            <th>TotalCO</th>
            <th>SLA</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <pre id="debug" class="debug"></pre>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

let sheetData = [];
let csvData = [];

// ====== Tanggal otomatis hari ini ======
const today = new Date();
const tanggalStr = today.toLocaleDateString("id-ID", { day:"numeric", month:"long", year:"numeric" });
const tanggalQuery = today.toISOString().split("T")[0]; // yyyy-mm-dd
document.getElementById("tanggalCek").textContent = tanggalStr;

// ====== Tombol ambil nama dari GSheet ======
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
  document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet...";

  try {
    // Kirim tanggal + shift ke Apps Script
    const res = await fetch(`${GAS_URL}?shift=${shift}&tanggal=${tanggalQuery}`);
    const data = await res.json();

    if (!data.karyawan || !Array.isArray(data.karyawan)) throw new Error("Format data tidak sesuai.");

    // Hilangkan duplikat nama
    const seen = new Set();
    sheetData = data.karyawan.filter(k => {
      const nama = (k.nama || "").toString().trim();
      if (!nama || seen.has(nama)) return false;
      seen.add(nama);
      return true;
    }).map(k => ({
      nama: (k.nama || "").toString().trim(),
      nik: (k.nik || k.NIK || "").toString().replace(/\D/g, "").trim(),
      shift: k.shift || shift
    }));

    document.getElementById("statusText").textContent =
      `Data ditemukan: ${sheetData.length} orang (Shift ${shift}, ${tanggalStr})`;
  } catch (err) {
    document.getElementById("statusText").textContent = "❌ Gagal memanggil API: " + err.message;
  }
});

// ====== Fungsi existing CSV & perhitungan ======
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){ if (!v) return 0; const s = v.toString().trim();
  const m1 = s.match(/(\d+)\s*d\s*(\d{1,2}):(\d{2}):(\d{2})$/i);
  if (m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
  const m2 = s.match(/(\d{1,2}):(\d{2}):(\d{2})$/);
  if (m2) return (+m2[1])*3600 + (+m2[2])*60 + (+m2[3]);
  return 0;
}
function normalizeStatus(s){ return String(s||"").replace(/\u00A0/g,' ').replace(/[_\-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }
function isAcceptedStatus(norm){ return norm.includes("resolved")||norm.includes("closed")||norm.includes("in progress")||norm.includes("pending"); }

function levenshtein(a,b){
  a=a||""; b=b||"";
  const al=a.length, bl=b.length;
  if (!al) return bl; if (!bl) return al;
  const dp=Array.from({length:al+1},()=>new Array(bl+1).fill(0));
  for (let i=0;i<=al;i++) dp[i][0]=i;
  for (let j=0;j<=bl;j++) dp[0][j]=j;
  for (let i=1;i<=al;i++) for (let j=1;j<=bl;j++)
    dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1));
  return dp[al][bl];
}
function similarity(a,b){ a=normalizeName(a); b=normalizeName(b);
  if(!a||!b)return 0; const d=levenshtein(a,b);
  return 1 - d/Math.max(a.length,b.length);
}
function ambilJamDariTanggal(s){ if (!s) return "-"; const m = s.match(/(\d{1,2}):(\d{2})(?::\d{2})?/); return m ? `${m[1].padStart(2,'0')}:${m[2]}` : "-"; }

document.getElementById("csvFile").addEventListener("change",(e)=>{
  const file=e.target.files[0]; if(!file)return;
  Papa.parse(file,{ header:true, delimiter:";", skipEmptyLines:true,
    complete:(res)=>{
      const headerMap={}; (res.meta.fields||[]).forEach(f=>headerMap[normKey(f)]=f);
      const getCol=(r,arr)=>{ for(const c of arr){ const k=headerMap[c]; if(k&&r.hasOwnProperty(k)) return (r[k]||"").toString(); } return ""; };
      csvData=res.data.map(r=>{
        const nikRaw=(getCol(r,['nikpengambil','nik'])).replace(/\D/g,'').trim();
        const durasiRaw=getCol(r,['durasikomplain','durasi']);
        const waktuSlaRaw=getCol(r,['waktusla','waktu sla']);
        const statusRaw=getCol(r,['statuskomplain','status']);
        const statusSlaRaw=getCol(r,['statussla','status sla']);
        const diambilRaw=getCol(r,['diambiloleh','diambil oleh']);
        const dibuatRaw=getCol(r,['dibuatoleh','dibuat oleh']);
        const tglDiambilRaw=getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
        const slaNum=parseFloat((waktuSlaRaw||"").replace(",",".")) || 0;
        return{ nik:nikRaw, durasiRaw, durasiDetik:durasiKeDetik(durasiRaw),
          waktuSlaDetik:slaNum*3600, status:statusRaw, statusNorm:normalizeStatus(statusRaw),
          statusSLA:statusSlaRaw, diambilOleh:diambilRaw, dibuatOleh:dibuatRaw, tanggalDiambil:tglDiambilRaw };
      });
      document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

function computeC(r){ return r.waktuSlaDetik>0 ? r.durasiDetik/r.waktuSlaDetik : 0; }
function rataRata_byNIK(nik){ const rows=csvData.filter(r=>r.nik===nik && isAcceptedStatus(r.statusNorm));
  if(!rows.length)return{avg:null,count:0,lastTime:"-"}; 
  const sum=rows.reduce((a,b)=>a+computeC(b),0);
  const latest=rows.map(r=>r.tanggalDiambil).filter(Boolean).sort().pop();
  const slaCount=rows.filter(r=>r.statusSLA&&r.statusSLA.toLowerCase().includes("lewat")).length;
  return{avg:sum/rows.length,count:rows.length,lastTime:ambilJamDariTanggal(latest),slaCount};
}
function rataRata_byName(nama,thr=0.65){ const matches=[];
  for(const r of csvData){ if(!isAcceptedStatus(r.statusNorm))continue;
    const takenBy=r.diambilOleh; if(takenBy&&similarity(nama,takenBy)>=thr) matches.push(r); }
  if(!matches.length)return{avg:null,count:0,lastTime:"-",slaCount:0};
  const sum=matches.reduce((a,b)=>a+computeC(b),0);
  const latest=matches.map(r=>r.tanggalDiambil).filter(Boolean).sort().pop();
  const slaCount=matches.filter(r=>r.statusSLA&&r.statusSLA.toLowerCase().includes("lewat")).length;
  return{avg:sum/matches.length,count:matches.length,lastTime:ambilJamDariTanggal(latest),slaCount};
}

document.getElementById("generateBtn").addEventListener("click",()=>{
  if(!sheetData.length)return alert("Ambil nama dari GSheet dulu.");
  if(!csvData.length)return alert("Upload file CSV dulu.");
  const results=sheetData.map(k=>{let res=rataRata_byNIK(k.nik); if(!res.count)res=rataRata_byName(k.nama); return{k,res};});
  results.sort((a,b)=> (b.res.avg??-Infinity) - (a.res.avg??-Infinity) );
  const tbody=document.querySelector("#resultTable tbody"); tbody.innerHTML="";
  results.forEach((item,i)=>{
    const {k,res}=item;
    const avg=res.avg!==null?(Math.round(res.avg*100)/100).toFixed(2):"-";
    const ket=res.count>0?res.count:"-";
    const slaCount=res.slaCount||0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${k.nama}</td><td>${k.shift}</td><td>${res.lastTime}</td><td>${avg}</td><td>${ket}</td><td>${slaCount}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("statusText").textContent="✅ Perhitungan selesai.";
});

document.getElementById("downloadBtn").addEventListener("click",async()=>{
  const area=document.querySelector("#resultArea");
  const canvas=await html2canvas(area,{scale:2});
  const link=document.createElement("a");
  link.download="Laporan_Index_Shift.jpg";
  link.href=canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
