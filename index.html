<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background-color:#f7f9fc; font-family: "Segoe UI",sans-serif; }
    .container { margin-top:30px; }
    h1 { font-size:1.5rem; font-weight:600; margin-bottom:20px; text-align:center; }
    #resultTable th { background-color:#007bff; color:#fff; text-align:center; vertical-align:middle; }
    #resultTable td { vertical-align:middle; }
    footer {
      margin-top:50px; text-align:center; font-size:0.9rem; color:#555;
      padding-bottom:20px;
    }
    .loading { color:green; font-weight:500; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Laporan Index Shift (Index terakhir CO)</h1>

    <div class="mb-3">
      <label class="form-label fw-bold">1️⃣ Upload Data CSV (Delimiter ;)</label>
      <input type="file" id="csvFile" accept=".csv" class="form-control"/>
      <div id="statusText" class="mt-2 text-muted small"></div>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">2️⃣ Ambil Daftar NIK & Nama dari Google Sheet</label>
      <button id="loadDataBtn" class="btn btn-primary btn-sm">Ambil Data GSheet</button>
      <div id="loadStatus" class="loading mt-2"></div>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">3️⃣ Hasil Laporan</label>
      <table id="resultTable" class="table table-striped table-bordered table-sm">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>NIK</th>
            <th>Total CO</th>
            <th>Jam Terakhir CO</th>
            <th>SLA (Lewat)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <footer>© 2025 - Monitoring Index CO | PT. Indomarco Prismatama</footer>

  <script>
    let csvData = [];
    let sheetData = [];

    // ==== Fungsi Normalisasi ====
    const normKey = s => (s||"").toString().trim().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9]/g,"");
    const normalizeStatus = s => (s||"").toLowerCase().trim();
    const isAcceptedStatus = s => s.includes("closed") || s.includes("resolved");
    const durasiKeDetik = t => {
      if(!t) return 0;
      const match = t.match(/(\d+)d\s*(\d+):(\d+):(\d+)/);
      if(!match) return 0;
      const [_,d,h,m,sec] = match.map(Number);
      return (((d*24+h)*60+m)*60)+sec;
    };
    const ambilJamDariTanggal = t => {
      if(!t) return "-";
      const d = new Date(t);
      return isNaN(d)? "-": d.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
    };
    const computeC = row => row.durasiDetik || 0;

    // ==== Upload CSV (Delimiter ;) ====
    document.getElementById("csvFile").addEventListener("change",(e)=>{
      const file=e.target.files[0];
      if(!file)return;

      Papa.parse(file,{
        header:true,
        delimiter:";", // tetap pakai ;
        skipEmptyLines:true,
        complete:(res)=>{
          const getCol=(row,keys)=>{
            for(const k in row){
              const nk=normKey(k);
              for(const target of keys){ if(nk===target) return row[k]; }
            }
            return "";
          };

          csvData = res.data.map(r=>{
            const nikRaw=(getCol(r,['nikpengambil','nik_pengambil','nik'])).replace(/\D/g,'').trim();
            const diambilOleh=getCol(r,['diambiloleh','diambil oleh']);
            const durasiRaw=getCol(r,['durasikomplain','durasi']);
            const waktuSlaRaw=getCol(r,['waktusla','waktu sla']);
            const statusRaw=getCol(r,['statuskomplain','status']);
            const statusSlaRaw=getCol(r,['statussla','status sla']);
            const tglDiambilRaw=getCol(r,['tanggaldiambil','tgl diambil','tanggal diambil']);
            const slaNum=parseFloat((waktuSlaRaw||"").replace(",","."))||0;

            return{
              nik: nikRaw,
              diambilOleh,
              durasiRaw,
              durasiDetik: durasiKeDetik(durasiRaw),
              waktuSlaDetik: slaNum*3600,
              status: statusRaw,
              statusNorm: normalizeStatus(statusRaw),
              statusSLA: statusSlaRaw,
              tanggalDiambil: tglDiambilRaw
            };
          });

          console.log("Header CSV terdeteksi:", res.meta.fields);
          console.log("Contoh data CSV:", csvData.slice(0,3));
          document.getElementById("statusText").textContent=`File CSV terbaca: ${csvData.length} baris.`;
        }
      });
    });

    // ==== Ambil Data dari Google Sheet ====
    document.getElementById("loadDataBtn").addEventListener("click",()=>{
      const url="https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
      document.getElementById("loadStatus").textContent="Mengambil data dari Google Sheet...";
      fetch(url)
        .then(r=>r.json())
        .then(data=>{
          sheetData=data;
          document.getElementById("loadStatus").textContent=`Data GSheet: ${data.length} karyawan ditemukan.`;
          renderTable();
        })
        .catch(err=>{
          console.error(err);
          document.getElementById("loadStatus").textContent="Gagal mengambil data GSheet.";
        });
    });

    // ==== Perhitungan (hanya berdasarkan NIK) ====
    function rataRata_byNIK(karyawan) {
      const { nik } = karyawan;
      const matches = csvData.filter(r =>
        r.nik && r.nik === nik && isAcceptedStatus(r.statusNorm)
      );

      if (!matches.length)
        return { avg: null, count: 0, lastTime: "-", slaCount: 0 };

      const sum = matches.reduce((a, b) => a + computeC(b), 0);
      const latest = matches.map(r => r.tanggalDiambil).filter(Boolean).sort().pop();
      const slaCount = matches.filter(r => r.statusSLA && r.statusSLA.toLowerCase().includes("lewat")).length;

      return {
        avg: sum / matches.length,
        count: matches.length,
        lastTime: ambilJamDariTanggal(latest),
        slaCount
      };
    }

    // ==== Render Tabel ====
    function renderTable(){
      if(!sheetData.length || !csvData.length){
        alert("Pastikan CSV & Data Sheet sudah dimuat!");
        return;
      }
      const tbody=document.querySelector("#resultTable tbody");
      tbody.innerHTML="";
      sheetData.forEach((k,idx)=>{
        const r=rataRata_byNIK(k);
        const row=document.createElement("tr");
        row.innerHTML=`
          <td>${idx+1}</td>
          <td>${k.nama}</td>
          <td>${k.nik}</td>
          <td class="text-end">${r.count}</td>
          <td class="text-center">${r.lastTime}</td>
          <td class="text-end">${r.slaCount}</td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
