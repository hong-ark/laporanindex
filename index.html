<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index CO Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .table thead th { cursor: pointer; background: #0d6efd; color: white; }
    footer { text-align: center; font-size: 14px; color: gray; margin-top: 20px; }
  </style>
</head>
<body class="container py-4">

  <h2 class="mb-3 text-primary fw-bold">Laporan Index CO</h2>
  
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <select id="shiftInput" class="form-select">
        <option value="">Pilih Shift</option>
        <option value="P">Shift Pagi (P + P1)</option>
        <option value="S">Shift Siang</option>
        <option value="M">Shift Malam</option>
      </select>
    </div>
    <div class="col-md-3">
      <button id="ambilBtn" class="btn btn-success w-100">Ambil Nama dari GSheet</button>
    </div>
    <div class="col-md-3">
      <input type="file" id="csvInput" accept=".csv" class="form-control" />
    </div>
    <div class="col-md-3">
      <button id="generateBtn" class="btn btn-primary w-100">Generate Tabel</button>
    </div>
  </div>

  <div id="statusText" class="mb-3 text-secondary small"></div>

  <div id="judulLaporan" class="fw-bold fs-5 text-start mb-3"></div>

  <div class="table-responsive" id="resultArea">
    <table id="resultTable" class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>No</th>
          <th>Nama</th>
          <th>Shift</th>
          <th>Last CO</th>
          <th>Index CO</th>
          <th>Total CO</th>
          <th>SLA</th>
          <th>In Progress</th>
          <th>Resolved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="downloadBtn" class="btn btn-outline-secondary mt-3">Download JPG</button>

  <footer>© 2025 EDP Fai</footer>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxcIxYF68Q-mVMIC2ecrNFrgB0gD2gOnHVgV4HEIIP3HZ2LveG2Koqe0qD5gugMLb9d/exec";
    let sheetData = [];
    let csvData = [];

    // === Ambil data dari GSheet ===
    document.getElementById("ambilBtn").addEventListener("click", async () => {
      const shiftInput = document.getElementById("shiftInput").value.trim().toUpperCase();
      if (!shiftInput) return alert("Pilih shift terlebih dahulu.");

      document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet...";
      let shifts = [];

      // Shift P ambil P + P1
      if (shiftInput === "P") {
        shifts = ["P", "P1"];
      } else {
        shifts = [shiftInput];
      }

      sheetData = [];
      for (const s of shifts) {
        const res = await fetch(`${GAS_URL}?shift=${s}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "Gagal ambil data");
        sheetData = sheetData.concat(data.karyawan || []);
      }

      // Hilangkan duplikat nama
      sheetData = sheetData.filter((v, i, a) =>
        a.findIndex(t => t.nama.trim().toLowerCase() === v.nama.trim().toLowerCase()) === i
      );

      document.getElementById("statusText").textContent =
        `Data berhasil diambil: ${sheetData.length} personil (${shifts.join(", ")}).`;

      // Tampilkan tanggal otomatis
      const today = new Date();
      const tgl = today.toLocaleDateString("id-ID", { day: 'numeric', month: 'long', year: 'numeric' });
      const shiftText = shiftInput === "P" ? "Shift 1" :
                        shiftInput === "S" ? "Shift 2" :
                        shiftInput === "M" ? "Shift 3" : shiftInput;
      document.getElementById("judulLaporan").textContent =
        `Laporan Index CO ${shiftText} — Tanggal ${tgl}`;
    });

    // === Upload CSV ===
    document.getElementById("csvInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: res => {
          csvData = res.data.map(r => ({
            nama: (r["Diambil Oleh"] || r["diambil oleh"] || "").trim(),
            nik: (r["NIK Pengambil"] || r["nik pengambil"] || "").trim(),
            status: (r["Status Komplain"] || "").trim(),
            sla: (r["Status SLA"] || "").trim(),
            waktu: (r["Tanggal Diambil"] || "").trim()
          }));
          document.getElementById("statusText").textContent =
            `File CSV terbaca: ${csvData.length} baris.`;
        }
      });
    });

    // === Generate Tabel ===
    document.getElementById("generateBtn").addEventListener("click", () => {
      if (!sheetData.length || !csvData.length)
        return alert("Pastikan data GSheet dan CSV sudah dimuat.");

      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      sheetData.forEach((row, i) => {
        const nama = row.nama;
        const shift = row.shift;
        const match = csvData.filter(c => c.nama.toLowerCase().includes(nama.toLowerCase()));

        const total = match.length;
        const resolved = match.filter(c => c.status.toLowerCase().includes("resolved")).length;
        const inProgress = match.filter(c => c.status.toLowerCase().includes("progress")).length;
        const sla = match.filter(c => c.sla.toLowerCase().includes("terpenuhi")).length;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${nama}</td>
          <td>${shift}</td>
          <td>${match[0]?.waktu || "-"}</td>
          <td>${total ? (resolved / total).toFixed(2) : 0}</td>
          <td>${total}</td>
          <td>${sla}</td>
          <td>${inProgress}</td>
          <td>${resolved}</td>
        `;
        tbody.appendChild(tr);
      });
    });

    // === Download JPG ===
    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const area = document.querySelector("#resultArea");
      const canvas = await html2canvas(area, { scale: 2 });
      const link = document.createElement("a");
      link.download = "Laporan_Index_Shift.jpg";
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    });
  </script>
</body>
</html>
