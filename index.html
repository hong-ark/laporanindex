<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>

  <!-- Favicon (data-URL SVG) -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='32' fill='%23b71c1c'/><text x='50%25' y='50%25' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='28' text-anchor='middle' dominant-baseline='central'>R3</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='32' fill='%23b71c1c'/><text x='50%25' y='50%25' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='28' text-anchor='middle' dominant-baseline='central'>R3</text></svg>">
  <meta name="theme-color" content="#1976d2">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #f6f7fb; padding: 20px; font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 0;
                 box-shadow: 0 2px 6px rgba(0,0,0,0.1); overflow: hidden; margin: 0 auto; }

    .site-top {
      background: linear-gradient(#2286d2, #1976d2);
      color: #fff;
      padding: 12px 18px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .site-top .title { margin:0; font-size:18px; font-weight:700; letter-spacing:0.5px; white-space:nowrap; color:#fff; }

    /* ===== SMOOTH MARQUEE ===== */
    .marquee-wrap { overflow: hidden; flex: 1; position: relative; min-width: 120px; }
    .marquee {
      display: flex;
      width: max-content;
      white-space: nowrap;
      --marquee-duration: 30s; /* durasi default, bisa diubah inline */
      animation: marqueeScroll var(--marquee-duration) linear infinite;
      will-change: transform;
      font-weight:700; font-size:14px; color: #fff;
      align-items: center;
    }
    /* setiap item diberi jarak, tetap gunakan span agar kompatibel */
    .marquee .item { display:inline-block; padding-right: 60px; }
    /* duplikasi konten membuat loop seamless; saat hover -> pause */
    .marquee-wrap:hover .marquee { animation-play-state: paused; }

    @keyframes marqueeScroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } /* bergeser sebanyak setengah lebar (karena isi diduplikasi) */
    }
    /* ===== END MARQUEE ===== */

    .content-area { padding:20px 25px; }
    #judulLaporan { font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 8px; color:#000; }

    /* ===== TABLE STYLING & THIN LINES ===== */
    #resultTable { border-collapse: collapse; border-spacing: 0; }
    /* override agar border selalu tipis terlihat, tidak hilang saat striping */
    #resultTable th, #resultTable td {
      border: 1px solid rgba(0,0,0,0.08) !important; /* garis tipis, lembut */
      vertical-align: middle;
      padding: 8px;
    }
    /* sedikit penyesuaian header supaya tetap tegas */
    #resultTable.table thead tr th {
      background-color: #1976d2 !important; color: #fff !important; text-align: center !important;
      font-weight: 700; cursor: pointer; padding: 10px; user-select: none; vertical-align: middle;
      border-color: rgba(0,0,0,0.12) !important;
    }
    #resultTable.table thead tr th:hover { background-color: #1565c0 !important; }
    #resultArea.is-history thead tr th { background-color: #9e9e9e !important; border-color: #757575 !important; color: #fff !important; }

    /* warna baris per kondisi (tidak diubah) */
    .table-danger td { background-color: #ffeaea !important; color: #000 !important; }
    .table-index-warning td { background-color: #ffcc80 !important; color: #000 !important; }

    .hdr-arrow { font-weight: 700; margin-left: 6px; font-size: 0.9em; }

    #copyright { text-align: center; font-size: 13px; color: #666; margin: 18px 0; padding-bottom: 14px; }

    @media (max-width: 600px){
      .site-top .title { font-size:16px; } .site-top { padding:10px; gap:10px; } .content-area { padding:12px; }
      .marquee { font-size:13px; --marquee-duration: 12s; } #resultTable td { font-size: 0.85rem; }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="site-top" role="banner" aria-label="Header Pengumuman">
    <h1 class="title"></h1>
    <div class="marquee-wrap" aria-hidden="false" role="region" aria-label="Pengumuman penting">
      <!--
         Duplikasi konten (set A + set A lagi) → membuat animasi translateX(-50%) menjadi seamless.
         Untuk ubah kecepatan: set inline style --marquee-duration di elemen .marquee,
         misal: <div class="marquee" style="--marquee-duration:20s">
      -->
      <div class="marquee" id="mainMarquee" aria-live="polite" style="--marquee-duration:30s;">
        <!-- SET A -->
        <span class="item">JANGAN LUPA SELALU CEK INDEX HARI INI &nbsp; • &nbsp;</span>
        <span class="item">HIGHLIGHT MERAH UNTUK SLA &nbsp; • &nbsp;</span>
        <span class="item">HIGHLIGHT KUNING UNTUK INDEX DIATAS 0.35 &nbsp; • &nbsp;</span>
        <span class="item">CHECKLIST HITUNG SLA MULAI ≥ 13:00 HANYA UNTUK MENAMPILkan PENGHITUNGAN PASCA SHIFT MALAM MASUK SIANG, HILANGKAN CHECKLIST UNTUK MENGHITUNG INDEX TOTALNYA &nbsp; • &nbsp;</span>
        <!-- SET A DUPLIKAT (harus sama persis untuk seamless) -->
        <span class="item">JANGAN LUPA SELALU CEK INDEX HARI INI &nbsp; • &nbsp;</span>
        <span class="item">HIGHLIGHT MERAH UNTUK SLA &nbsp; • &nbsp;</span>
        <span class="item">HIGHLIGHT KUNING UNTUK INDEX DIATAS 0.35 &nbsp; • &nbsp;</span>
        <span class="item">CHECKLIST HITUNG SLA MULAI ≥ 13:00 HANYA UNTUK MENAMPILkan PENGHITUNGAN PASCA SHIFT MALAM MASUK SIANG, HILANGKAN CHECKLIST UNTUK MENGHITUNG INDEX TOTALNYA &nbsp; • &nbsp;</span>
      </div>
    </div>
  </div>

  <div class="content-area">
    <p style="margin:0 0 12px 0;color:#333">Pilih shift → Generate Jadwal → Upload CSV → Hitung Index</p>

    <div class="mb-3 row align-items-end">
      <div class="col-auto">
        <label class="form-label">Mode</label><br />
        <select id="shiftInput" class="form-select w-auto d-inline-block">
          <option value="">Pilih Shift</option>
          <option value="IDX">Index hari ini</option>
          <option value="P">P (Pagi)</option>
          <option value="S">S (Siang)</option>
          <option value="M">M (Malam)</option>
          <option value="MH1">M H-1 (Malam H-1)</option>
        </select>
        <div id="modeNote" class="form-text text-muted mt-1"></div>
      </div>

      <div class="col-md-5">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Generate Jadwal</button>
      </div>

      <div class="col-md-4 text-end">
        <label class="form-label">Tanggal dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload CSV</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-1" disabled>Hitung Index</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" id="toggleSiang14" disabled>
      <label class="form-check-label text-muted" for="toggleSiang14" id="labelToggleSiang14">Hitung Siang mulai ≥ 13:00</label>
    </div>

    <div id="judulLaporan" class="mt-2"></div>

    <div id="resultArea" class="mt-2">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortDurasiSLA">DurasiSLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">Relasi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button id="historyBtn" class="btn btn-secondary">History</button>
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>
  </div>

  <div id="copyright">© 2025 EDP Fai</div>
</div>

<!-- Modal History -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">History Laporan (10 terakhir)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body"><div id="historyList" class="list-group"></div></div>
      <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tutup</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ====== KONFIG / STATE ====== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbx4dWdi4tSGqHN3WQ89Za1wyklGj1eLfcNPwqBeLa15aLUKrzjncKvySo07-9GuqxPD0g/exec";
const HISTORY_GAS_URL = "https://script.google.com/macros/s/AKfycbwrXZlIB4nyiQtb-MM79c8rm1rDuoVyEZRxdk4-yTHaM_teOWR-XxC_BK50RsVlmo-P/exec";

let sheetData = [], csvData = [], lastResults = [];
let shiftLabel = "";

let sortAscNama=true, sortAscLastCO=false, sortAscIndexCO=false, sortAscTotalCO=true,
    sortAscSLA=false, sortAscDurasiSLA=false, sortAscInProgress=false, sortAscRelasiResolved=false;

const originalHeaderText = {};

/* ====== INIT ====== */
document.getElementById("tanggalCek").textContent = new Date().toLocaleDateString("id-ID", {day:"numeric",month:"long",year:"numeric"});

/* ====== UTIL ====== */
function normKey(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s]/g,'').trim(); }
function durasiKeDetik(v){
  if(!v) return 0;
  const s = v.toString().trim();
  const m1 = s.match(/(\d+) d (\d{1,2}):(\d{2}):(\d{2})/i);
  if(m1) return (+m1[1])*86400 + (+m1[2])*3600 + (+m1[3])*60 + (+m1[4]);
