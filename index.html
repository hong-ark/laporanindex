<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laporan Index Shift — Generator JPG</title>

  <!-- Simple styling -->
  <style>
    :root{--primary:#0b5ed7;--muted:#666}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:18px; background:#f6f8fb; color:#111}
    .card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:980px;margin:12px auto}
    h1{font-size:20px;margin:0 0 6px}
    p.lead{margin:0 0 14px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], select{padding:8px 10px;border-radius:6px;border:1px solid #e3e7ee;min-width:160px}
    button{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    button.secondary{background:#6c757d}
    .small{font-size:13px;color:var(--muted)}
    #namesList{margin-top:10px}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    table th, table td{border:1px solid #e8e9ee;padding:8px;text-align:left;font-size:13px}
    table th{background:#f4f6fa}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .notice{background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:8px;color:#856404}
    #outputImage{max-width:100%;border-radius:8px;margin-top:12px;display:block}
    .center{display:flex;justify-content:center}
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Laporan Index Shift</h1>
    <p class="lead">Pilih shift, ambil nama-nama dari Google Sheet, upload CSV, lalu generate JPG.</p>

    <div>
      <label for="shiftInput">Shift yang mau dibuat laporan?</label>
      <input id="shiftInput" type="text" maxlength="2" placeholder="Ketik P / S / M" />
      <button id="fetchNamesBtn">Ambil Nama dari Google Sheet</button>
      <span class="small">Tanggal yang dicek: <strong id="dateChecked">-</strong></span>
    </div>

    <div id="namesArea" style="margin-top:12px;display:none">
      <div class="small">Nama-nama pada shift terpilih (diambil dari sheet):</div>
      <ul id="namesList"></ul>
    </div>

    <hr style="margin:16px 0">

    <div>
      <label for="csvFile">Upload file CSV (header: No | Personil | TotalCO | LastCO | Index)</label>
      <input id="csvFile" type="file" accept=".csv" />
      <div class="small" style="margin-top:6px">CSV harus memiliki header "Personil" (atau "Personil" / "Personel" / "Person") sebagai nama.</div>
    </div>

    <div class="controls">
      <button id="generateBtn" class="secondary">Generate Tabel</button>
      <button id="downloadJpgBtn" style="display:none">Download JPG</button>
      <div id="status" class="small"></div>
    </div>

    <div id="reportArea" style="margin-top:14px;display:none">
      <div id="reportCard" style="background:#fff;padding:12px;border-radius:8px">
        <!-- area that will be converted to image -->
        <div id="reportContent">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600">Laporan Index Shift</div>
              <div class="small" id="reportMeta">-</div>
            </div>
          </div>

          <div id="tableContainer" style="margin-top:12px;overflow-x:auto">
            <!-- table injected here -->
          </div>
        </div>
      </div>

      <div class="center">
        <img id="outputImage" src="" alt="Hasil JPG" style="display:none" />
      </div>
    </div>

  </div>

<script>
/*
  IMPORTANT:
  Ganti API_URL ke URL web app dari Google Apps Script (deploy as web app)
*/
const API_URL = "REPLACE_WITH_YOUR_APPS_SCRIPT_WEBAPP_URL"; // <-- ganti di sini

// DOM
const shiftInput = document.getElementById('shiftInput');
const fetchNamesBtn = document.getElementById('fetchNamesBtn');
const dateCheckedEl = document.getElementById('dateChecked');
const namesArea = document.getElementById('namesArea');
const namesList = document.getElementById('namesList');
const csvFile = document.getElementById('csvFile');
const generateBtn = document.getElementById('generateBtn');
const downloadJpgBtn = document.getElementById('downloadJpgBtn');
const statusEl = document.getElementById('status');
const reportArea = document.getElementById('reportArea');
const tableContainer = document.getElementById('tableContainer');
const reportMeta = document.getElementById('reportMeta');
const outputImage = document.getElementById('outputImage');

let fetchedNames = [];
let lastShift = null;
let lastDateChecked = null;
let parsedCSV = null;

// Helpers
function showStatus(txt, isError) {
  statusEl.textContent = txt || "";
  statusEl.style.color = isError ? "crimson" : "#333";
}

function formatDateYMD(d) {
  const y = d.getFullYear();
  const m = ("0" + (d.getMonth()+1)).slice(-2);
  const dd = ("0" + d.getDate()).slice(-2);
  return `${y}-${m}-${dd}`;
}

// Determine date to check: today; if shift = M then date-1
function dateForShift(shift) {
  const today = new Date();
  if ((shift || "").toUpperCase() === "M") {
    const t = new Date(today);
    t.setDate(t.getDate() - 1);
    return t;
  }
  return today;
}

// Fetch names from Apps Script
fetchNamesBtn.addEventListener('click', async () => {
  const shift = (shiftInput.value || "").toUpperCase().trim();
  if (!shift || !["P","S","M"].includes(shift)) {
    showStatus("Isi shift dengan P, S, atau M.", true);
    return;
  }
  if (API_URL === "REPLACE_WITH_YOUR_APPS_SCRIPT_WEBAPP_URL") {
    showStatus("Ganti API_URL di kode dengan URL Apps Script Web App-mu.", true);
    return;
  }
  showStatus("Mengambil data dari Google Sheet...");
  namesList.innerHTML = "";
  namesArea.style.display = "none";
  reportArea.style.display = "none";
  downloadJpgBtn.style.display = "none";
  outputImage.style.display = "none";

  const dt = dateForShift(shift);
  const dtStr = formatDateYMD(dt);
  dateCheckedEl.textContent = dtStr;
  lastShift = shift;
  lastDateChecked = dtStr;

  // call API
  try {
    const url = `${API_URL}?shift=${encodeURIComponent(shift)}&date=${encodeURIComponent(dtStr)}`;
    const res = await fetch(url);
    const json = await res.json();
    if (!json.ok) {
      showStatus("Error: " + (json.error || "Tidak ditemukan data."), true);
      return;
    }
    fetchedNames = json.names || [];
    if (!fetchedNames.length) {
      showStatus("Tidak ada nama untuk shift " + shift + " pada tanggal " + dtStr, true);
      return;
    }
    // display
    namesArea.style.display = "block";
    namesList.innerHTML = fetchedNames.map(n => `<li>${escapeHtml(n)}</li>`).join("");
    showStatus(`Ditemukan ${fetchedNames.length} nama untuk shift ${shift} pada ${dtStr}.`);
  } catch (err) {
    console.error(err);
    showStatus("Gagal memanggil API: " + err.message, true);
  }
});

// Parse uploaded CSV
csvFile.addEventListener('change', (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  showStatus("Membaca CSV...");
  Papa.parse(f, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      parsedCSV = results.data;
      showStatus("CSV dibaca. Baris: " + parsedCSV.length);
      console.log(parsedCSV);
    },
    error: function(err) {
      showStatus("Error membaca CSV: " + err.message, true);
    }
  });
});

// Build table and show
generateBtn.addEventListener('click', () => {
  if (!lastShift || !lastDateChecked || !fetchedNames || !fetchedNames.length) {
    showStatus("Silakan ambil nama shift dulu (klik 'Ambil Nama dari Google Sheet').", true);
    return;
  }
  if (!parsedCSV) {
    showStatus("Silakan upload CSV terlebih dahulu.", true);
    return;
  }

  // Build rows: iterate fetchedNames, for each find csv row by Personil/Person/Personel/Name
  const rows = [];
  const csvLower = parsedCSV.map(r => {
    const normalized = {};
    for (const k in r) {
      normalized[k.trim().toLowerCase()] = r[k];
    }
    return normalized;
  });

  // determine which csv field is the name field: try common possibilities
  const headerKeys = parsedCSV.length ? Object.keys(parsedCSV[0]).map(k=>k.trim().toLowerCase()) : [];
  const nameFieldsCandidates = ['personil','personel','person','personil ','personil\t','name','personil'];
  let nameField = headerKeys.find(h => nameFieldsCandidates.includes(h)) || headerKeys.find(h => h.includes('person')) || headerKeys.find(h => h.includes('name'));

  // Find TotalCO, LastCO, Index fields (case-insensitive)
  let totalField = headerKeys.find(h => /totalco|total_co|total co|total/i.test(h));
  let lastField = headerKeys.find(h => /lastco|last_co|last co|last/i.test(h));
  let indexField = headerKeys.find(h => /index/i.test(h));

  // Safety-fallback: try some exacts
  if (!totalField) totalField = headerKeys.find(h => h === 'totalco' || h === 'total');
  if (!lastField) lastField = headerKeys.find(h => h === 'lastco' || h === 'last');
  if (!indexField) indexField = headerKeys.find(h => h === 'index');

  // Build mapping rows
  fetchedNames.forEach((name, idx) => {
    let matched = null;
    if (nameField) {
      // try find row where name field contains name (case-insensitive)
      const target = (name || "").trim().toLowerCase();
      matched = csvLower.find(r => {
        const val = (r[nameField] || "").toString().trim().toLowerCase();
        return val === target || val.includes(target) || target.includes(val);
      });
    } else {
      // no name field discovered, try any column matching
      const target = (name || "").trim().toLowerCase();
      matched = csvLower.find(r => Object.values(r).some(v => (v||"").toString().trim().toLowerCase() === target));
    }

    const totalVal = matched && totalField ? (matched[totalField] || "") : "";
    const lastVal = matched && lastField ? (matched[lastField] || "") : "";
    const idxVal = matched && indexField ? (matched[indexField] || "") : "";

    rows.push({
      no: idx+1,
      nama: name,
      shift: lastShift,
      totalco: totalVal,
      lastco: lastVal,
      index: idxVal
    });
  });

  // Render table HTML
  const thead = `
    <table id="reportTable">
      <thead>
        <tr>
          <th>No</th><th>Nama Karyawan</th><th>Shift</th><th>TotalCO</th><th>LastCO</th><th>Index</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${escapeHtml(String(r.no))}</td>
            <td>${escapeHtml(r.nama)}</td>
            <td>${escapeHtml(r.shift)}</td>
            <td>${escapeHtml(r.totalco)}</td>
            <td>${escapeHtml(r.lastco)}</td>
            <td>${escapeHtml(r.index)}</td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
  tableContainer.innerHTML = thead;
  reportMeta.textContent = `Shift ${lastShift} — Tanggal dicek: ${lastDateChecked}`;
  reportArea.style.display = "block";
  downloadJpgBtn.style.display = "inline-block";
  showStatus("Tabel siap. Klik 'Download JPG' untuk membuat gambar.");
  outputImage.style.display = "none";
});

// Convert to JPG and download
downloadJpgBtn.addEventListener('click', async () => {
  const el = document.getElementById('reportContent');
  if (!el) { showStatus("Tidak ada konten laporan.", true); return; }
  showStatus("Mengonversi menjadi JPG...");
  try {
    // html2canvas
    const canvas = await html2canvas(el, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff"
    });
    const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
    outputImage.src = dataUrl;
    outputImage.style.display = "block";

    // create download link
    const a = document.createElement('a');
    a.href = dataUrl;
    const filename = `laporan_shift_${lastShift}_${lastDateChecked}.jpg`;
    a.download = filename;
    // trigger download
    a.click();
    showStatus("Selesai. JPG telah diunduh.");
  } catch (err) {
    console.error(err);
    showStatus("Gagal konversi: " + err.message, true);
  }
});

// small util: escape HTML
function escapeHtml(s) {
  if (s === null || s === undefined) return "";
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
</script>
</body>
</html>
