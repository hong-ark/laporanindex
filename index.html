<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h3 class="text-center mb-3 fw-bold">Laporan Index Shift (Index terakhir CO)</h3>
    
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Pilih Shift:</label>
            <select id="shiftSelect" class="form-select">
              <option value="M">Shift M (Hari Ini)</option>
              <option value="M-1">Shift M (H-1)</option>
              <option value="S">Shift S (Hari Ini)</option>
              <option value="P">Shift P (Hari Ini)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Tanggal:</label>
            <input type="date" id="tanggalInput" class="form-control" />
          </div>
          <div class="col-md-4 d-grid d-md-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="ambilDataShift()">üîç Tampilkan Data</button>
          </div>
        </div>
      </div>
    </div>

    <div id="hasilContainer" class="card shadow-sm d-none">
      <div class="card-body">
        <h5 id="judulHasil" class="fw-bold mb-3"></h5>
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-primary">
              <tr>
                <th>No</th>
                <th>Nama</th>
                <th>Shift</th>
              </tr>
            </thead>
            <tbody id="tabelHasil"></tbody>
          </table>
        </div>
        <div class="mt-3 text-end">
          <button class="btn btn-success btn-sm" onclick="exportToCSV()">‚¨áÔ∏è Export CSV</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

    function ambilDataShift() {
      const shiftInputRaw = document.getElementById("shiftSelect").value;
      const tanggalInput = document.getElementById("tanggalInput").value;

      if (!tanggalInput) {
        Swal.fire("Tanggal belum dipilih", "Silakan pilih tanggal terlebih dahulu.", "warning");
        return;
      }

      const today = new Date(tanggalInput);
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      const todayIso = today.toISOString().split("T")[0];
      const yesterdayIso = yesterday.toISOString().split("T")[0];

      // üîπ Build daftar request sesuai logika GAS terbaru
      const fetchRequests = [];

      if (shiftInputRaw === "P") {
        fetchRequests.push({ shift: "P", tanggal: todayIso });
        fetchRequests.push({ shift: "P1", tanggal: todayIso });
      } else if (shiftInputRaw === "M") {
        // üî∏ M = hari ini
        fetchRequests.push({ shift: "M", tanggal: todayIso });
      } else if (shiftInputRaw === "M-1") {
        // üî∏ M-1 = ambil M H-1
        fetchRequests.push({ shift: "M-1", tanggal: yesterdayIso });
      } else {
        // üî∏ S dan lainnya = hari ini
        fetchRequests.push({ shift: shiftInputRaw, tanggal: todayIso });
      }

      // üîπ Proses pengambilan data dari GAS
      document.getElementById("hasilContainer").classList.add("d-none");
      document.getElementById("tabelHasil").innerHTML = "";
      document.getElementById("judulHasil").innerText = "Memuat data...";

      Promise.all(fetchRequests.map(req =>
        fetch(`${GAS_URL}?shift=${encodeURIComponent(req.shift)}&tanggal=${encodeURIComponent(req.tanggal)}`)
          .then(res => res.json())
      ))
      .then(responses => {
        const allData = responses.flatMap(r => r.karyawan || []);
        const total = allData.length;
        const shiftLabel = shiftInputRaw.toUpperCase();
        const tanggalLabel = new Date(tanggalInput).toLocaleDateString("id-ID", { day: '2-digit', month: 'short', year: 'numeric' });

        document.getElementById("judulHasil").innerText = 
          `Data Shift ${shiftLabel} (${tanggalLabel}) ‚Äî Total: ${total}`;

        const tbody = document.getElementById("tabelHasil");
        if (total === 0) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Tidak ada data ditemukan.</td></tr>`;
        } else {
          tbody.innerHTML = allData.map((d, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${d.nama}</td>
              <td>${d.shift}</td>
            </tr>
          `).join("");
        }

        document.getElementById("hasilContainer").classList.remove("d-none");
      })
      .catch(err => {
        console.error(err);
        Swal.fire("Error", "Gagal mengambil data dari server.", "error");
      });
    }

    // üîπ Export ke CSV
    function exportToCSV() {
      const rows = [["No", "Nama", "Shift"]];
      const tableRows = document.querySelectorAll("#tabelHasil tr");
      if (tableRows.length === 0) {
        Swal.fire("Tidak ada data", "Tabel masih kosong.", "info");
        return;
      }

      tableRows.forEach((row, i) => {
        const cols = row.querySelectorAll("td");
        if (cols.length === 3) {
          rows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]);
        }
      });

      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "Laporan_Shift.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
