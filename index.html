<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Index Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f6f7fb; padding: 20px; }
    .container { max-width: 1100px; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { font-size: 15px; }
    #resultTable th { background: #f2f2f2; text-align: center; }
    pre.debug { background:#fff9c4; padding:10px; border-radius:6px; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift → Ambil nama dari GSheet → Upload CSV (pemisah `;`) → Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV (pemisah ;)</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
    </div>

    <button id="generateBtn" class="btn btn-success mb-3">Generate Tabel</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Karyawan</th>
            <th>NIK</th>
            <th>Shift</th>
            <th>Rata-rata Index (C)</th>
            <th>Keterangan</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <pre id="debug" class="debug" style="display:none;"></pre>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

let sheetData = [];
let csvData = [];

// tampilkan tanggal hari ini
document.getElementById("tanggalCek").textContent = new Date().toLocaleDateString("id-ID", {
  day:"numeric", month:"long", year:"numeric"
});

// ambil nama dari GSheet
document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
  const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
  if (!shift) return alert("Masukkan shift (M, P, atau S)");
  document.getElementById("statusText").textContent = "Mengambil data dari Google Sheet...";

  try {
    let shiftsToFetch = [shift];
    if (shift === "P") shiftsToFetch.push("P1");
    let allData = [];
    for (let s of shiftsToFetch) {
      const res = await fetch(`${GAS_URL}?shift=${s}`);
      const data = await res.json();
      if (data.karyawan && Array.isArray(data.karyawan)) allData = allData.concat(data.karyawan);
    }
    const seen = new Set();
    sheetData = allData.filter(k => {
      const nama = (k.nama || "").toString().trim();
      if (!nama) return false;
      if (seen.has(nama)) return false;
      seen.add(nama);
      return true;
    }).map(k => ({
      nama: (k.nama || "").toString().trim(),
      nik: (k.nik || k.NIK || "").toString().replace(/\D/g, "").trim()
    }));
    document.getElementById("statusText").textContent = `Data ditemukan: ${sheetData.length} orang (Shift ${shiftsToFetch.join(" & ")})`;
  } catch (err) {
    document.getElementById("statusText").textContent = "Gagal memanggil API: " + err.message;
  }
});

// normalize status dari script akurat
const normalizeStatus = s => {
  if (!s && s !== 0) return "";
  return String(s).replace(/\u00A0/g, ' ').replace(/[_\-]/g, ' ').replace(/\s+/g, ' ').trim().toLowerCase();
};
const isAcceptedStatus = sNorm => {
  if (!sNorm) return false;
  return sNorm.includes("resolved")
      || sNorm.includes("closed")
      || sNorm.includes("in progress")
      || sNorm.includes("inprogress")
      || sNorm === "progress";
};
const extractHms = v => {
  if (!v) return "00:00:00";
  const s = String(v).trim();
  const m = s.match(/(\d{1,2}:\d{2}:\d{2})$/);
  return m ? m[1] : s;
};

// baca CSV
document.getElementById("csvFile").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) return;
  Papa.parse(f, {
    header: true,
    delimiter: ";",
    skipEmptyLines: true,
    complete: (res) => {
      csvData = res.data;
      document.getElementById("statusText").textContent = `File CSV terbaca: ${csvData.length} baris.`;
    }
  });
});

// hitung rata-rata index per NIK langsung dari CSV (pakai logika akurat)
function hitungRataC(nik) {
  if (!nik) return {avg: null, count: 0};
  const matched = [];
  for (const r of csvData) {
    const nikCsv = (r["NIK Pengambil"] || r["Nik Pengambil"] || r["nik"] || "").toString().trim();
    if (nikCsv !== nik) continue;
    const sn = normalizeStatus(r["Status Komplain"] || r["Status"] || "");
    if (!isAcceptedStatus(sn)) continue;

    const waktuSLA = parseFloat(r["Waktu SLA"] || r["Waktu_SLA"] || 0) || 0;
    const durRaw = r["Durasi Komplain"] || r["Durasi_Komplain"] || "";
    const hms = extractHms(durRaw);
    const [h,m,s] = hms.split(":").map(x => Number(x || 0));
    const A = waktuSLA * 3600;
    const B = (h*3600) + (m*60) + s;
    const C = A > 0 ? (B / A) : 0;
    matched.push(C);
  }
  if (!matched.length) return {avg: null, count: 0};
  const avg = matched.reduce((a,b)=>a+b,0)/matched.length;
  return {avg, count: matched.length};
}

// generate tabel
document.getElementById("generateBtn").addEventListener("click", () => {
  if (!sheetData.length) return alert("Ambil nama dari Google Sheet dulu.");
  if (!csvData.length) return alert("Upload file CSV terlebih dahulu.");

  const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  const debugLines = [];

  sheetData.forEach((k, i) => {
    const res = hitungRataC(k.nik);
    const avgDisplay = res.avg !== null ? res.avg.toFixed(4) : "-";
    const ket = res.count > 0 ? `✅ ${res.count} data` : "❌ Tidak ada";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${k.nama}</td>
      <td>${k.nik || "-"}</td>
      <td>${shift}</td>
      <td>${avgDisplay}</td>
      <td>${ket}</td>
    `;
    tbody.appendChild(tr);
    debugLines.push(`${k.nama} | ${k.nik} -> ${ket} | avg=${avgDisplay}`);
  });

  document.getElementById("statusText").textContent = "✅ Perhitungan selesai.";
  const dbg = document.getElementById("debug");
  dbg.style.display = "block";
  dbg.textContent = debugLines.join("\n");
});

// download JPG
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const area = document.querySelector("#resultArea");
  const canvas = await html2canvas(area, { scale: 2 });
  const link = document.createElement("a");
  link.download = "Laporan_Index_Shift.jpg";
  link.href = canvas.toDataURL("image/jpeg");
  link.click();
});
</script>
</body>
</html>
