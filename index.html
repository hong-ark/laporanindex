<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Index Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background-color: #f8fafc; padding: 40px; }
    .container { max-width: 900px; background: white; padding: 25px 40px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h4 { font-weight: 600; }
    .text-small { font-size: 0.9rem; color: #555; }
    .error-msg { color: #c00; font-weight: 500; margin-top: 10px; }
    #reportTable th, #reportTable td { font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h4 class="mb-3">Laporan Index Shift</h4>
    <p class="text-small">Pilih shift, ambil nama-nama dari Google Sheet, upload CSV, lalu generate JPG.</p>

    <div class="mb-3">
      <label class="form-label">Shift yang mau dibuat laporan?</label>
      <div class="d-flex gap-2">
        <input type="text" id="shiftInput" class="form-control" style="max-width:120px" placeholder="M / S / P" />
        <button id="ambilBtn" class="btn btn-primary">Ambil Nama dari Google Sheet</button>
        <span class="mt-2 ms-2" id="tanggalSpan"></span>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <label class="form-label">Upload file CSV (header: No | Personil | TotalCO | LastCO | Index)</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-small">CSV harus memiliki header “Personil” atau “Person” sebagai kolom nama.</small>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button id="generateBtn" class="btn btn-success">Generate Laporan</button>
      <button id="downloadBtn" class="btn btn-secondary" style="display:none;">Download JPG</button>
      <span id="statusText" class="text-danger ms-2"></span>
    </div>

    <div id="preview"></div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";

    let namaShift = [];
    let tanggalCek = "";
    let shiftNow = "";

    document.getElementById("ambilBtn").addEventListener("click", async () => {
      const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
      const status = document.getElementById("statusText");
      const tanggalSpan = document.getElementById("tanggalSpan");
      status.textContent = "";
      tanggalSpan.textContent = "";
      shiftNow = shift;

      if (!shift) {
        status.textContent = "Isi dulu kode shift (M/S/P)";
        return;
      }

      try {
        const res = await fetch(`${GAS_URL}?shift=${shift}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        namaShift = data.karyawan;
        tanggalCek = new Date(data.tanggal).toLocaleDateString("id-ID");
        tanggalSpan.textContent = `Tanggal yang dicek: ${tanggalCek}`;
        status.textContent = `Data ditemukan: ${data.total} orang.`;
        status.classList.remove("text-danger");
        status.classList.add("text-success");
      } catch (err) {
        status.textContent = `Gagal memanggil API: ${err.message}`;
        status.classList.add("text-danger");
      }
    });

    document.getElementById("generateBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("csvFile");
      const preview = document.getElementById("preview");
      const downloadBtn = document.getElementById("downloadBtn");
      preview.innerHTML = "";
      downloadBtn.style.display = "none";

      if (!fileInput.files.length) {
        alert("Pilih file CSV terlebih dahulu!");
        return;
      }
      if (namaShift.length === 0) {
        alert("Ambil dulu nama shift dari Google Sheet!");
        return;
      }

      // Baca CSV
      const file = fileInput.files[0];
      const text = await file.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0].map(h => h.trim().toLowerCase());
      const dataRows = rows.slice(1);

      // deteksi kolom CSV
      const idxPersonil = headers.findIndex(h => h.includes("person"));
      const idxTotalCO = headers.findIndex(h => h.includes("total"));
      const idxLastCO = headers.findIndex(h => h.includes("last"));
      const idxIndex = headers.findIndex(h => h.includes("index"));

      if (idxPersonil === -1) {
        alert("Kolom nama (Personil) tidak ditemukan di CSV!");
        return;
      }

      // ubah csv jadi objek
      const csvData = dataRows.map(r => ({
        nama: r[idxPersonil]?.trim().toUpperCase(),
        total: r[idxTotalCO] || "",
        last: r[idxLastCO] || "",
        index: r[idxIndex] || ""
      }));

      // gabungkan berdasarkan nama
      const result = [];
      let no = 1;
      for (const item of namaShift) {
        const match = csvData.find(d => d.nama.includes(item.nama.toUpperCase()));
        if (match) {
          result.push({
            no: no++,
            nama: item.nama,
            shift: item.shift,
            total: match.total,
            last: match.last,
            index: match.index
          });
        }
      }

      if (result.length === 0) {
        preview.innerHTML = "<p class='text-danger'>Tidak ada kecocokan nama antara Google Sheet dan CSV.</p>";
        return;
      }

      // buat tabel hasil
      let html = `
        <div id="reportArea">
        <table class="table table-bordered table-sm mt-3" id="reportTable">
          <thead class="table-light">
            <tr><th>No</th><th>Nama Karyawan</th><th>Shift</th><th>TotalCO</th><th>LastCO</th><th>Index</th></tr>
          </thead>
          <tbody>
            ${result.map(r => `<tr>
              <td>${r.no}</td>
              <td>${r.nama}</td>
              <td>${r.shift}</td>
              <td>${r.total}</td>
              <td>${r.last}</td>
              <td>${r.index}</td>
            </tr>`).join("")}
          </tbody>
        </table>
        </div>
      `;
      preview.innerHTML = html;
      downloadBtn.style.display = "inline-block";
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const report = document.getElementById("reportArea");
      html2canvas(report, { scale: 2 }).then(canvas => {
        const link = document.createElement("a");
        link.download = `Laporan_Shift_${shiftNow}_${tanggalCek}.jpg`;
        link.href = canvas.toDataURL("image/jpeg");
        link.click();
      });
    });
  </script>
</body>
</html>
