<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Index Shift</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-light py-4">

  <div class="container">
    <div class="card shadow-sm p-4">
      <h4 class="fw-bold mb-3">Laporan Index Shift</h4>
      <p>Pilih shift, ambil nama-nama dari Google Sheet, upload CSV, lalu generate JPG.</p>

      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-2">
          <label class="form-label">Shift</label>
          <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S">
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label><br>
          <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari Google Sheet</button>
        </div>
        <div class="col-md-6 text-end">
          <p class="mt-3 mb-0">Tanggal yang dicek: <span id="tanggalSekarang"></span></p>
        </div>
      </div>

      <hr>

      <div class="mb-3">
        <label class="form-label">Upload file CSV (header: No | Personil | TotalCO | LastCO | Index)</label>
        <input type="file" id="csvFile" accept=".csv" class="form-control">
        <small class="text-muted">CSV harus memiliki header "Personil" (atau "Person") sebagai kolom nama.</small>
      </div>

      <div class="mb-3">
        <button id="generateBtn" class="btn btn-success">Generate Tabel</button>
        <span id="statusText" class="ms-3 text-muted"></span>
      </div>

      <div id="tabelContainer" class="table-responsive mt-4"></div>

      <div class="mt-3 text-end">
        <button id="downloadBtn" class="btn btn-outline-primary" style="display:none;">Download JPG</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
    let sheetData = [];
    let csvData = [];

    document.getElementById("tanggalSekarang").textContent =
      new Date().toLocaleDateString("id-ID");

    // === Ambil nama dari Google Sheet ===
    document.getElementById("ambilNamaBtn").addEventListener("click", async () => {
      const shift = document.getElementById("shiftInput").value.trim().toUpperCase();
      if (!shift) return alert("Masukkan shift (M, P, atau S)");

      try {
        const url = `${GAS_URL}?shift=${shift}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(data.error);
        sheetData = data.karyawan || [];

        document.getElementById("statusText").textContent =
          `Data ditemukan: ${sheetData.length} orang.`;
      } catch (err) {
        document.getElementById("statusText").textContent = "Gagal memanggil API: " + err.message;
      }
    });

    // === Baca file CSV ===
    document.getElementById("csvFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const text = await file.text();
      csvData = parseCSV(text);
      document.getElementById("statusText").textContent = `File CSV terbaca: ${csvData.length} baris.`;
    });

    // === Parse CSV ===
    function parseCSV(csvText) {
      const rows = csvText.trim().split("\n");
      const headers = rows[0].split("|").map(h => h.trim());
      const data = [];

      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split("|").map(c => c.trim());
        const rowObj = {};
        headers.forEach((h, idx) => rowObj[h] = cols[idx] || "");
        data.push(rowObj);
      }
      return data;
    }

    // === Bersihkan angka / waktu ===
    function cleanValue(value, type) {
      if (!value) return "";
      value = value.toString();

      if (type === "TotalCO") {
        const match = value.match(/\d+/);
        return match ? match[0] : "";
      }

      if (type === "LastCO") {
        const match = value.match(/\d{1,2}:\d{1,2}/);
        return match ? match[0] : "";
      }

      if (type === "Index") {
        const match = value.match(/\d+(\.\d+)?/);
        return match ? match[0] : "";
      }

      return value;
    }

    // === Gabungkan data dari sheet + CSV ===
    function mergeData(sheetData, csvData) {
      const result = [];
      let counter = 1;

      sheetData.forEach((karyawan) => {
        const nama = karyawan.nama.toUpperCase().trim();
        const csvMatch = csvData.find(row =>
          (row.Personil || row.Person || "").toUpperCase().includes(nama)
        );

        if (csvMatch) {
          result.push({
            no: counter++,
            nama: karyawan.nama,
            shift: karyawan.shift,
            TotalCO: cleanValue(csvMatch.TotalCO, "TotalCO"),
            LastCO: cleanValue(csvMatch.LastCO, "LastCO"),
            Index: cleanValue(csvMatch.Index, "Index"),
          });
        }
      });

      return result;
    }

    // === Generate tabel ===
    document.getElementById("generateBtn").addEventListener("click", () => {
      if (!sheetData.length || !csvData.length) {
        return alert("Pastikan data shift dan CSV sudah diambil.");
      }

      const merged = mergeData(sheetData, csvData);
      if (!merged.length) return alert("Tidak ada data yang cocok.");

      let html = `
        <table class="table table-bordered align-middle text-center">
          <thead class="table-secondary">
            <tr>
              <th>No</th>
              <th>Nama Karyawan</th>
              <th>Shift</th>
              <th>TotalCO</th>
              <th>LastCO</th>
              <th>Index</th>
            </tr>
          </thead>
          <tbody>
      `;

      merged.forEach(row => {
        html += `
          <tr>
            <td>${row.no}</td>
            <td>${row.nama}</td>
            <td>${row.shift}</td>
            <td>${row.TotalCO}</td>
            <td>${row.LastCO}</td>
            <td>${row.Index}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById("tabelContainer").innerHTML = html;
      document.getElementById("downloadBtn").style.display = "inline-block";
    });

    // === Download JPG ===
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const target = document.getElementById("tabelContainer");
      html2canvas(target).then(canvas => {
        const link = document.createElement("a");
        link.download = `Laporan_Index_Shift_${new Date().toISOString().slice(0,10)}.jpg`;
        link.href = canvas.toDataURL("image/jpeg");
        link.click();
      });
    });
  </script>
</body>
</html>
