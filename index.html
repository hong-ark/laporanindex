<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Index Shift (Index terakhir CO)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
  body {
    background: #f6f7fb;
    padding: 20px;
  }

  .container {
    max-width: 1100px;
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  table {
    font-size: 15px;
  }

  /* === Header tabel biru muda lembut === */
  #resultTable thead, #logTable thead {
    background-color: #e3f2fd;
  }

  th {
    color: #000;
    text-align: center;
    font-weight: 700;
    padding: 10px 8px;
    border-bottom: 2px solid #bbdefb;
  }

  #resultTable td, #logTable td {
    text-align: center;
    vertical-align: middle;
  }

  .table-danger {
    background-color: #ffeaea !important;
  }

  #logContainer {
    display: none;
    margin-top: 25px;
  }
  </style>
</head>
<body>
  <div class="container">
    <h4><b>Laporan Index Shift</b></h4>
    <p>Input shift â†’ Ambil nama dari GSheet â†’ Upload CSV dari WEB CO â†’ Generate Tabel.</p>

    <div class="mb-3 row">
      <div class="col-md-2">
        <label class="form-label">Shift</label>
        <input type="text" id="shiftInput" class="form-control" maxlength="2" placeholder="M / P / S" />
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label><br />
        <button id="ambilNamaBtn" class="btn btn-primary">Ambil Nama dari GSheet Jadwal</button>
      </div>
      <div class="col-md-6 text-end">
        <label class="form-label">Tanggal yang dicek:</label>
        <p id="tanggalCek"></p>
      </div>
    </div>

    <hr />

    <div class="mb-3">
      <label for="csvFile" class="form-label">Upload file CSV dari WEB CO</label>
      <input type="file" id="csvFile" class="form-control" accept=".csv" />
      <small class="text-muted">
        Pastikan CSV punya header seperti (NIK Pengambil, Durasi Komplain, Waktu SLA, Status Komplain, Status SLA, 
        Tanggal Diambil, Diambil Oleh, Dibuat Oleh).
      </small>
    </div>

    <button id="generateBtn" class="btn btn-success mb-3" disabled>Generate Tabel</button>
    <button id="viewHistoryBtn" class="btn btn-secondary mb-3">View History</button>
    <span id="statusText" class="ms-2 text-muted"></span>

    <!-- === Tabel utama hasil perhitungan === -->
    <div id="resultArea" class="mt-4">
      <table id="resultTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>No</th>
            <th id="sortNama">Nama Karyawan</th>
            <th>Shift</th>
            <th id="sortLastCO">LastCO</th>
            <th id="sortIndexCO">IndexCO</th>
            <th id="sortTotalCO">TotalCO</th>
            <th id="sortSLA">SLA</th>
            <th id="sortInProgress">InProgress</th>
            <th id="sortRelasiResolved">RelasiResolved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button id="downloadBtn" class="btn btn-outline-primary">Download JPG</button>
    </div>

    <!-- === Area Log History === -->
    <div id="logContainer">
      <h5 class="mt-4">ðŸ“˜ Log Perhitungan CO (10 terakhir)</h5>
      <div id="logTable" class="table-responsive"></div>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyoPTlFn5NSBWlDLAT5tvfui9ZKe-l1-INlSmjZ9wWTD3bva3XiP1xp9R2i7K5eTPHqIg/exec";
const GAS_URL_LOG = "https://script.google.com/macros/s/AKfycbx1QvWib1tEsWf7I-X2yb3rhOinSuyMMVP3IzLdt-rbLsJk903JwEWwij6yw7nj-xnE/exec";

let sheetData = [];
let csvData = [];
let lastResults = [];

// === (semua fungsi lama tetap sama, tidak diubah) ===
// === copy dari script kamu mulai dari document.getElementById("tanggalCek").textContent ... ===
// === sampai akhir fungsi downloadBtn ===


// === Tambahan: View Log History ===
document.getElementById("viewHistoryBtn").addEventListener("click", async () => {
  const logContainer = document.getElementById("logContainer");
  const logTable = document.getElementById("logTable");

  logContainer.style.display = "block";
  logTable.innerHTML = "<p class='text-muted'>Memuat data log...</p>";

  try {
    const res = await fetch(GAS_URL_LOG + "?action=getLog");
    const data = await res.json();

    if (!data || !data.length) {
      logTable.innerHTML = "<p class='text-danger'>Belum ada data log.</p>";
      return;
    }

    let html = `
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>User</th>
            <th>Shift</th>
            <th>Jumlah CO</th>
            <th>SLA</th>
            <th>Sumber CSV</th>
            <th>Durasi Proses (detik)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.slice(-10).reverse().forEach(row => {
      html += `
        <tr>
          <td>${row.Timestamp || ""}</td>
          <td>${row.User || ""}</td>
          <td>${row.Shift || ""}</td>
          <td>${row["Jumlah CO"] || ""}</td>
          <td>${row.SLA || ""}</td>
          <td>${row["Sumber CSV"] || ""}</td>
          <td>${row["Durasi Proses (detik)"] || ""}</td>
          <td>${row.Status || ""}</td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    logTable.innerHTML = html;
  } catch (err) {
    logTable.innerHTML = `<p class='text-danger'>Gagal memuat log: ${err.message}</p>`;
  }
});
</script>
</body>
</html>
